{% extends 'swigo/elements/layouts/layout.html' %}
{% block footer %}{% endblock %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<!-- Banni√®re avec logo -->
<section class="banner" style="background-color: white; text-align: center; padding: 12px 0;">
    <img src="{% static 'assets/images/logo-erc-noir1.png' %}" alt="En Route Chef" style="max-height: 90px; width: auto;">
</section>
<!-- Menu sup√©rieur -->
<div class="menu-superieur">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 d-flex justify-content-center">
                <div class="site-filters style-2 clearfix mb-lg-5 mb-md-4">
                    <ul class="filters ligne-categories" data-bs-toggle="buttons">
                        {% for categorie in categories %}
                            <li data-filter=".{{ categorie.nom|slugify }}" class="btn">
                                {% if categorie.nom == 'traiteur' %}
                                    <!-- Lien pour traiteur - ouvre la modal -->
                                    <a href="javascript:void(0);" onclick="openTraiteurModal()">
                                        <span><i class="{{ categorie.icone }}"></i></span>
                                        <span class="label">Service<br>Traiteur</span>
                                    </a>
                                {% else %}
                                    <!-- Lien pour les autres cat√©gories - charge les plats -->
                                    <a href="javascript:void(0);" onclick="loadPlats('{{ categorie.nom|slugify }}')">
                                        <span><i class="{{ categorie.icone }}"></i></span>
                                        <span class="label">
                                            {% if categorie.nom == 'couscous/tajine' %}
                                                Couscous<br>Tajine
                                            {% else %}
                                                {{ categorie.get_nom_display }}
                                            {% endif %}
                                        </span>
                                    </a>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<section class="content-inner">
    <div class="container">
        <div class="row">

            <!-- ü•ò Section des plats + message de bienvenue -->
            <div class="col-lg-8">
                <div class="clearfix" id="lightgallery">

            <!-- Message de bienvenue -->
            <div id="welcome-placeholder" class="text-center py-3" style="color: #666; margin-top: -10px;">
                <img id="welcome-img" class="mb-3 invisible" src="{% static 'assets/images/burger1.jpeg' %}" alt="Bienvenue"
                    style="max-height: 260px; max-width: 100%; border-radius: 12px; box-shadow: 0 0 6px rgba(0,0,0,0.1);">
                
                <h4 id="welcome-title" class="mb-3 invisible" style="font-weight: 500;">
                    Bienvenue chez En Route Chef !
                </h4>
                <p id="welcome-text" class="lead invisible" style="font-size: 16px;">
                    Explorez nos cat√©gories juste au-dessus : <br>
                    <strong>Burgers , Couscous , Tajines, Crousty , Poulet , Desserts</strong>‚Ä¶<br>
                    Choisissez ce qui vous fait envie <br>
                    On s‚Äôoccupe du reste<br>
                    <span class="emoji">üë®‚Äçüç≥</span><span class="emoji">üçΩÔ∏è</span><span class="emoji">üöó</span>
                </p>
            </div>


<!-- üçî Section Burgers avec sous-cat√©gories -->
<div id="burgers-section" style="display: none;">
    <div class="container">
        <div class="row">
        </div>

        <!-- Sous-menu Burgers -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-center flex-wrap gap-3">
                    <button class="btn btn-outline-warning burger-subcategory-btn active" data-type="classique">
                        ‚úÖ Les Classiques ‚Äì Potato Buns
                    </button>
                    <button class="btn btn-outline-warning burger-subcategory-btn" data-type="gourmet">
                        üî• Les Gourmets ‚Äì Buns Boulanger
                    </button>
                </div>
            </div>
        </div>

        <!-- üçü SECTION ACCOMPAGNEMENTS POUR BURGERS -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="text-center mb-3">
                    <h5 class="text-success">üçü Accompagnement au choix</h5>
                    <small class="text-muted">
                        Frites, Riz, Semoule, Salade, Kemia ‚Üí inclus<br>
                        Coleslaw ‚Üí +0,30 ‚Ç¨ ‚Ä¢ Onion Rings ‚Üí +0,50 ‚Ç¨<br>
                        Galette R√∂sti ‚Üí +0,70 ‚Ç¨ ‚Ä¢ Mozzarella Sticks (2 pcs) ‚Üí +0,90 ‚Ç¨
                    </small>
                </div>
            </div>
        </div>

        <!-- Conteneur pour les burgers classiques -->
        <div id="burgers-classique" class="burgers-subcategory">
            <div class="row">
                <div class="col-12">
                    <h4 class="text-center mb-4" style="color: #e67e22;">‚úÖ Les Classiques ‚Äì Potato Buns</h4>
                    <div class="text-center mb-3">
                        <small class="text-muted">
                            <em>Pain moelleux maison √† base de pomme de terre ‚Äì l√©ger, a√©rien, ultra fondant</em>
                        </small>
                    </div>
                </div>
            </div>
            <ul class="row dlab-gallery-listing gallery" id="burgers-classique-list">
                <!-- Chargement AJAX ici -->
            </ul>
        </div>

        <!-- Conteneur pour les burgers gourmets -->
        <div id="burgers-gourmet" class="burgers-subcategory" style="display: none;">
            <div class="row">
                <div class="col-12">
                    <h4 class="text-center mb-4" style="color: #e74c3c;">üî• Les Gourmets ‚Äì Buns Boulanger</h4>
                    <div class="text-center mb-3">
                        <small class="text-muted">
                            <em>Pain boulanger maison ‚Äì plus g√©n√©reux, croustillant et rustique</em>
                        </small>
                    </div>
                </div>
            </div>
            <ul class="row dlab-gallery-listing gallery" id="burgers-gourmet-list">
                <!-- Chargement AJAX ici -->
            </ul>
        </div>
    </div>
</div>    

                    <!-- Liste des plats -->
                    <ul id="masonry" class="row dlab-gallery-listing gallery">
                        <!-- Chargement AJAX ici -->
                    </ul>
                </div>
            </div>

            <!-- üõí Section Panier -->
            <div class="col-lg-4">
                <aside class="side-bar sticky-top float-end d-flex flex-column h-100">
                    <div class="shop-filter style-1 panier-styled flex-grow-1 d-flex flex-column">

                        <!-- En-t√™te Panier -->
                        <div class="d-flex align-items-center p-3 justify-content-between">
                            <h4 class="title m-b30" style="font-weight: 400;">
                                Panier <span class="text-primary" id="cart-count">({{ cart_items|length }})</span>
                            </h4>
                            <div class="text-end">
                                <a href="javascript:void(0);" class="panel-close-btn">‚¨ÖÔ∏è</a>
                                <p class="mb-0 small close-instruction">(cliquez sur la fl√®che)</p>
                            </div>
                        </div>

                        <!-- Articles -->
                        <div id="cart-items" class="flex-grow-1 overflow-auto p-3">
                            {% if cart_items %}
                                <ul class="list-group">
                                    {% for categorie, articles in cart_items_by_categorie.items %}
                                        <li class="list-group-item">
                                            <strong>{{ categorie.nom }}</strong>
                                            <ul class="list-group">
                                                {% for article in articles %}
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        {{ article.plat.nom }} - {{ article.quantite }} x {{ article.prix_total }} ‚Ç¨
                                                        <a href="javascript:void(0);" class="remove-item" data-article-id="{{ article.article_id }}">
                                                            <i class="fa-solid fa-xmark text-danger"></i>
                                                        </a>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p>Votre panier est vide.</p>
                            {% endif %}
                        </div>

                        <!-- Code Promo -->
                        <div class="p-3">
                            <p class="mb-2" style="font-size: 0.85rem; font-weight: 500;">Appliquer un code promo</p>
                            <form id="code-promo-form" method="post" class="mt-1">
                                {% csrf_token %}
                                <div class="input-group input-group-sm" style="max-width: 220px;">
                                    <input type="text" name="code_promo" id="code_promo_input"
                                           class="form-control form-control-sm"
                                           placeholder="Votre code ici..."
                                           style="font-size: 0.75rem; padding: 0.1rem 0.4rem; height: 40px;">
                                    <button type="submit"
                                            class="btn btn-outline-success btn-sm px-2 py-1"
                                            style="height: 40px;"
                                            aria-label="Valider">
                                        <i class="fas fa-check" style="font-size: 0.7rem;"></i>
                                    </button>
                                </div>
                                <div id="code-promo-message" class="mt-1 small text-success" style="display: none;"></div>
                            </form>
                        </div>
                        

                        <!-- Facture -->
                        <div id="invoice-details" class="p-3">
                            <h6 style="font-weight: 300;">D√©tails de la facture</h6>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <p>Sous-total :</p>
                                <p class="text-primary" id="sous-total">0.00 ‚Ç¨</p>
                            </div>
                            <div class="d-flex justify-content-between">
                                <p>Frais de livraison :</p>
                                <p class="text-primary" id="frais-livraison">0.00 ‚Ç¨</p>
                            </div>
                            <div class="d-flex justify-content-between">
                                <p style="font-size: 20px;">Total TTC :</p>
                                <p class="text-primary" id="total-ttc" style="font-size: 20px; font-weight: bold;">0.00 ‚Ç¨</p>
                            </div>
                        </div>

                        <!-- Alerte Panier Minimum -->
                        <div id="panier-warning" class="alert alert-warning mx-3" style="display: none; font-size: 14px;"></div>

                        <!-- Bouton Validation -->
                        <div class="p-3">
                            <button type="button" id="validerCommandeBtn" class="btn btn-outline-success">
                                Valider ma commande
                            </button>
                        </div>

                    </div>
                </aside>

                <!-- Rouvrir le panier - VERSION CORRIG√âE -->
                <a id="open-cart-btn" href="javascript:location.reload();" class="toggle-cart-btn">
                    <i class="fa fa-shopping-cart"></i>
                </a>
            </div>
        </div>
    </div>
</section>




            

<div class="modal fade" id="platModal" tabindex="-1" aria-labelledby="platModalLabel" aria-hidden="true">
    <div class="modal-dialog custom-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="platModalLabel">D√©tails du Plat</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row align-items-center">
                    <!-- Colonne pour l'image : Plus grande -->
                    <div class="col-md-7">
                        <img id="plat-photo" src="" alt="Photo du plat" class="img-fluid rounded" style="max-height: 300px; object-fit: cover;">
                    </div>
                    <!-- Colonne pour la description : Plus petite -->
                    <div class="col-md-5">
                        <h3 id="plat-nom"></h3>
                        <p id="plat-description"></p>
                        <h5 id="plat-prix"></h5>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-success" id="ajouter-au-panier-btn">Continuer vers les options</button>
            </div>
        </div>
    </div>
</div>
            



<!-- Modal pour afficher les options d'un plat -->
<div class="modal fade" id="optionsModal" tabindex="-1" aria-labelledby="optionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="optionsForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="optionsModalLabel" style="font-weight: 500; font-size: 18px;">Composer votre Burger</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>

                <div class="modal-body">
                    <div id="options-container">
                        <!-- Les options seront inject√©es ici via JavaScript avec accord√©ons -->
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-success" id="ajouter-options-panier">
                        Ajouter au panier
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal pour afficher les suggestions -->
<div class="modal fade" id="suggestionModal" tabindex="-1" aria-labelledby="suggestionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="suggestionModalLabel" style="font-weight: 400; font-size: 18px;">
                    Sides et accompagnements
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body" id="suggestion-modal-body">
                <!-- Les suggestions (plats, images, checkbox) seront inject√©es ici via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-success" id="suggestion-modal-valider-btn">Continuer</button>
            </div>
        </div>
    </div>
</div>
  
            
<!-- Modal pour Composer Votre Salade Personnalis√©e -->
<div class="modal fade" id="composeSaladeModal" tabindex="-1" aria-labelledby="composeSaladeLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="composeSaladeLabel">Composez Votre Propre Salade</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="saladeForm">
                    <div class="accordion" id="accordionSaladeOptions">
                        
                        <!-- Base au choix -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingBase">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBase" aria-expanded="false" aria-controls="collapseBase">
                                    1 Base au choix 
                                </button>
                            </h2>
                            <div id="collapseBase" class="accordion-collapse collapse" aria-labelledby="headingBase" data-bs-parent="#accordionSaladeOptions">
                                <div class="accordion-body base-container">
                                    <!-- Les options seront ajout√©es dynamiquement via JavaScript sous forme de cases √† cocher -->
                                </div>
                            </div>
                        </div>

                        <!-- Prot√©ine au choix -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingProteine">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProteine" aria-expanded="false" aria-controls="collapseProteine">
                                    1 Prot√©ine au choix
                                </button>
                            </h2>
                            <div id="collapseProteine" class="accordion-collapse collapse" aria-labelledby="headingProteine" data-bs-parent="#accordionSaladeOptions">
                                <div class="accordion-body proteine-container">
                                    <!-- Les options seront ajout√©es dynamiquement via JavaScript sous forme de cases √† cocher -->
                                </div>
                            </div>
                        </div>

                        <!-- Garniture au choix -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingGarniture">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGarniture" aria-expanded="false" aria-controls="collapseGarniture">
                                    5 Garnitures au choix
                                </button>
                            </h2>
                            <div id="collapseGarniture" class="accordion-collapse collapse" aria-labelledby="headingGarniture" data-bs-parent="#accordionSaladeOptions">
                                <div class="accordion-body garniture-container">
                                    <!-- Les options seront ajout√©es dynamiquement via JavaScript sous forme de cases √† cocher -->
                                </div>
                            </div>
                        </div>

                        <!-- Topping au choix -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTopping">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTopping" aria-expanded="false" aria-controls="collapseTopping">
                                    2 Topping au choix
                                </button>
                            </h2>
                            <div id="collapseTopping" class="accordion-collapse collapse" aria-labelledby="headingTopping" data-bs-parent="#accordionSaladeOptions">
                                <div class="accordion-body topping-container">
                                    <!-- Les options seront ajout√©es dynamiquement via JavaScript sous forme de cases √† cocher -->
                                </div>
                            </div>
                        </div>

                        <!-- Sauce au choix -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingSauce">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSauce" aria-expanded="false" aria-controls="collapseSauce">
                                    1 Sauce au choix
                                </button>
                            </h2>
                            <div id="collapseSauce" class="accordion-collapse collapse" aria-labelledby="headingSauce" data-bs-parent="#accordionSaladeOptions">
                                <div class="accordion-body sauce-container">
                                    <!-- Les options seront ajout√©es dynamiquement via JavaScript sous forme de cases √† cocher -->
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-success" id="validerSaladeBtn">Ajouter au Panier</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour Composer Votre Couscous Personnalis√© -->
<div class="modal fade" id="composeCouscousModal" tabindex="-1" aria-labelledby="composeCouscousLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="couscousForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="composeCouscousLabel">Composer votre Couscous</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>

                <div class="modal-body">
                    <!-- Formule au choix -->
                    <div class="mb-4">
                        <label class="form-label"><strong>Formule</strong></label>

                        <!-- Ligne V√©g√©tarien -->
                        <div class="formule-couscous-item d-flex align-items-center p-2 mb-2" style="cursor: pointer;">
                            <input class="form-check-input me-3" type="radio" name="formule" value="Couscous V√©g√©tarien" id="formule-vegetarien" required>
                            <label class="form-check-label flex-grow-1" for="formule-vegetarien" style="cursor: pointer;">
                                Couscous V√©g√©tarien <strong class="text-primary ms-2">12,90 ‚Ç¨</strong>
                            </label>
                        </div>

                        <!-- Ligne Tradition -->
                        <div class="formule-couscous-item d-flex align-items-center p-2 mb-2" style="cursor: pointer;">
                            <input class="form-check-input me-3" type="radio" name="formule" value="Couscous Tradition" id="formule-tradition" required>
                            <label class="form-check-label flex-grow-1" for="formule-tradition" style="cursor: pointer;">
                                Couscous Tradition (1 viande) <strong class="text-primary ms-2">15,40 ‚Ç¨</strong>
                            </label>
                        </div>

                        <!-- Ligne Gourmand -->
                        <div class="formule-couscous-item d-flex align-items-center p-2 mb-2" style="cursor: pointer;">
                            <input class="form-check-input me-3" type="radio" name="formule" value="Couscous Gourmand" id="formule-gourmand" required>
                            <label class="form-check-label flex-grow-1" for="formule-gourmand" style="cursor: pointer;">
                                Couscous Gourmand (2 viandes) <strong class="text-primary ms-2">17,90 ‚Ç¨</strong>
                            </label>
                        </div>

                        <!-- Ligne 2 Palmiers -->
                        <div class="formule-couscous-item d-flex align-items-center p-2 mb-2" style="cursor: pointer;">
                            <input class="form-check-input me-3" type="radio" name="formule" value="Couscous 2 Palmiers" id="formule-palmiers" required>
                            <label class="form-check-label flex-grow-1" for="formule-palmiers" style="cursor: pointer;">
                                Couscous 2 Palmiers (3 viandes) <strong class="text-primary ms-2">19,90 ‚Ç¨</strong>
                            </label>
                        </div>

                        <!-- Ligne Royal -->
                        <div class="formule-couscous-item d-flex align-items-center p-2 mb-2" style="cursor: pointer;">
                            <input class="form-check-input me-3" type="radio" name="formule" value="Couscous Royal" id="formule-royal" required>
                            <label class="form-check-label flex-grow-1" for="formule-royal" style="cursor: pointer;">
                                Couscous Royal (4 viandes) <strong class="text-primary ms-2">21,90 ‚Ç¨</strong>
                            </label>
                        </div>
                    </div>

                    <!-- Choix des viandes -->
                    <div class="mb-3" id="bloc-choix-viandes">
                        <label class="form-label"><strong>Choisissez vos viandes</strong></label>
                        <div class="row" id="viande-options">
                            <!-- Options inject√©es dynamiquement -->
                        </div>
                    </div>

                    <!-- Choix des accompagnements -->
                    <div class="mb-3" id="bloc-accompagnements">
                        <label class="form-label"><strong>Accompagnements (inclus dans le prix)</strong></label>
                        <div class="row" id="accompagnement-options">
                            <!-- Options inject√©es dynamiquement -->
                        </div>
                    </div>

                    <!-- Option XL -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="option_xl" name="option_xl">
                            <label class="form-check-label" for="option_xl">üçΩÔ∏è Option XL : +2,00</label><br>
                            <small style="font-style: italic; font-weight: normal; color: #555;">+ de semoule, l√©gumes et bouillon</small>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-outline-success" id="validerCouscousBtn">
                        Ajouter au panier
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>




<!-- Modal pour Composer Votre Crousty Personnalis√© -->
<div class="modal fade" id="composeCroustyModal" tabindex="-1" aria-labelledby="composeCroustyLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="composeCroustyLabel">Composez Votre Crousty</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <form id="croustyForm">
                    <div class="accordion" id="accordionCroustyOptions">
                        
                        <!-- Fromage au choix -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingFromage">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFromage" aria-expanded="false" aria-controls="collapseFromage">
                                    üßÄ Fromage au choix
                                </button>
                            </h2>
                            <div id="collapseFromage" class="accordion-collapse collapse" aria-labelledby="headingFromage" data-bs-parent="#accordionCroustyOptions">
                                <div class="accordion-body fromage-container">
                                    <!-- Les options fromage seront inject√©es ici -->
                                </div>
                            </div>
                        </div>

                        <!-- Sauce Rouge Signature (incluse) -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingSauceRouge">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSauceRouge" aria-expanded="false" aria-controls="collapseSauceRouge">
                                    üî¥ Sauce Rouge Signature (incluse)
                                </button>
                            </h2>
                            <div id="collapseSauceRouge" class="accordion-collapse collapse" aria-labelledby="headingSauceRouge" data-bs-parent="#accordionCroustyOptions">
                                <div class="accordion-body sauce-rouge-container">
                                    <!-- La sauce rouge sera inject√©e ici -->
                                </div>
                            </div>
                        </div>

                        <!-- Sauce ERC au choix -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingSauceErc">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSauceErc" aria-expanded="false" aria-controls="collapseSauceErc">
                                    üçØ Sauce ERC au choix
                                </button>
                            </h2>
                            <div id="collapseSauceErc" class="accordion-collapse collapse" aria-labelledby="headingSauceErc" data-bs-parent="#accordionCroustyOptions">
                                <div class="accordion-body sauce-erc-container">
                                    <!-- Les sauces ERC seront inject√©es ici -->
                                </div>
                            </div>
                        </div>

                        <!-- Prot√©ine V√©g√©tarienne (uniquement pour Crousty #2) -->
                        <div class="accordion-item" id="proteineVeggieSection" style="display: none;">
                            <h2 class="accordion-header" id="headingProteineVeggie">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProteineVeggie" aria-expanded="false" aria-controls="collapseProteineVeggie">
                                    üå± Prot√©ine V√©g√©tarienne au choix
                                </button>
                            </h2>
                            <div id="collapseProteineVeggie" class="accordion-collapse collapse" aria-labelledby="headingProteineVeggie" data-bs-parent="#accordionCroustyOptions">
                                <div class="accordion-body proteine-veggie-container">
                                    <!-- Les prot√©ines veggie seront inject√©es ici -->
                                </div>
                            </div>
                        </div>

                        <!-- Suppl√©ments -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingSupplement">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSupplement" aria-expanded="false" aria-controls="collapseSupplement">
                                    ‚ûï Suppl√©ments (optionnels)
                                </button>
                            </h2>
                            <div id="collapseSupplement" class="accordion-collapse collapse" aria-labelledby="headingSupplement" data-bs-parent="#accordionCroustyOptions">
                                <div class="accordion-body supplement-container">
                                    <!-- Les suppl√©ments seront inject√©s ici -->
                                </div>
                            </div>
                        </div>

                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-success" id="validerCroustyBtn">Ajouter au Panier</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour Composer Votre Poulet Personnalis√© -->
<div class="modal fade" id="composePouletModal" tabindex="-1" aria-labelledby="composePouletLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="composePouletLabel">Personnaliser Votre Poulet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <form id="pouletForm">
                    <div class="accordion" id="accordionPouletOptions">
                        
                        <!-- Assaisonnements -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingAssaisonnementPoulet">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAssaisonnementPoulet" aria-expanded="false" aria-controls="collapseAssaisonnementPoulet">
                                    üéØ Assaisonnements (Doux ou Piquant)
                                </button>
                            </h2>
                            <div id="collapseAssaisonnementPoulet" class="accordion-collapse collapse" aria-labelledby="headingAssaisonnementPoulet" data-bs-parent="#accordionPouletOptions">
                                <div class="accordion-body assaisonnement-poulet-container">
                                    <!-- Les options assaisonnements seront inject√©es ici -->
                                </div>
                            </div>
                        </div>

                        <!-- Accompagnements -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingAccompagnementPoulet">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAccompagnementPoulet" aria-expanded="false" aria-controls="collapseAccompagnementPoulet">
                                    üçü Accompagnements
                                </button>
                            </h2>
                            <div id="collapseAccompagnementPoulet" class="accordion-collapse collapse" aria-labelledby="headingAccompagnementPoulet" data-bs-parent="#accordionPouletOptions">
                                <div class="accordion-body accompagnement-poulet-container">
                                    <!-- Les accompagnements seront inject√©s ici -->
                                </div>
                            </div>
                        </div>

                        <!-- Sauce au choix -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingSaucePoulet">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSaucePoulet" aria-expanded="false" aria-controls="collapseSaucePoulet">
                                    üçØ Sauce au choix
                                </button>
                            </h2>
                            <div id="collapseSaucePoulet" class="accordion-collapse collapse" aria-labelledby="headingSaucePoulet" data-bs-parent="#accordionPouletOptions">
                                <div class="accordion-body sauce-poulet-container">
                                    <!-- Les options sauces seront inject√©es ici -->
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-success" id="validerPouletBtn">Ajouter au Panier</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Service Traiteur -->
<!-- Modal Service Traiteur -->
<div class="modal fade" id="traiteurModal" tabindex="-1" aria-labelledby="traiteurModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="traiteurModalLabel">üéâ Service Traiteur En Route Chef</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <h4 class="text-warning">Votre √©v√©nement sur mesure</h4>
                    <p class="lead">Nous vous proposons nos services pour des repas ou r√©ceptions de <strong>6 √† 200 personnes</strong></p>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-4">
                            <h6 class="text-success">üéØ Nos sp√©cialit√©s :</h6>
                            <ul class="list-unstyled">
                                <li>‚Ä¢ Couscous traditionnel et royal</li>
                                <li>‚Ä¢ Tajines marocains authentiques</li>
                                <li>‚Ä¢ Burgers gourmets</li>
                                <li>‚Ä¢ Verrines cr√©atives</li>
                                <li>‚Ä¢ M√©choui entier</li>
                                <li>‚Ä¢ Poulet r√¥ti et marin√©</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-4">
                            <h6 class="text-success">üìã √âv√©nements :</h6>
                            <ul class="list-unstyled">
                                <li>‚Ä¢ Mariages & anniversaires</li>
                                <li>‚Ä¢ √âv√©nements d'entreprise</li>
                                <li>‚Ä¢ Cocktails & vernissages</li>
                                <li>‚Ä¢ F√™tes de famille</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-3">
                    <h6 class="alert-heading">üí° Un projet ? Une question ?</h6>
                    <p class="mb-2">Contactez-nous pour un devis personnalis√© selon vos besoins</p>
                    <strong>üìû T√©l√©phone : 06 95 59 98 59</strong><br>
                    <strong>üìß Email : sasules2palmiers@gmail.com</strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fermer</button>
                <a href="tel:0123456789" class="btn btn-success">
                    <i class="fas fa-phone me-2"></i>Appeler maintenant
                </a>
            </div>
        </div>
    </div>
</div>


<!-- ‚úÖ MODALE POUR LES MENUS -->
<div class="modal fade" id="menu-modal" tabindex="-1" aria-labelledby="menu-modal-title" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
  
        <div class="modal-header">
          <h5 class="modal-title" id="menu-modal-title">Menu</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
  
        <div class="modal-body" id="menu-modal-body">
          <!-- les choix dynamiques viendront ici via JS -->
        </div>
  
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="validerMenu()">Ajouter au panier</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        </div>
  
      </div>
    </div>
  </div>
  




           
<style>
    /* Titre de la modal */
    .modal-title {
        font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
        font-size: 20px;
        font-weight: 400;
        color: #333;
        letter-spacing: 0.3px;
    }
    
    /* Modal custom¬†: taille, marges, centrage */
    .modal-custom-size {
        width: 90vw;
        max-width: 900px;
        height: 90vh;
        max-height: 600px;
        margin: 40px auto 48px auto;   /* espace haut/bas (48px en bas, 40px en haut) */
        display: flex;
        align-items: center;
    }
    
    /* Responsive¬†: sur mobile, on augmente la taille */
    @media (max-width: 768px) {
        .modal-custom-size {
            width: 95vw;
            height: 95vh;
            margin: 20px auto 20px auto;
        }
    }
    
    /* Structure interne¬†: header et footer fixes, body scrollable */
    .modal-custom-size .modal-content {
        display: flex;
        flex-direction: column;
        height: 90vh;
        max-height: 90vh;
        box-shadow: 0 8px 32px rgba(80,80,80,0.13);
        border-radius: 18px;
    }
    
    /* Responsive¬†: adapte la hauteur sur mobile */
    @media (max-width: 768px) {
        .modal-custom-size .modal-content {
            height: 95vh;
            max-height: 95vh;
        }
    }
    
    /* Header et footer toujours visibles */
    .modal-custom-size .modal-header,
    .modal-custom-size .modal-footer {
        flex-shrink: 0;
        background: #fff;
    }
    
    /* Le c≈ìur de la modal¬†: scroll interne limit√© pour toujours montrer le d√©but du champ suivant */
    .modal-custom-size .modal-body {
        flex: 1 1 auto;
        overflow-y: auto;
        max-height: calc(90vh - 190px); /* ajuste 190px si besoin pour couper le champ suivant */
        padding-bottom: 12px;
    }
    
    /* Mobile¬†: adapte le max-height du scroll */
    @media (max-width: 768px) {
        .modal-custom-size .modal-body {
            max-height: calc(95vh - 190px);
        }
    }
    
    /* Optionnel¬†: visuel */
    .modal-custom-size .modal-footer {
        border-top: 1px solid #f0f0f0;
        background: #fff;
    }
    
    /* Ne pas toucher au pointer overlay */
    #pointer-dot, #pointer-ring {
        display: none !important;
    }
    
    /* Panier¬†: scroll dans le side-bar, rien √† voir avec la modal commande */
    #cart-items {
        max-height: 60vh;
        min-height: 180px;
        overflow-y: auto;
    }
    @media (orientation: landscape) {
        #cart-items {
            max-height: 80vh;
        }
    }
    </style>
    
  
  
  <!-- Modal pour renseigner les informations de commande -->
  <div class="modal fade" id="validerCommandeModal" tabindex="-1" aria-labelledby="validerCommandeLabel" aria-hidden="true">
    <div class="modal-dialog modal-custom-size">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="validerCommandeLabel">Vos informations (faites d√©filer pour plus d'options)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <form id="clientInfoForm">
            <div class="mb-3">
                <label for="nom" class="form-label">Nom</label>
                <input type="text" class="form-control" id="nom" name="nom" required>
              </div>
              <div class="mb-3">
                <label for="prenom" class="form-label">Pr√©nom</label>
                <input type="text" class="form-control" id="prenom" name="prenom" required>
              </div>
              <div class="mb-3">
                <label for="societe" class="form-label">Soci√©t√© <span style="font-weight: normal; color: #888; font-size: 13px;">(facultatif)</span></label>
                <input type="text" class="form-control" id="societe" name="societe">
              </div>
              <div class="mb-3">
                <label for="numero_telephone" class="form-label">Num√©ro de t√©l√©phone</label>
                <input type="text" class="form-control" id="numero_telephone" name="numero_telephone" required>
              </div>
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control" id="email" name="email" required>
            </div>
  
            <div class="mb-3">
              <label for="adresse_livraison" class="form-label">Adresse de livraison</label>
              <input type="text" class="form-control" id="adresse_livraison" name="adresse_livraison" readonly>
            </div>
  
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="differentBillingAddress" name="differentBillingAddress">
                <label class="form-check-label" for="differentBillingAddress">
                  Adresse de facturation diff√©rente
                </label>
            </div>

            <div class="form-check mb-3 ms-3">
                <input class="form-check-input" type="checkbox" id="factureSansDetail" name="factureSansDetail">
                <label class="form-check-label" for="factureSansDetail">
                  Facture sans d√©tail <span class="text-muted" style="font-size:13px"></span>
                </label>
            </div>


            <div class="mb-3" id="adresseFacturationContainer" style="display: none;">
              <label for="adresse_facturation" class="form-label">Adresse de facturation (facultatif)</label>
              <input type="text" class="form-control" id="adresse_facturation" name="adresse_facturation">
            </div>
  
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="enableMessages" name="enableMessages">
              <label class="form-check-label" for="enableMessages">Laisser un message pour le chef ou le livreur</label>
            </div>
  
            <div class="mb-3" id="messageChefContainer" style="display: none;">
              <label for="message_chef" class="form-label">Message pour notre chef (facultatif)</label>
              <textarea class="form-control" id="message_chef" name="message_chef" rows="3" placeholder="Laissez un message pour le chef..."></textarea>
            </div>
  
            <div class="mb-3" id="messageLivreurContainer" style="display: none;">
              <label for="message_livreur" class="form-label">Message pour notre livreur (facultatif)</label>
              <textarea class="form-control" id="message_livreur" name="message_livreur" rows="3" placeholder="Laissez un message pour le livreur..."></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label">Consentements</label>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="consent_cookies" checked required>
                  <label class="form-check-label" for="consent_cookies">
                    J'accepte l'utilisation des cookies.
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="consent_sms" checked>
                  <label class="form-check-label" for="consent_sms">
                    Je consens √† recevoir des SMS.
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="consent_email" checked>
                  <label class="form-check-label" for="consent_email">
                    Je consens √† recevoir des emails.
                  </label>
                </div>
              </div>
              
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-success" id="submitClientInfo">Valider et payer</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal choix moyen de paiement -->
  <div class="modal fade" id="choixPaiementModal" tabindex="-1" aria-labelledby="choixPaiementLabel" aria-hidden="true">
    <div class="modal-dialog modal-custom-size">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="choixPaiementLabel">Choisissez votre moyen de paiement:</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <form id="formChoixPaiement">
            <div id="paiementOptions">
              <!-- Les options de paiement seront ins√©r√©es ici dynamiquement -->
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-success" id="confirmerPaiementBtn">Confirmer</button>
        </div>
      </div>
    </div>
  </div>
  
  <div id="infoOverlay" class="info-overlay" style="display: none;">
    <div class="info-modal">
      <div class="info-modal-content">
        <span class="info-close" id="closeInfoModal">&times;</span>
        <div id="infoModalText"></div>
      </div>
    </div>
  </div>
  
  {% endblock %}



{% block additional_js %}
<!-- Charger jQuery -->
<script src="{% static 'swigo/js/jquery.min.js' %}"></script>

<!-- Charger Isotope apr√®s jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js"></script>

<!-- Charger TouchSpin apr√®s jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-touchspin/4.3.0/jquery.bootstrap-touchspin.min.js"></script>

<!-- Charger lightGallery et ses plugins -->
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.1.3/lightgallery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.1.3/plugins/thumbnail/lg-thumbnail.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.1.3/plugins/zoom/lg-zoom.min.js"></script>

<!-- Charger imagesLoaded apr√®s jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js"></script>

<!-- Charger Stripe.js avant les scripts personnalis√©s -->
<script src="https://js.stripe.com/v3/"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/masonry/4.2.2/masonry.pkgd.min.js"></script>


<!-- Charger custom.min.js en dernier -->
<script src="{% static 'swigo/js/custom.min.js' %}"></script>




<!-- Assurez-vous que ce script est plac√© juste avant la balise </body> -->
<script>
    // 1. Fonction getCookie (d√©finie globalement)
    window.getCookie = function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };

// Fonction pour √©chapper les caract√®res HTML dans les noms/descriptions
function htmlEscape(str) {
    return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// Fonction utilitaire pour √©chapper le HTML
function htmlEscape(str) {
    return str?.replace(/&/g, "&amp;")
               .replace(/</g, "&lt;")
               .replace(/>/g, "&gt;")
               .replace(/"/g, "&quot;")
               .replace(/'/g, "&#039;") || '';
}

// Version avec d√©tection par cat√©gorie
function getTriIndex(item) {
    const cat = (item.categorie_nom || '').toLowerCase();
    const nom = (item.plat_nom || '').toLowerCase();

    // Ordre : Plats (0) ‚Üí Sides (1) ‚Üí Boissons (2) ‚Üí Desserts (3)
    
    // Sides/accompagnements
    if (cat.includes('side') || cat.includes('accompagnement') || 
        nom.includes('frites') || nom.includes('potato') || nom.includes('wedges') ||
        nom.includes('onion') || nom.includes('nuggets')) {
        return 1;
    }
    
    // Boissons
    if (cat.includes('boisson') || cat.includes('drink') ||
        nom.includes('soda') || nom.includes('coca') || nom.includes('pepsi') ||
        nom.includes('eau') || nom.includes('jus') || nom.includes('icetea') ||
        nom.includes('orangina')) {
        return 2;
    }
    
    // Desserts
    if (cat.includes('dessert') || cat.includes('sweet') ||
        nom.includes('glace') || nom.includes('cookie') || nom.includes('brownie') ||
        nom.includes('mousse') || nom.includes('fondant') || nom.includes('cheesecake') ||
        nom.includes('tiramisu')) {
        return 3;
    }
    
    return 0; // Plats principaux (tous les autres)
}

// Fonction globale
window.loadPlats = function (categorie_nom) {
    console.log(`üîç Chargement AJAX pour : ${categorie_nom}`);

    // ‚úÖ VIDER COMPL√àTEMENT avant tout nouveau chargement
    const platsContainer = document.getElementById('masonry');
    if (platsContainer) {
        platsContainer.innerHTML = ''; // VIDER
        platsContainer.style.display = '';
    }

    // Masquer la section burgers si visible
    const burgersSection = document.getElementById('burgers-section');
    if (burgersSection) {
        burgersSection.style.display = 'none';
    }

    // Masquer le message de bienvenue
    const welcomePlaceholder = document.getElementById('welcome-placeholder');
    if (welcomePlaceholder) {
        welcomePlaceholder.style.display = 'none';
    }

    // Cas sp√©cial pour les burgers
    if (categorie_nom === 'burger') {
        loadBurgers();
        return;
    }

    const url = (categorie_nom === 'menu')
        ? '/menus_par_categorie_ajax/'
        : `/plats_par_categorie_ajax/${categorie_nom}/`;

    // ‚úÖ AJOUTER un timestamp pour √©viter le cache
    const timestamp = new Date().getTime();
    const urlWithCacheBust = `${url}?t=${timestamp}`;

    fetch(urlWithCacheBust)
        .then(response => {
            if (!response.ok) throw new Error(`Erreur HTTP ${response.status}`);
            return response.json();
        })
        .then(data => {
            const items = (categorie_nom === 'menu') ? data.menus : data.plats;

            console.log(`üì¶ Donn√©es re√ßues pour ${categorie_nom}:`, items);

            if (!items || items.length === 0) {
                platsContainer.innerHTML = '<p class="text-center py-4">Aucun √©l√©ment disponible.</p>';
                return;
            }

            // ‚úÖ VIDER une seconde fois par s√©curit√©
            platsContainer.innerHTML = '';

            items.forEach(item => {
                // ‚úÖ V√âRIFIER les doublons avant d'ajouter
                const existingItem = Array.from(platsContainer.children).find(child => 
                    child.querySelector('.dz-content .title')?.textContent === item.nom
                );
                
                if (existingItem) {
                    console.warn(`‚ö†Ô∏è Doublon d√©tect√© et ignor√©: ${item.nom}`);
                    return; // Passer au suivant
                }

                const imageUrl = item.photo_url || '/static/images/default.jpg';
                const escapedNom = htmlEscape(item.nom);
                const escapedDescriptionCourte = htmlEscape(item.description_courte);

                const card = document.createElement("li");
                card.className = `card-container col-lg-4 col-md-6 m-b30 ${categorie_nom}`;
                card.setAttribute('data-plat-id', item.id); // ‚úÖ Identifiant unique

                const dzBox = document.createElement("div");
                dzBox.className = "dz-img-box style-7";

                dzBox.addEventListener("click", () => {
                    if (categorie_nom === 'menu') {
                        openMenuModal(item.id, item.nom, imageUrl, item.description_longue, item.prix_unitaire_ttc);
                    } else {
                        openPlatModal(item.id, item.nom, imageUrl, item.description_longue, item.prix_unitaire_ttc, categorie_nom);
                    }
                });

                dzBox.innerHTML = `
                    <div class="dz-media">
                        <img src="${imageUrl}" alt="${escapedNom}" class="img-fluid" style="width: 200px; height: 200px; object-fit: cover;">
                        <div class="dz-meta">
                            <ul><li class="rating"><i class="fa-solid fa-star"></i> 4.5</li></ul>
                        </div>
                    </div>
                    <div class="dz-content">
                        <h5 class="title">${escapedNom}</h5>
                        <p>${escapedDescriptionCourte}</p>
                        <span class="price">${item.prix_unitaire_ttc} ‚Ç¨</span>
                    </div>
                `;

                card.appendChild(dzBox);
                platsContainer.appendChild(card);
            });

            console.log(`‚úÖ ${items.length} √©l√©ments charg√©s pour ${categorie_nom}`);
        })
        .catch(error => {
            console.error('‚ùå Erreur chargement:', error);
            platsContainer.innerHTML = '<p class="text-danger text-center py-4">Erreur de chargement.</p>';
        });
};





window.showOptionsModal = function (platId, categorie) {
    console.log('üçî R√©cup√©ration des options pour le plat :', platId, 'Cat√©gorie:', categorie);

    const isBurger = categorie === 'burger';
    const urls = [
        `/options_par_plat_ajax/${platId}/`
    ];

    if (isBurger) {
        urls.push('/accompagnements_burger_ajax/');
    }

    Promise.all(urls.map(url => 
        fetch(url).then(response => {
            if (!response.ok) throw new Error(`Erreur HTTP : ${response.status}`);
            return response.json();
        })
    ))
    .then(([optionsData, accompagnementsData]) => {
        console.log('üîç DONN√âES OPTIONS RE√áUES:', optionsData);
        if (isBurger) {
            console.log('üçü DONN√âES ACCOMPAGNEMENTS RE√áUES:', accompagnementsData);
        }

        const optionsContainer = document.getElementById('options-container');
        if (!optionsContainer) {
            console.error('‚ùå √âl√©ment "options-container" introuvable');
            return;
        }

        optionsContainer.innerHTML = '';

        const hasRegularOptions = optionsData.options_par_categorie && Object.keys(optionsData.options_par_categorie).length > 0;
        const hasAccompagnements = isBurger && accompagnementsData && accompagnementsData.accompagnements;

        if (!hasRegularOptions && !hasAccompagnements) {
            optionsContainer.innerHTML = '<p class="text-center py-3">Aucune option disponible pour ce plat.</p>';
            return;
        }

        const accordionContainer = document.createElement('div');
        accordionContainer.className = 'accordion';
        accordionContainer.id = 'accordionBurgerOptions';

        let accordionItemCount = 0;

// üçü SECTION ACCOMPAGNEMENTS (EN PREMIER) - AVEC CORRECTION COMPL√àTE DES IDs
if (hasAccompagnements) {
    accordionItemCount++;
    
    const accompagnementItem = document.createElement('div');
    accompagnementItem.className = 'accordion-item';

    const accompagnementHeader = document.createElement('h2');
    accompagnementHeader.className = 'accordion-header';
    accompagnementHeader.id = `headingAccompagnement`;

    const accompagnementButton = document.createElement('button');
    accompagnementButton.className = 'accordion-button';
    accompagnementButton.type = 'button';
    accompagnementButton.setAttribute('data-bs-toggle', 'collapse');
    accompagnementButton.setAttribute('data-bs-target', `#collapseAccompagnement`);
    accompagnementButton.setAttribute('aria-expanded', 'true');
    accompagnementButton.setAttribute('aria-controls', `collapseAccompagnement`);
    accompagnementButton.innerHTML = `
        <span style="margin-right: 10px;">üçü</span>
        Accompagnement au choix <small class="text-muted ms-2">
    `;

    accompagnementHeader.appendChild(accompagnementButton);

    const accompagnementCollapse = document.createElement('div');
    accompagnementCollapse.className = 'accordion-collapse collapse show';
    accompagnementCollapse.id = `collapseAccompagnement`;
    accompagnementCollapse.setAttribute('aria-labelledby', `headingAccompagnement`);

    const accompagnementBody = document.createElement('div');
    accompagnementBody.className = 'accordion-body';

    const accompagnementGrid = document.createElement('div');
    accompagnementGrid.className = 'row';

    // üÜï CLASSEMENT DES ACCOMPAGNEMENTS DANS L'ORDRE SOUHAIT√â
    console.log('üîÑ CLASSEMENT DES ACCOMPAGNEMENTS');
    
    // D√©finir l'ordre souhait√© des accompagnements - COUSCOUS APR√àS COLESLAW
    const ordreAccompagnements = [
        { nom: 'Frites', id: 1001 },
        { nom: 'Riz', id: 1002 },
        { nom: 'Salade', id: 1004 },
        { nom: 'Kemia', id: 1005 },
        { nom: 'Coleslaw', id: 1006 },
        { nom: 'Couscous', id: 1003 },  // Couscous apr√®s Coleslaw
        { nom: 'Onion Rings', id: 1007 },
        { nom: 'Galette R√∂sti', id: 1008 },
        { nom: 'Mozzarella Sticks', id: 1009 }
    ];

    // Trier les accompagnements selon l'ordre d√©fini
    const accompagnementsTries = [];
    
    ordreAccompagnements.forEach(ordre => {
        const accompagnement = accompagnementsData.accompagnements.find(acc => 
            acc.id == ordre.id || acc.nom.toLowerCase().includes(ordre.nom.toLowerCase())
        );
        if (accompagnement) {
            accompagnementsTries.push(accompagnement);
        }
    });

    // Ajouter les accompagnements non sp√©cifi√©s dans l'ordre
    const accompagnementsRestants = accompagnementsData.accompagnements.filter(acc => 
        !accompagnementsTries.includes(acc)
    );
    const tousLesAccompagnements = [...accompagnementsTries, ...accompagnementsRestants];

    console.log('üéØ ACCOMPAGNEMENTS TRI√âS:', tousLesAccompagnements.map(a => a.nom));

    // üÜï CORRECTION COMPL√àTE DES IDs D'ACCOMPAGNEMENT
    tousLesAccompagnements.forEach(accompagnement => {
        // üéØ MAPPING COMPLET DES IDs 1001-1009 ‚Üí 1-9
        const idMapping = {
            '1001': 1,  // Frites
            '1002': 2,  // Riz
            '1003': 3,  // Couscous
            '1004': 4,  // Salade
            '1005': 5,  // Kemia
            '1006': 6,  // Coleslaw
            '1007': 7,  // Onion Rings
            '1008': 8,  // Galette R√∂sti
            '1009': 9,  // Mozzarella Sticks
        };
        
        const correctedId = idMapping[accompagnement.id] || accompagnement.id;
        
        console.log(`   - ${accompagnement.nom}: ID ${accompagnement.id} ‚Üí ${correctedId}`);

        const optionCol = document.createElement('div');
        optionCol.className = 'col-md-6 mb-2';
        
        const isDefault = accompagnement.nom.toLowerCase().includes('frites');
        
        // üÜï FORMAT DES PRIX AVEC 2 D√âCIMALES
        optionCol.innerHTML = `
            <div class="form-check">
                <input class="form-check-input" type="radio" 
                       name="accompagnement_burger" 
                       value="${correctedId}"
                       id="accomp-${correctedId}"
                       ${isDefault ? 'checked' : ''}
                       required>
                <label class="form-check-label d-flex justify-content-between" for="accomp-${correctedId}">
                    <span>${accompagnement.nom}</span>
                    ${accompagnement.prix > 0 ? `<span class="text-success">+${parseFloat(accompagnement.prix).toFixed(2)}‚Ç¨</span>` : '<span class="text-muted">Inclus</span>'}
                </label>
            </div>
        `;
        accompagnementGrid.appendChild(optionCol);
    });

    accompagnementBody.appendChild(accompagnementGrid);
    accompagnementCollapse.appendChild(accompagnementBody);
    accompagnementItem.appendChild(accompagnementHeader);
    accompagnementItem.appendChild(accompagnementCollapse);
    accordionContainer.appendChild(accompagnementItem);
}

        // SECTION OPTIONS R√âGULI√àRES
        if (hasRegularOptions) {
            Object.keys(optionsData.options_par_categorie).forEach(categorieNom => {
                const optionsDeLaCategorie = optionsData.options_par_categorie[categorieNom];
                
                if (!optionsDeLaCategorie || optionsDeLaCategorie.length === 0) return;

                accordionItemCount++;

                const accordionItem = document.createElement('div');
                accordionItem.className = 'accordion-item';

                const accordionHeader = document.createElement('h2');
                accordionHeader.className = 'accordion-header';
                accordionHeader.id = `heading${accordionItemCount}`;

                const accordionButton = document.createElement('button');
                accordionButton.className = 'accordion-button collapsed';
                accordionButton.type = 'button';
                accordionButton.setAttribute('data-bs-toggle', 'collapse');
                accordionButton.setAttribute('data-bs-target', `#collapse${accordionItemCount}`);
                accordionButton.setAttribute('aria-expanded', 'false');
                accordionButton.setAttribute('aria-controls', `collapse${accordionItemCount}`);
                
                let icon = 'üçî';
                if (categorieNom.toLowerCase().includes('viande')) icon = 'ü•©';
                else if (categorieNom.toLowerCase().includes('fromage')) icon = 'üßÄ';
                else if (categorieNom.toLowerCase().includes('sauce')) icon = 'üçØ';

                accordionButton.innerHTML = `
                    <span style="margin-right: 10px;">${icon}</span>
                    ${categorieNom}
                `;

                accordionHeader.appendChild(accordionButton);

                const accordionCollapse = document.createElement('div');
                accordionCollapse.className = 'accordion-collapse collapse';
                accordionCollapse.id = `collapse${accordionItemCount}`;
                accordionCollapse.setAttribute('aria-labelledby', `heading${accordionItemCount}`);

                const accordionBody = document.createElement('div');
                accordionBody.className = 'accordion-body';

                const optionsGrid = document.createElement('div');
                optionsGrid.className = 'row';

                optionsDeLaCategorie.forEach(option => {
                    const optionCol = document.createElement('div');
                    optionCol.className = 'col-md-6 mb-2';
                    
                    optionCol.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                   id="option-${option.id}" 
                                   name="option_${categorieNom.replace(/\s+/g, '_')}" 
                                   value="${option.id}">
                            <label class="form-check-label d-flex justify-content-between" for="option-${option.id}">
                                <span>${option.nom_option}</span>
                                ${option.prix_unitaire > 0 ? `<span class="text-success">+${parseFloat(option.prix_unitaire).toFixed(2)}‚Ç¨</span>` : ''}
                            </label>
                        </div>
                    `;
                    optionsGrid.appendChild(optionCol);
                });

                accordionBody.appendChild(optionsGrid);
                accordionCollapse.appendChild(accordionBody);
                accordionItem.appendChild(accordionHeader);
                accordionItem.appendChild(accordionCollapse);
                accordionContainer.appendChild(accordionItem);
            });
        }

        optionsContainer.appendChild(accordionContainer);

        // üéØ BOUTON "AJOUTER AU PANIER" CORRIG√â
        const ajouterOptionsPanierBtn = document.getElementById('ajouter-options-panier');
        if (ajouterOptionsPanierBtn) {
            ajouterOptionsPanierBtn.onclick = function () {
                const optionsSelectionnees = [];
                let accompagnementId = null;

                // R√©cup√©rer l'accompagnement S√âPAR√âMENT
                if (isBurger) {
                    const accompagnementSelectionne = document.querySelector('input[name="accompagnement_burger"]:checked');
                    if (accompagnementSelectionne) {
                        accompagnementId = accompagnementSelectionne.value;
                        console.log('üçü Accompagnement s√©lectionn√© (ID corrig√©):', accompagnementId);
                    } else {
                        alert('üçü Veuillez s√©lectionner un accompagnement');
                        return;
                    }
                }

                // R√©cup√©rer les options r√©guli√®res
                const checkboxes = document.querySelectorAll('#options-container input[type="checkbox"]:checked');
                checkboxes.forEach(checkbox => {
                    const optionId = checkbox.value;
                    if (optionId && optionId !== 'undefined') {
                        optionsSelectionnees.push(optionId);
                    }
                });

                console.log('‚úÖ Options s√©lectionn√©es :', optionsSelectionnees);
                console.log('üçü Accompagnement s√©lectionn√© :', accompagnementId);
                
                // Appeler la fonction avec accompagnement s√©par√©
                ajouterBurgerAvecAccompagnement(platId, optionsSelectionnees, accompagnementId, categorie);
                $('#optionsModal').modal('hide');
            };
        }

        $('#optionsModal').modal('show');
        console.log("‚úÖ Modal des options avec accord√©ons affich√©");
    })
    .catch(error => {
        console.error('‚ùå Erreur lors du chargement des options :', error);
        alert('Une erreur est survenue lors du chargement des options. Veuillez r√©essayer.');
    });
};

// 5. Fonction globale pour proposer des sides/accompagnements
window.proposerSides = function () {
    console.log("Fonction proposerSides appel√©e");

    const categorie = 'sides';

    fetch(`/plats_par_categorie_ajax/${categorie}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erreur HTTP : ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log(`Donn√©es re√ßues pour la cat√©gorie ${categorie} :`, data);

            const modalBody = document.getElementById('suggestion-modal-body');
            const modalTitle = document.getElementById('suggestionModalLabel');

            if (!modalBody || !modalTitle) {
                console.error('√âl√©ments modaux introuvables dans le DOM.');
                return;
            }

            // ‚úÖ Mise √† jour du titre principal
            modalTitle.textContent = 'Sides et accompagnements';

            // ‚úÖ R√©initialiser le contenu AVEC LA STRUCTURE CORRECTE
            modalBody.innerHTML = `
                <div class="suggestion-grid-container">
                    <div class="suggestion-grid" id="suggestion-grid-sides">
                        ${data.plats && data.plats.length > 0 ? 
                            data.plats.map(plat => {
                                const imageUrl = plat.photo_url || '/static/images/default.jpg';
                                return `
                                    <div class="suggestion-item" data-plat-id="${plat.id}">
                                        <img src="${imageUrl}" alt="${plat.nom}" class="img-thumbnail">
                                        <div class="suggestion-content">
                                            <h6>${plat.nom}</h6>
                                            <p class="price">${plat.prix_unitaire_ttc} ‚Ç¨</p>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" id="side-${plat.id}" class="form-check-input plat-checkbox" value="${plat.id}">
                                            <label class="form-check-label" for="side-${plat.id}">
                                                Ajouter
                                            </label>
                                        </div>
                                    </div>
                                `;
                            }).join('') 
                        : '<p class="no-items">Aucun side disponible pour le moment.</p>'}
                    </div>
                </div>
            `;

            // ‚úÖ Gestion des clics sur les cartes
            const suggestionItems = modalBody.querySelectorAll('.suggestion-item');
            suggestionItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    // Emp√™che le d√©clenchement multiple si on clique sur la checkbox
                    if (e.target.type === 'checkbox') return;
                    
                    const platId = this.getAttribute('data-plat-id');
                    const checkbox = this.querySelector('.plat-checkbox');
                    
                    // Inverse l'√©tat de la checkbox
                    checkbox.checked = !checkbox.checked;
                    
                    // Met √† jour l'apparence visuelle
                    if (checkbox.checked) {
                        this.classList.add('selected');
                    } else {
                        this.classList.remove('selected');
                    }
                    
                    console.log(`Side ${platId} ${checkbox.checked ? 's√©lectionn√©' : 'd√©s√©lectionn√©'}`);
                });
            });

            const suggestionModalInstance = new bootstrap.Modal(document.getElementById('suggestionModal'));
            suggestionModalInstance.show();
            console.log("Modal des suggestions pour les sides affich√©");

            document.getElementById('suggestion-modal-valider-btn').onclick = function () {
                const selectedPlats = Array.from(document.querySelectorAll('#suggestionModal .plat-checkbox:checked'))
                    .map(checkbox => checkbox.value);

                if (selectedPlats.length > 0) {
                    selectedPlats.forEach(platId => ajouterAuPanier(platId, [], null));
                    console.log(`Sides s√©lectionn√©s : ${selectedPlats}`);
                }

                suggestionModalInstance.hide();
                console.log("Modal des suggestions pour les sides cach√© apr√®s validation");
                proposerBoissons();
            };

        })
        .catch(error => {
            console.error(`Erreur lors du chargement des sides :`, error);
            proposerBoissons();
        });
};

// 4. Fonction globale pour proposer des boissons
window.proposerBoissons = function () {
    const categorie = 'boisson';
    console.log(`Appel de proposerBoissons pour la cat√©gorie : ${categorie}`);

    fetch(`/plats_par_categorie_ajax/${categorie}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erreur HTTP : ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log(`Donn√©es re√ßues pour la cat√©gorie ${categorie} :`, data);

            const modalBody = document.getElementById('suggestion-modal-body');
            const modalTitle = document.getElementById('suggestionModalLabel');

            if (!modalBody || !modalTitle) {
                console.error('√âl√©ments modaux introuvables dans le DOM.');
                return;
            }

            // ‚úÖ Met √† jour le titre principal
            modalTitle.textContent = 'Suggestions de boissons';

            // ‚úÖ Structure 3 colonnes identique aux sides
            modalBody.innerHTML = `
                <div class="suggestion-grid-container">
                    <div class="suggestion-grid" id="suggestion-grid-boissons">
                        ${data.plats && data.plats.length > 0 ? 
                            data.plats.map(plat => {
                                const imageUrl = plat.photo_url || '/static/images/default.jpg';
                                return `
                                    <div class="suggestion-item" data-plat-id="${plat.id}">
                                        <img src="${imageUrl}" alt="${plat.nom}" class="img-thumbnail">
                                        <div class="suggestion-content">
                                            <h6>${plat.nom}</h6>
                                            <p class="price">${plat.prix_unitaire_ttc} ‚Ç¨</p>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" id="boisson-${plat.id}" class="form-check-input plat-checkbox" value="${plat.id}">
                                            <label class="form-check-label" for="boisson-${plat.id}">
                                                Ajouter
                                            </label>
                                        </div>
                                    </div>
                                `;
                            }).join('') 
                        : '<p class="no-items">Aucune boisson disponible pour le moment.</p>'}
                    </div>
                </div>
            `;

            // ‚úÖ Gestion des clics sur les cartes (identique aux sides)
            const suggestionItems = modalBody.querySelectorAll('.suggestion-item');
            suggestionItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    if (e.target.type === 'checkbox') return;
                    
                    const platId = this.getAttribute('data-plat-id');
                    const checkbox = this.querySelector('.plat-checkbox');
                    
                    checkbox.checked = !checkbox.checked;
                    
                    if (checkbox.checked) {
                        this.classList.add('selected');
                    } else {
                        this.classList.remove('selected');
                    }
                    
                    console.log(`Boisson ${platId} ${checkbox.checked ? 's√©lectionn√©e' : 'd√©s√©lectionn√©e'}`);
                });
            });

            const suggestionModalInstance = new bootstrap.Modal(document.getElementById('suggestionModal'));
            suggestionModalInstance.show();
            console.log("Modal des suggestions pour les boissons affich√©");

            document.getElementById('suggestion-modal-valider-btn').onclick = function () {
                const selectedPlats = Array.from(document.querySelectorAll('#suggestionModal .plat-checkbox:checked'))
                    .map(checkbox => checkbox.value);

                if (selectedPlats.length > 0) {
                    selectedPlats.forEach(platId => ajouterAuPanier(platId, [], null));
                    console.log(`Boissons s√©lectionn√©es : ${selectedPlats}`);
                }

                suggestionModalInstance.hide();
                console.log("Modal des suggestions pour les boissons cach√© apr√®s validation");
                proposerDesserts();
            };

        })
        .catch(error => {
            console.error(`Erreur lors du chargement des boissons :`, error);
            proposerDesserts();
        });
};

// 5. Fonction globale pour proposer des desserts
window.proposerDesserts = function () {
    console.log("Fonction proposerDesserts appel√©e");

    const categorie = 'dessert';

    fetch(`/plats_par_categorie_ajax/${categorie}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erreur HTTP : ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log(`Donn√©es re√ßues pour la cat√©gorie ${categorie} :`, data);

            const modalBody = document.getElementById('suggestion-modal-body');
            const modalTitle = document.getElementById('suggestionModalLabel');

            if (!modalBody || !modalTitle) {
                console.error('√âl√©ments modaux introuvables dans le DOM.');
                return;
            }

            // ‚úÖ Mise √† jour du titre principal
            modalTitle.textContent = 'La carte des desserts';

            // ‚úÖ Structure 3 colonnes identique
            modalBody.innerHTML = `
                <div class="suggestion-grid-container">
                    <div class="suggestion-grid" id="suggestion-grid-desserts">
                        ${data.plats && data.plats.length > 0 ? 
                            data.plats.map(plat => {
                                const imageUrl = plat.photo_url || '/static/images/default.jpg';
                                return `
                                    <div class="suggestion-item" data-plat-id="${plat.id}">
                                        <img src="${imageUrl}" alt="${plat.nom}" class="img-thumbnail">
                                        <div class="suggestion-content">
                                            <h6>${plat.nom}</h6>
                                            <p class="price">${plat.prix_unitaire_ttc} ‚Ç¨</p>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" id="dessert-${plat.id}" class="form-check-input plat-checkbox" value="${plat.id}">
                                            <label class="form-check-label" for="dessert-${plat.id}">
                                                Ajouter
                                            </label>
                                        </div>
                                    </div>
                                `;
                            }).join('') 
                        : '<p class="no-items">Aucun dessert disponible pour le moment.</p>'}
                    </div>
                </div>
            `;

            // ‚úÖ Gestion des clics sur les cartes (identique)
            const suggestionItems = modalBody.querySelectorAll('.suggestion-item');
            suggestionItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    if (e.target.type === 'checkbox') return;
                    
                    const platId = this.getAttribute('data-plat-id');
                    const checkbox = this.querySelector('.plat-checkbox');
                    
                    checkbox.checked = !checkbox.checked;
                    
                    if (checkbox.checked) {
                        this.classList.add('selected');
                    } else {
                        this.classList.remove('selected');
                    }
                    
                    console.log(`Dessert ${platId} ${checkbox.checked ? 's√©lectionn√©' : 'd√©s√©lectionn√©'}`);
                });
            });

            const suggestionModalInstance = new bootstrap.Modal(document.getElementById('suggestionModal'));
            suggestionModalInstance.show();
            console.log("Modal des suggestions pour les desserts affich√©");

            document.getElementById('suggestion-modal-valider-btn').onclick = function () {
                const selectedPlats = Array.from(document.querySelectorAll('#suggestionModal .plat-checkbox:checked'))
                    .map(checkbox => checkbox.value);

                if (selectedPlats.length > 0) {
                    selectedPlats.forEach(platId => ajouterAuPanier(platId, [], null));
                    console.log(`Desserts s√©lectionn√©s : ${selectedPlats}`);
                }

                suggestionModalInstance.hide();
                console.log("Modal des suggestions pour les desserts cach√© apr√®s validation");
            };

        })
        .catch(error => {
            console.error(`Erreur lors du chargement des desserts :`, error);
            
            const suggestionModalInstance = new bootstrap.Modal(document.getElementById('suggestionModal'));
            suggestionModalInstance.hide();
            console.log("Modal des suggestions pour les desserts cach√© apr√®s erreur");
        });
};






// 6. Fonction globale pour ajouter un plat au panier
window.ajouterAuPanier = function (platId, optionsSelectionnees = [], categoriePlat = null) {
    console.log(`üöÄ D√©but de ajouterAuPanier pour le plat : ${platId}`, {
        optionsSelectionnees: optionsSelectionnees,
        categoriePlat: categoriePlat
    });

    // R√©initialiser le conteneur des messages pour le code promo, s'il existe
    const messageContainer = document.getElementById('code-promo-message');
    if (messageContainer) {
        messageContainer.innerHTML = '';
        messageContainer.style.display = 'none';
    }

    // Pr√©parer les donn√©es pour l'envoi
    const dataToSend = {
        plat_id: platId,
        options: optionsSelectionnees
        
    };

    console.log('üì§ Donn√©es envoy√©es au serveur:', dataToSend);

    // Effectuer une requ√™te POST pour ajouter le plat au panier
    fetch('/ajouter_au_panier/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(dataToSend)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Erreur HTTP : ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('üì• Donn√©es re√ßues apr√®s ajout au panier:', data);

        if (data.success) {
            // V√©rifier sp√©cifiquement la structure des options dans la r√©ponse
            if (data.cart_items && data.cart_items.length > 0) {
                data.cart_items.forEach((item, index) => {
                    console.log(`üì¶ Article ${index} dans la r√©ponse:`, {
                        nom: item.plat_nom,
                        options: item.options,
                        tous_les_champs: item // Log tous les champs pour inspection
                    });
                });
            }

            // Mettre √† jour l'affichage du panier
            updateCartDisplay(data.cart_items, data.totals, data.code_promo);

            // D√©clencher des suggestions si la cat√©gorie le n√©cessite
            if (categoriePlat && categoriePlat !== "boisson" && categoriePlat !== "dessert" && categoriePlat !== "sides" && categoriePlat !== "menu") {
                console.log(`üéØ Relancer les suggestions pour le nouveau plat : ${platId}`);
                proposerSides();
            } else {
                console.log(`‚è≠Ô∏è Pas de suggestion n√©cessaire pour la cat√©gorie : ${categoriePlat}`);
            }
        } else {
            console.error('‚ùå Erreur lors de l\'ajout au panier :', data.message);
            alert(data.message || 'Une erreur est survenue lors de l\'ajout au panier.');
        }
    })
    .catch(error => {
        console.error('‚ùå Erreur lors de la requ√™te d\'ajout au panier :', error);
        alert('Une erreur est survenue. Veuillez r√©essayer.');
    });
};


window.openPlatModal = function (platId, nomEncoded, imageUrlEncoded, descriptionLongueEncoded, prix, categorie) {
    console.log("üçΩÔ∏è Ouverture modal plat:", { platId, nomEncoded, prix, categorie });

    const nom = decodeURIComponent(nomEncoded).trim();
    const imageUrl = decodeURIComponent(imageUrlEncoded);
    const description = decodeURIComponent(descriptionLongueEncoded);

    // Mettre √† jour le contenu de la modal
    document.getElementById('plat-nom').textContent = nom;
    document.getElementById('plat-photo').src = imageUrl;
    document.getElementById('plat-description').innerHTML = description.replace(/\n/g, '<br>');
    document.getElementById('plat-prix').textContent = `${prix} ‚Ç¨`;

    const bouton = document.getElementById('ajouter-au-panier-btn');
    const nomLower = nom.toLowerCase();

    // üÜï GESTION DES CROUSTY
    if (nomLower.includes('crousty')) {
        bouton.onclick = function () {
            $('#platModal').modal('hide');
            openCroustyModal(platId, nom, imageUrl, description, prix);
        };
        $('#platModal').modal('show');
        return;
    }
    
    // üÜï POULET PERSONNALIS√â
    else if (nomLower.includes('poulet') || 
             nomLower.includes('tenders') || 
             nomLower.includes('wings') || 
             nomLower.includes('bucket') ||
             categorie === 'poulet') {
        bouton.onclick = function () {
            $('#platModal').modal('hide');
            openPouletModal(platId, nom, imageUrl, description, prix);
        };
        $('#platModal').modal('show');
        return;
    }
    
    // ü•ó SALADE PERSONNALIS√âE
    else if (nomLower === "salade personnalis√©e") {
        configurerSaladePersonnalisee(bouton);
        $('#platModal').modal('show');
        return;
    }
    
    // üçõ COUSCOUS PERSONNALIS√â
    else if (nomLower === "composer votre couscous") {
        configurerCouscousPersonnalise(bouton);
        $('#platModal').modal('show');
        return;
    }
    
    // üçî BURGERS ET PLATS AVEC OPTIONS
    else {
        configurerPlatAvecOptions(platId, nom, categorie, bouton);
    }

    $('#platModal').modal('show');
    console.log("‚úÖ Modal du plat affich√©");
};

// FONCTIONS HELPER POUR CHAQUE TYPE DE PLAT

function configurerSaladePersonnalisee(bouton) {
    bouton.onclick = function () {
        $('#platModal').modal('hide');
        $('#composeSaladeModal').modal('show');
    };

    fetch('/get_salade_options/')
        .then(response => response.json())
        .then(data => {
            const zones = {
                base: document.querySelector('#saladeForm .base-container'),
                proteine: document.querySelector('#saladeForm .proteine-container'),
                garnitures: document.querySelector('#saladeForm .garniture-container'),
                toppings: document.querySelector('#saladeForm .topping-container'),
                sauces: document.querySelector('#saladeForm .sauce-container')
            };

            for (const [type, container] of Object.entries(zones)) {
                if (!container || !data[type]) continue;

                container.innerHTML = '';

                const titre = document.createElement('h6');
                titre.textContent = type.charAt(0).toUpperCase() + type.slice(1) + ' au choix :';
                container.appendChild(titre);

                const row = document.createElement('div');
                row.className = 'row';

                data[type].forEach(([id, nom, prix]) => {
                    const label = prix > 0 ? `${nom} (+${prix.toFixed(2)}‚ÄØ‚Ç¨)` : nom;
                    const inputType = (type === 'base' || type === 'sauces') ? 'radio' : 'checkbox';
                    const inputName = {
                        sauces: 'sauce',
                        base: 'base',
                        proteine: 'proteine',
                        garnitures: 'garniture',
                        toppings: 'topping',
                        supplements: 'supplement'
                    }[type] || type;
                    
                    const col = document.createElement('div');
                    col.className = 'col-md-6';
                    col.innerHTML = `
                        <div class="form-check salade-option mb-2">
                            <input type="${inputType}" class="form-check-input" name="${inputName}" value="${id}" id="${type}-${id}">
                            <label class="form-check-label" for="${type}-${id}">${label}</label>
                        </div>
                    `;
                    row.appendChild(col);
                });

                container.appendChild(row);
            }
        })
        .catch(error => console.error('‚ùå Erreur chargement options salade :', error));
}

function configurerCouscousPersonnalise(bouton) {
    bouton.onclick = function () {
        $('#platModal').modal('hide');
        $('#composeCouscousModal').modal('show');
    };

    fetch('/get_couscous_options/')
        .then(response => response.json())
        .then(data => {
            const viandeContainer = document.getElementById('viande-options');
            const accContainer = document.getElementById('accompagnement-options');
            const blocViandes = document.getElementById('bloc-choix-viandes');
            const blocAccompagnements = document.getElementById('bloc-accompagnements');
            const radioFormules = document.querySelectorAll('input[name="formule"]');
            const validerBtn = document.getElementById('validerCouscousBtn');

            viandeContainer.innerHTML = '';
            accContainer.innerHTML = '';
            let maxViandes = 1;
            const quantites = {};

            function creerViandeHTML(viande) {
                const supp = parseFloat(viande.supp);
                return `
                    <div class="viande-bloc">
                        <div class="d-flex flex-column">
                            <label class="form-label viande-nom mb-1">${viande.nom}</label>
                            ${supp > 0 ? `<small class="text-muted viande-prix d-none d-md-block">+${supp.toFixed(2)}‚Ç¨</small>` : ''}
                            ${supp > 0 ? `<small class="text-muted viande-prix-mobile d-md-none">+${supp.toFixed(2)}‚Ç¨</small>` : ''}
                        </div>
                        <div class="d-flex align-items-center mt-2">
                            <button type="button" class="btn btn-outline-warning btn-sm btn-moins" data-id="${viande.id}">‚àí</button>
                            <span class="quantite px-2" id="quantite-${viande.id}">0</span>
                            <button type="button" class="btn btn-outline-warning btn-sm btn-plus" data-id="${viande.id}">+</button>
                        </div>
                    </div>
                `;
            }

            function afficherViandes() {
                viandeContainer.innerHTML = '';
                
                // Cr√©er un tableau des viandes avec leurs donn√©es
                const viandes = data.viandes_incluses.map(([id, nom, supp]) => {
                    return { id, nom, supp };
                });

                // R√©organiser selon votre demande
                const boulettes = viandes.find(v => v.nom.includes('Boulettes'));
                const poulet = viandes.find(v => v.nom.includes('Cuisse de Poulet'));
                const merguez = viandes.find(v => v.nom.includes('Merguez'));
                const brochette = viandes.find(v => v.nom.includes('Brochette'));
                const agneau = viandes.find(v => v.nom.includes('Agneau'));

                // Premi√®re ligne : 4 Boulettes - 1 Cuisse de Poulet
                let html = '<div class="row mb-3">';
                if (boulettes) {
                    html += `<div class="col-md-6 viande-col mb-2">${creerViandeHTML(boulettes)}</div>`;
                    quantites[boulettes.id] = 0;
                }
                if (poulet) {
                    html += `<div class="col-md-6 viande-col mb-2">${creerViandeHTML(poulet)}</div>`;
                    quantites[poulet.id] = 0;
                }
                html += '</div>';

                // Deuxi√®me ligne : 2 Merguez - 2 Brochette
                html += '<div class="row mb-3">';
                if (merguez) {
                    html += `<div class="col-md-6 viande-col mb-2">${creerViandeHTML(merguez)}</div>`;
                    quantites[merguez.id] = 0;
                }
                if (brochette) {
                    html += `<div class="col-md-6 viande-col mb-2">${creerViandeHTML(brochette)}</div>`;
                    quantites[brochette.id] = 0;
                }
                html += '</div>';

                // Troisi√®me ligne : 1 Morceau d'√âpaule d'Agneau
                html += '<div class="row mb-3">';
                if (agneau) {
                    html += `<div class="col-md-6 viande-col mb-2">${creerViandeHTML(agneau)}</div>`;
                    quantites[agneau.id] = 0;
                }
                html += '</div>';

                // Ajouter les viandes restantes non sp√©cifi√©es
                const viandesRestantes = viandes.filter(v => 
                    v !== boulettes && v !== poulet && v !== merguez && 
                    v !== brochette && v !== agneau
                );

                if (viandesRestantes.length > 0) {
                    html += '<div class="row">';
                    viandesRestantes.forEach(viande => {
                        html += `<div class="col-md-6 viande-col mb-2">${creerViandeHTML(viande)}</div>`;
                        quantites[viande.id] = 0;
                    });
                    html += '</div>';
                }

                viandeContainer.innerHTML = html;

                // Ajouter les √©v√©nements
                viandeContainer.querySelectorAll('.btn-plus').forEach(btn => {
                    btn.onclick = () => {
                        const id = btn.dataset.id;
                        const total = Object.values(quantites).reduce((a, b) => a + b, 0);
                        if (total < maxViandes) {
                            quantites[id]++;
                            document.getElementById(`quantite-${id}`).textContent = quantites[id];
                        }
                    };
                });

                viandeContainer.querySelectorAll('.btn-moins').forEach(btn => {
                    btn.onclick = () => {
                        const id = btn.dataset.id;
                        if (quantites[id] > 0) {
                            quantites[id]--;
                            document.getElementById(`quantite-${id}`).textContent = quantites[id];
                        }
                    };
                });
            }

            function afficherAccompagnements() {
                accContainer.innerHTML = '';
                data.accompagnements.forEach(([code, nom]) => {
                    accContainer.innerHTML += `
                        <div class="col-md-6 accompagnement-bloc mb-2">
                            <div class="form-check">
                                <input class="form-check-input accompagnement" type="checkbox" value="${code}" id="acc-${code}">
                                <label class="form-check-label" for="acc-${code}">${nom}</label>
                            </div>
                        </div>
                    `;
                });
            }

            function appliquerFormule(formuleNom) {
                maxViandes = {
                    "Couscous Tradition": 1,
                    "Couscous Gourmand": 2,
                    "Couscous 2 Palmiers": 3,
                    "Couscous Royal": 4,
                }[formuleNom] || 0;

                if (formuleNom === "Couscous V√©g√©tarien") {
                    blocViandes.style.display = 'none';
                } else {
                    blocViandes.style.display = 'block';
                }

                blocAccompagnements.style.display = 'block';
                afficherViandes();
                afficherAccompagnements();
            }

            // S√©lection initiale
            const radioVeg = Array.from(radioFormules).find(r => r.value === "Couscous V√©g√©tarien");
            if (radioVeg) {
                radioVeg.checked = true;
                appliquerFormule("Couscous V√©g√©tarien");
            }

            radioFormules.forEach(radio => {
                radio.addEventListener('change', () => {
                    appliquerFormule(radio.value);
                });
            });

            // Validation et ajout au panier
            if (validerBtn) {
                validerBtn.onclick = function (e) {
                    e.preventDefault();

                    const formuleRadio = Array.from(radioFormules).find(r => r.checked);
                    const formuleNom = formuleRadio ? formuleRadio.value : null;
                    const formule = data.formules.find(f => f[1] === formuleNom);
                    const formule_id = formule ? formule[0] : null;

                    if (!formule_id) return alert("Formule non reconnue");

                    const option_xl = document.getElementById('option_xl')?.checked || false;

                    const viandes_choisies = Object.entries(quantites)
                        .filter(([_, qty]) => qty > 0)
                        .flatMap(([id, qty]) => Array(qty).fill(parseInt(id)));

                    const accompagnements = Array.from(document.querySelectorAll('.accompagnement:checked'))
                        .map(input => input.value);

                    fetch("/ajouter_couscous_personnalise/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCookie("csrftoken")
                        },
                        body: JSON.stringify({
                            formule_id: formule_id,
                            viandes_choisies: viandes_choisies,
                            accompagnements: accompagnements,
                            option_xl: option_xl
                        })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            $('#composeCouscousModal').modal('hide');
                            updateCartDisplay(data.cart_items, data.totals, data.code_promo);
                            setTimeout(() => proposerSides(), 300);
                        } else {
                            alert(data.error || "Erreur lors de l'ajout au panier");
                        }
                    })
                    .catch(err => console.error("Erreur ajout couscous :", err));
                };
            }
        })
        .catch(error => console.error('‚ùå Erreur chargement options couscous :', error));
}
function configurerPlatAvecOptions(platId, nom, categorie, bouton) {
    // Pour les burgers, on charge directement les options avec accompagnements
    // Pour les autres plats, on v√©rifie s'ils ont des options
    
    const isBurger = categorie === 'burger';
    
    if (isBurger) {
        // Les burgers ont toujours au moins les accompagnements
        bouton.onclick = function () {
            $('#platModal').modal('hide');
            showOptionsModal(platId, categorie);
        };
    } else {
        // Pour les autres plats, on v√©rifie s'ils ont des options sp√©cifiques
        fetch(`/options_par_plat_ajax/${platId}/`)
            .then(response => response.json())
            .then(data => {
                console.log('‚úÖ Options re√ßues pour', nom, data);
                
                const hasOptions = data.options_par_categorie && Object.keys(data.options_par_categorie).length > 0;
                
                if (hasOptions) {
                    bouton.onclick = function () {
                        $('#platModal').modal('hide');
                        showOptionsModal(platId, categorie);
                    };
                } else {
                    // Pas d'options sp√©cifiques, ajouter directement au panier
                    bouton.onclick = function () {
                        ajouterAuPanier(platId, [], categorie);
                        $('#platModal').modal('hide');
                    };
                }
            })
            .catch(error => {
                console.error('‚ùå Erreur chargement options plat :', error);
                // En cas d'erreur, permettre l'ajout direct au panier
                bouton.onclick = function () {
                    ajouterAuPanier(platId, [], categorie);
                    $('#platModal').modal('hide');
                };
            });
    }
}


function remplirOptionsCouscous(data) {
    const viandeOptionsContainer = document.getElementById('viande-options');
    viandeOptionsContainer.innerHTML = '';

    // Viandes incluses
    const viandesInclusesHeader = document.createElement('div');
    viandesInclusesHeader.className = 'col-12 mb-2';
    viandeOptionsContainer.appendChild(viandesInclusesHeader);

    data.viandes_incluses.forEach(viande => {
        const [id, nom] = viande;
        viandeOptionsContainer.innerHTML += `
            <div class="col-md-6">
                <div class="form-check">
                    <input class="form-check-input viande-incluse" type="checkbox" name="viandes_incluse" value="${nom}" id="viandeIncluse-${id}">
                    <label class="form-check-label" for="viandeIncluse-${id}">${nom}</label>
                </div>
            </div>`;
    });

    // Viandes suppl√©mentaires
    const suppHeader = document.createElement('div');
    suppHeader.className = 'col-12 mt-3 mb-2';
    suppHeader.innerHTML = '<strong>Suppl√©ments viande (optionnels) :</strong>';
    viandeOptionsContainer.appendChild(suppHeader);

    data.viandes_supplementaires.forEach(viande => {
        const [id, nom, prix] = viande;
        viandeOptionsContainer.innerHTML += `
            <div class="col-md-6">
                <div class="form-check">
                    <input class="form-check-input viande-supp" type="checkbox" name="viandes_supp" value="${nom}" id="viandeSupp-${id}" data-prix="${prix}">
                    <label class="form-check-label" for="viandeSupp-${id}">${nom} (+${parseFloat(prix).toFixed(2)} ‚Ç¨)</label>
                </div>
            </div>`;
    });

    // Gestion automatique : limite les cases coch√©es selon la formule
    document.querySelectorAll('input[name="formule"]').forEach(radio => {
        radio.addEventListener('change', () => {
            const formule = radio.value;
            const max = {
                "Couscous Tradition": 1,
                "Couscous Gourmand": 2,
                "Couscous 2 Palmiers": 3,
                "Couscous Royal": 4
            }[formule] || 1;

            const checkboxes = document.querySelectorAll('.viande-incluse');
            checkboxes.forEach(cb => cb.disabled = false);

            let selected = Array.from(checkboxes).filter(cb => cb.checked);
            if (selected.length > max) {
                selected.slice(max).forEach(cb => cb.checked = false);
            }

            checkboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    const current = Array.from(checkboxes).filter(c => c.checked);
                    if (current.length >= max) {
                        checkboxes.forEach(c => {
                            if (!c.checked) c.disabled = true;
                        });
                    } else {
                        checkboxes.forEach(c => c.disabled = false);
                    }
                });
            });
        });
    });
}


function ajouterCouscous(platId, categorie) {
    const form = document.getElementById('couscousForm');
    const formData = new FormData(form);

    const formuleId = formData.get('formule');
    const optionXL = formData.get('option_xl') === 'on';
    const viandesIncluse = formData.getAll('viandes_incluse');
    const viandesSupp = formData.getAll('viandes_supp');
    const accompagnements = formData.getAll('accompagnement');

    const data = {
        plat_id: platId,
        formule_id: formuleId,
        viandes_choisies: [...viandesIncluse, ...viandesSupp],
        accompagnements: accompagnements,
        option_xl: optionXL
    };

    fetch('/ajouter_couscous_personnalise/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        console.log('R√©ponse apr√®s ajout couscous personnalis√©:', data);

        if (data.success) {
            updateCartDisplay(data.cart_items, data.totals, data.code_promo);
            $('#composeCouscousModal').modal('hide');

            // ‚úÖ Proposer boissons et desserts apr√®s fermeture du modal
            setTimeout(() => {
                proposerBoissons();
            }, 400);
        } else {
            alert(data.error || 'Une erreur est survenue lors de l‚Äôajout du couscous.');
        }
    })
    .catch(error => {
        alert('Erreur lors de l‚Äôajout du couscous personnalis√©.');
        console.error(error);
    });
}




// Fonction pour g√©rer les burgers avec accompagnements
window.showBurgerWithAccompagnement = function (platId, categorie) {
    // Charger les options d'accompagnement sp√©cifiques aux burgers
    fetch(`/accompagnements_burger_ajax/`)
        .then(response => response.json())
        .then(data => {
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';

            // Cr√©er l'accord√©on pour les accompagnements
            const accordionContainer = document.createElement('div');
            accordionContainer.className = 'accordion';
            accordionContainer.id = 'accordionBurgerOptions';

            // Section accompagnements
            const accordionItem = document.createElement('div');
            accordionItem.className = 'accordion-item';

            const accordionHeader = document.createElement('h2');
            accordionHeader.className = 'accordion-header';
            accordionHeader.id = 'headingAccompagnement';

            const accordionButton = document.createElement('button');
            accordionButton.className = 'accordion-button';
            accordionButton.type = 'button';
            accordionButton.setAttribute('data-bs-toggle', 'collapse');
            accordionButton.setAttribute('data-bs-target', '#collapseAccompagnement');
            accordionButton.setAttribute('aria-expanded', 'true');
            accordionButton.setAttribute('aria-controls', 'collapseAccompagnement');
            accordionButton.innerHTML = '<span style="margin-right: 10px;">üçü</span> Accompagnement au choix';

            accordionHeader.appendChild(accordionButton);

            const accordionCollapse = document.createElement('div');
            accordionCollapse.className = 'accordion-collapse collapse show';
            accordionCollapse.id = 'collapseAccompagnement';
            accordionCollapse.setAttribute('aria-labelledby', 'headingAccompagnement');

            const accordionBody = document.createElement('div');
            accordionBody.className = 'accordion-body';

            // Ajouter les options d'accompagnement
            const optionsGrid = document.createElement('div');
            optionsGrid.className = 'row';

            data.accompagnements.forEach(accompagnement => {
                const optionCol = document.createElement('div');
                optionCol.className = 'col-md-6 mb-2';
                
                optionCol.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="accompagnement_burger" 
                               value="${accompagnement.id}" id="accomp-${accompagnement.id}" required>
                        <label class="form-check-label" for="accomp-${accompagnement.id}">
                            ${accompagnement.nom} ${accompagnement.prix > 0 ? `(+${accompagnement.prix} ‚Ç¨)` : ''}
                        </label>
                    </div>
                `;

                optionsGrid.appendChild(optionCol);
            });

            accordionBody.appendChild(optionsGrid);
            accordionCollapse.appendChild(accordionBody);
            accordionItem.appendChild(accordionHeader);
            accordionItem.appendChild(accordionCollapse);
            accordionContainer.appendChild(accordionItem);
            optionsContainer.appendChild(accordionContainer);

            // Gestion du bouton "Ajouter au panier"
            const ajouterOptionsPanierBtn = document.getElementById('ajouter-options-panier');
            if (ajouterOptionsPanierBtn) {
                ajouterOptionsPanierBtn.onclick = function () {
                    const accompagnementSelectionne = document.querySelector('input[name="accompagnement_burger"]:checked');
                    
                    if (!accompagnementSelectionne) {
                        alert('Veuillez s√©lectionner un accompagnement');
                        return;
                    }

                    const optionsSelectionnees = [accompagnementSelectionne.value];
                    ajouterAuPanier(platId, optionsSelectionnees, categorie);
                    $('#optionsModal').modal('hide');
                };
            }

            $('#optionsModal').modal('show');
        })
        .catch(error => {
            console.error('Erreur chargement accompagnements:', error);
        });
};




// Dans la fonction updateCartDisplay, ajoutez cette logique pour les options
window.updateCartDisplay = function (cartItems, totals, codePromo = null) {
    console.log('üîÑ Mise √† jour du panier', { cartItems, totals, codePromo });
    
    // üÜï V√âRIFICATION SP√âCIFIQUE DES ARTICLES POULET
    cartItems.forEach((item, index) => {
        if (item.categorie_nom && item.categorie_nom.toLowerCase().includes('poulet')) {
            console.log(`üêî Article poulet ${index}:`, item);
            console.log(`   - Options directes:`, item.options);
            console.log(`   - Tous les champs:`, item.tous_les_champs);
            console.log(`   - Options poulet sp√©cifiques:`, item.tous_les_champs?.options_poulet);
        }
    });
    
    const cartContainer = document.getElementById('cart-items');
    const cartCount = document.getElementById('cart-count');
    const invoiceDetails = document.getElementById('invoice-details');

    if (!cartContainer || !cartCount || !invoiceDetails) {
        console.error('‚ùå √âl√©ments DOM du panier introuvables');
        return;
    }

    // Vider le contenu actuel
    cartContainer.innerHTML = '';

    // Si panier vide
    if (!cartItems || cartItems.length === 0) {
        cartContainer.innerHTML = '<p id="empty-cart-message">Votre panier est vide.</p>';
        cartCount.textContent = '(0)';
        invoiceDetails.innerHTML = '';
        console.log('üõí Panier vide');
        return;
    }

    // Trier les articles
    cartItems.sort((a, b) => {
        const idxA = getTriIndex(a);
        const idxB = getTriIndex(b);
        return idxA !== idxB ? idxA - idxB : a.plat_nom?.toLowerCase().localeCompare(b.plat_nom?.toLowerCase() || '');
    });

    // Calculer le nombre total d'articles
    const totalItems = cartItems.reduce((acc, item) => acc + (item.quantite || 0), 0);
    cartCount.textContent = `(${totalItems})`;

    // G√©n√©rer le HTML pour chaque article
    cartItems.forEach(item => {
        const { accompagnementDisplay, optionsDisplay } = extractItemDetails(item);
        const prixTotalLigne = parseFloat(item.prix_total || 0).toFixed(2);
        const articleId = item.article_id || item.id || 'unknown';

        const articleHTML = createCartItemHTML(item, accompagnementDisplay, optionsDisplay, prixTotalLigne, articleId);
        cartContainer.innerHTML += articleHTML;
    });

    console.log('‚úÖ Panier mis √† jour avec', cartItems.length, 'articles');

    // Mettre √† jour la facture et les √©v√©nements
    updateInvoiceDetails(totals, codePromo);
    attachCartEventListeners();
};

// Fonction pour extraire les d√©tails d'un article
function extractItemDetails(item) {
    let accompagnementNom = '';
    let accompagnementPrix = '';
    let optionsArray = [];

    console.log('üîç Extraction d√©tails article COMPLET:', item);

    // 1. R√âCUP√âRER LES VIANDES COUSCOUS SP√âCIFIQUES
    if (item.tous_les_champs?.viandes_couscous && Array.isArray(item.tous_les_champs.viandes_couscous)) {
        console.log('ü•© VIANDES COUSCOUS TROUV√âES:', item.tous_les_champs.viandes_couscous);
        item.tous_les_champs.viandes_couscous.forEach(viande => {
            if (typeof viande === 'string' && viande.trim() !== '') {
                optionsArray.push(`ü•© ${viande.trim()}`);
            }
        });
    }

    // 2. R√âCUP√âRER LES OPTIONS DIRECTES
    if (item.options && Array.isArray(item.options)) {
        console.log('üì¶ OPTIONS DIRECTES:', item.options);
        item.options.forEach(option => {
            if (typeof option === 'string' && option.trim() !== '') {
                // V√©rifier si c'est une viande couscous dans les options
                const isViandeCouscous = option.includes('Cuisse de Poulet') || 
                                       option.includes('Merguez') || 
                                       option.includes('Boulettes') || 
                                       option.includes('Brochette') || 
                                       option.includes('Agneau') ||
                                       option.match(/^\d+\s+\w+/) || // "1 Cuisse"
                                       option.match(/^\+\d+\s+\w+/); // "+2 Merguez"
                
                if (isViandeCouscous && !optionsArray.some(opt => opt.includes(option))) {
                    console.log('ü•© VIANDE COUSCOUS DANS OPTIONS:', option);
                    optionsArray.push(`ü•© ${option.trim()}`);
                } else if (!isViandeCouscous) {
                    optionsArray.push(option.trim());
                }
            }
        });
    }

    // 3. R√âCUP√âRER L'ACCOMPAGNEMENT
    if (item.tous_les_champs?.nom_accompagnement) {
        accompagnementNom = item.tous_les_champs.nom_accompagnement;
        accompagnementPrix = item.tous_les_champs.prix_accompagnement || '0.00';
    } else if (item.accompagnement && item.accompagnement !== 'undefined') {
        accompagnementNom = item.accompagnement;
    }

    // 4. R√âCUP√âRER LES OPTIONS DANS TOUS_LES_CHAMPS
    if (item.tous_les_champs) {
        // Options classiques
        if (item.tous_les_champs.options_classiques && Array.isArray(item.tous_les_champs.options_classiques)) {
            console.log('üìã OPTIONS CLASSIQUES:', item.tous_les_champs.options_classiques);
            item.tous_les_champs.options_classiques.forEach(option => {
                if (typeof option === 'string' && option.trim() !== '') {
                    // Ne pas ajouter les viandes couscous en double
                    const isViandeCouscous = option.includes('Cuisse de Poulet') || 
                                           option.includes('Merguez') || 
                                           option.includes('Boulettes') || 
                                           option.includes('Brochette') || 
                                           option.includes('Agneau');
                    
                    if (!isViandeCouscous || !optionsArray.some(opt => opt.includes(option))) {
                        optionsArray.push(option.trim());
                    }
                }
            });
        }
        
        // Options poulet
        if (item.tous_les_champs.options_poulet && Array.isArray(item.tous_les_champs.options_poulet)) {
            console.log('üêî OPTIONS POULET:', item.tous_les_champs.options_poulet);
            item.tous_les_champs.options_poulet.forEach(option => {
                if (typeof option === 'object' && option.nom) {
                    optionsArray.push(`üêî ${option.nom}`);
                } else if (typeof option === 'string' && option.trim() !== '') {
                    optionsArray.push(`üêî ${option.trim()}`);
                }
            });
        }
        
        // Options crousty
        if (item.tous_les_champs.options_crousty && Array.isArray(item.tous_les_champs.options_crousty)) {
            console.log('üçî OPTIONS CROUSTY:', item.tous_les_champs.options_crousty);
            item.tous_les_champs.options_crousty.forEach(option => {
                if (typeof option === 'object' && option.nom) {
                    optionsArray.push(option.nom);
                } else if (typeof option === 'string' && option.trim() !== '') {
                    optionsArray.push(option.trim());
                }
            });
        }
    }

    // 5. NETTOYER ET FILTRER LES OPTIONS
    optionsArray = optionsArray
        .filter(opt => {
            // Supprimer les valeurs vides
            if (!opt || opt === '' || opt === 'undefined' || opt === 'null') return false;
            // Supprimer les IDs num√©riques
            if (typeof opt === 'string' && !isNaN(opt.trim())) return false;
            return true;
        })
        // Supprimer les doublons
        .filter((opt, index, self) => self.indexOf(opt) === index);

    console.log('‚úÖ OPTIONS FINALES:', optionsArray);

    // 6. FORMATER L'ACCOMPAGNEMENT
    let accompagnementDisplay = '';
    if (accompagnementNom && accompagnementNom !== '') {
        accompagnementDisplay = `üçü ${accompagnementNom}`;
        if (accompagnementPrix && parseFloat(accompagnementPrix) > 0) {
            accompagnementDisplay += ` (+${parseFloat(accompagnementPrix).toFixed(2)}‚Ç¨)`;
        }
        accompagnementDisplay = `
            <div class="accompagnement-item" style="font-style: italic; color: #28a745; font-size: 13.5px; margin-top: 2px; line-height: 1.3; font-weight: 500;">
                ${accompagnementDisplay}
            </div>`;
    }

    // 7. FORMATER LES OPTIONS
    let optionsDisplay = '';
    if (optionsArray.length > 0) {
        const optionsHTML = optionsArray.map(option => {
            // Viandes couscous avec ü•©
            if (option.includes('ü•©')) {
                return `
                    <div class="option-line viande-couscous-option" 
                         style="font-style: italic; color: #28a745; font-weight: 500; font-size: 13.5px; margin-top: 2px; line-height: 1.3;">
                        ${option}
                    </div>`;
            }
            // Options poulet avec üêî
            else if (option.includes('üêî')) {
                return `
                    <div class="option-line poulet-option" 
                         style="font-style: italic; color: #D35400; font-weight: 500; font-size: 13.5px; margin-top: 2px; line-height: 1.3;">
                        ${option}
                    </div>`;
            }
            // Options g√©n√©riques
            else {
                return `
                    <div class="option-line autre-option" 
                         style="font-style: italic; color: #666; font-size: 13.5px; margin-top: 2px; line-height: 1.3;">
                        ${option}
                    </div>`;
            }
        }).join('');
        
        optionsDisplay = `
            <div class="plat-options">
                ${optionsHTML}
            </div>`;
    }

    return { accompagnementDisplay, optionsDisplay };
}



// Fonction pour cr√©er le HTML d'un article du panier
function createCartItemHTML(item, accompagnementDisplay, optionsDisplay, prixTotalLigne, articleId) {
    return `
        <div class="cart-item style-1" data-article-id="${articleId}" style="border-bottom: 1px solid #e0e0e0; padding: 12px 0; margin-bottom: 8px;">
            <div class="dz-content">
                <div class="dz-head" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                    <div style="flex: 1;">
                        <h6 class="title mb-1" style="font-size: 16px; font-weight: 500; color: #333;">
                            ${item.plat_nom || 'Article sans nom'}
                        </h6>
                        ${accompagnementDisplay}
                        ${optionsDisplay}
                    </div>
                    <a href="javascript:void(0);" class="remove-item" data-article-id="${articleId}" style="margin-left: 10px; flex-shrink: 0;">
                        <i class="fa-solid fa-xmark text-danger" style="font-size: 16px;"></i>
                    </a>
                </div>
                <div class="dz-body" style="display: flex; justify-content: space-between; align-items: center;">
                    <div class="btn-quantity style-1">
                        <div class="input-group" style="display: flex; align-items: center; height: 32px;">
                            <button class="btn btn-default bootstrap-touchspin-down"
                                    data-article-id="${articleId}"
                                    style="width: 26px; height: 100%; padding: 0; font-size: 13px; background-color: #f8f9fa; color: #333; border: 1px solid #ddd; border-radius: 4px 0 0 4px;">
                                <i class="ti-minus" style="font-size: 11px;"></i>
                            </button>
                            <input type="text" class="quantity-input form-control"
                                value="${item.quantite || 1}" name="quantite" readonly=""
                                style="width: 42px; height: 100%; text-align: center; font-size: 13px; border: 1px solid #ddd; border-left: none; border-right: none; padding: 0;">
                            <button class="btn btn-default bootstrap-touchspin-up"
                                    data-article-id="${articleId}"
                                    style="width: 26px; height: 100%; padding: 0; font-size: 13px; background-color: #f8f9fa; color: #333; border: 1px solid #ddd; border-radius: 0 4px 4px 0;">
                                <i class="ti-plus" style="font-size: 11px;"></i>
                            </button>
                        </div>
                    </div>
                    <h5 class="price text-primary mb-0" style="font-size: 16px; font-weight: 600;">
                        ${prixTotalLigne} ‚Ç¨
                    </h5>
                </div>
            </div>
        </div>`;
}


    // 9. Fonction attachCartEventListeners (d√©finie globalement)
// Fonction globale pour attacher des √©v√©nements aux √©l√©ments du panier
window.attachCartEventListeners = function () {
    // Attacher des √©v√©nements aux boutons "Supprimer un article"
    document.querySelectorAll('.remove-item').forEach(button => {
        button.addEventListener('click', function () {
            const articleId = this.getAttribute('data-article-id');
            if (articleId) {
                removeItemFromCart(articleId);
                console.log(`Article retir√© du panier : ${articleId}`); // Log de d√©bogage
            } else {
                console.error('Erreur : ID de l\'article non trouv√© pour la suppression.');
            }
        });
    });

    // Attacher des √©v√©nements aux boutons "Augmenter la quantit√©"
    document.querySelectorAll('.bootstrap-touchspin-up').forEach(button => {
        button.addEventListener('click', function () {
            const articleId = this.getAttribute('data-article-id');
            if (articleId) {
                changeQuantity(articleId, 1);
                console.log(`Augmentation de la quantit√© pour l'article : ${articleId}`); // Log de d√©bogage
            } else {
                console.error('Erreur : ID de l\'article non trouv√© pour augmenter la quantit√©.');
            }
        });
    });

    // Attacher des √©v√©nements aux boutons "Diminuer la quantit√©"
    document.querySelectorAll('.bootstrap-touchspin-down').forEach(button => {
        button.addEventListener('click', function () {
            const articleId = this.getAttribute('data-article-id');
            if (articleId) {
                changeQuantity(articleId, -1);
                console.log(`Diminution de la quantit√© pour l'article : ${articleId}`); // Log de d√©bogage
            } else {
                console.error('Erreur : ID de l\'article non trouv√© pour diminuer la quantit√©.');
            }
        });
    });

    console.log('√âcouteurs d\'√©v√©nements attach√©s aux √©l√©ments du panier.'); // Log de d√©bogage
};


window.updateInvoiceDetails = function (totals, codePromo = null) {
    const invoiceDetails = document.getElementById('invoice-details');

    // Vider les d√©tails actuels de la facture
    invoiceDetails.innerHTML = '';

    // G√©rer l'affichage de la r√©duction si applicable
    let reductionHtml = '';
    if (totals.reduction && parseFloat(totals.reduction) > 0 && codePromo) {
        reductionHtml = `
            <div style="display: flex; justify-content: space-between;">
                <p style="font-size: 16px;">R√©duction (${codePromo.code}):</p>
                <p class="text-primary" style="font-size: 16px; font-weight: bold;">-${parseFloat(totals.reduction).toFixed(2)} ‚Ç¨</p>
            </div>
        `;
    }

    // Construire les d√©tails de la facture
    invoiceDetails.innerHTML = `
        <hr style="border: none; border-top: 1px dashed #ccc; margin: 10px 0;">
        <div style="display: flex; justify-content: space-between;">
            <p style="font-size: 16px; font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;">Sous-total :</p>
            <p class="text-primary" style="font-size: 16px; font-weight: bold;">${parseFloat(totals.sous_total).toFixed(2)} ‚Ç¨</p>
        </div>
        ${reductionHtml}

        <div style="display: flex; justify-content: space-between;">
            <p style="font-size: 16px;">Frais de livraison :</p>
            <p class="text-primary" style="font-size: 16px; font-weight: bold;">${parseFloat(totals.frais_livraison).toFixed(2)} ‚Ç¨</p>
        </div>

        <hr style="border: none; border-top: 1px solid #ccc; margin: 10px 0;">

        <div style="display: flex; justify-content: space-between;">
            <p style="font-size: 18px;">Total TTC :</p>
            <p class="text-primary" style="font-size: 18px; font-weight: bold;">${parseFloat(totals.prix_total).toFixed(2)} ‚Ç¨</p>
        </div>
    `;

    console.log("D√©tails de la facture mis √† jour"); // Log de d√©bogage
};


    // 11. Fonction loadCartItems (d√©finie globalement)
// Fonction globale pour charger les articles du panier
window.loadCartItems = function () {
    fetch('/panier/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Donn√©es du panier r√©cup√©r√©es:', data); // Log de d√©bogage

            // V√©rifier si le panier contient des articles
            if (data.cart_items && data.cart_items.length > 0) {
                updateCartDisplay(data.cart_items, data.totals, data.code_promo);
            } else {
                const cartContainer = document.getElementById('cart-items');
                if (cartContainer) {
                    cartContainer.innerHTML = '<p>Votre panier est vide.</p>';
                } else {
                    console.error("√âl√©ment 'cart-items' introuvable dans le DOM.");
                }
                console.log("Panier vide"); // Log de d√©bogage
            }
        })
        .catch(error => {
            console.error('Erreur lors de la r√©cup√©ration des articles du panier :', error);
        });
};


    // 12. Fonction removeItemFromCart (d√©finie globalement)
// Fonction globale pour supprimer un article du panier
window.removeItemFromCart = function (articleId) {
    console.log(`Suppression de l'article du panier : ${articleId}`); // Log de d√©bogage

    // R√©initialiser le message de code promo
    const messageContainer = document.getElementById('code-promo-message');
    if (messageContainer) {
        messageContainer.innerHTML = '';
        messageContainer.style.display = 'none';
    } else {
        console.warn("√âl√©ment 'code-promo-message' introuvable dans le DOM.");
    }

    // Effectuer une requ√™te POST pour supprimer l'article
    fetch('/remove_item_from_cart/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken') // R√©cup√©rer le token CSRF
        },
        body: JSON.stringify({ article_id: articleId })
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Mettre √† jour l'affichage du panier
                updateCartDisplay(data.cart_items, data.totals, data.code_promo);
                console.log("Article retir√© avec succ√®s du panier."); // Log de d√©bogage
            } else {
                console.error(`Erreur lors de la suppression de l'article : ${data.message}`);
            }
        })
        .catch(error => {
            console.error('Erreur lors de la requ√™te de suppression :', error);
        });
};


    // 13. Fonction changeQuantity (d√©finie globalement)
// Fonction globale pour changer la quantit√© d'un article dans le panier
window.changeQuantity = function (articleId, delta) {
    console.log(`Changement de quantit√© pour l'article : ${articleId}, delta : ${delta}`); // Log de d√©bogage

    // Effectuer une requ√™te POST pour mettre √† jour la quantit√©
    fetch('/update_quantity/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken') // R√©cup√©rer le token CSRF
        },
        body: JSON.stringify({
            article_id: articleId,
            delta: delta
        })
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Mettre √† jour l'affichage du panier
                updateCartDisplay(data.cart_items, data.totals, data.code_promo);
                console.log("Quantit√© mise √† jour avec succ√®s."); // Log de d√©bogage
            } else {
                console.error(`Erreur lors de la mise √† jour de la quantit√© : ${data.message}`);
            }
        })
        .catch(error => {
            console.error('Erreur lors de la requ√™te de mise √† jour de la quantit√© :', error);
        });
};


    // 14. Gestion du Formulaire Code Promo (d√©finie globalement)
// Fonction globale pour g√©rer le formulaire du code promo
window.handleCodePromo = function () {
    const codePromoForm = document.getElementById('code-promo-form');

    if (!codePromoForm) {
        console.error("√âl√©ment 'code-promo-form' introuvable dans le DOM.");
        return;
    }

    codePromoForm.addEventListener('submit', function (event) {
        event.preventDefault();

        const codePromoInput = document.getElementById('code_promo_input');
        const messageContainer = document.getElementById('code-promo-message');

        if (!codePromoInput) {
            console.error("√âl√©ment 'code_promo_input' introuvable dans le DOM.");
            return;
        }

        const codePromo = codePromoInput.value.trim();
        console.log(`Code promo soumis : ${codePromo}`); // Log de d√©bogage

        fetch('/appliquer_code_promo/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'), // R√©cup√©rer le token CSRF
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ code_promo: codePromo })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!messageContainer) {
                    console.error("√âl√©ment 'code-promo-message' introuvable dans le DOM.");
                    return;
                }

                if (data.success) {
                    // Mettre √† jour l'affichage du panier et afficher un message de succ√®s
                    updateCartDisplay(data.cart_items, data.totals, data.code_promo);
                    messageContainer.innerHTML = '<span class="text-success">Code promo appliqu√© avec succ√®s.</span>';
                    messageContainer.style.display = 'block';
                    console.log("Code promo appliqu√© avec succ√®s."); // Log de d√©bogage
                } else {
                    // Afficher un message d'erreur
                    messageContainer.innerHTML = `<span class="text-danger">Erreur : ${data.message}</span>`;
                    messageContainer.style.display = 'block';
                    console.error(`Erreur lors de l'application du code promo : ${data.message}`);
                }
            })
            .catch(error => {
                console.error("Erreur lors de l'application du code promo :", error);
                if (messageContainer) {
                    messageContainer.innerHTML = '<span class="text-danger">Une erreur est survenue. Veuillez r√©essayer.</span>';
                    messageContainer.style.display = 'block';
                }
            });
    });
};


// R√©cup√©ration du cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function getCSRFToken() {
    const name = 'csrftoken';
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + '=')) {
            return decodeURIComponent(cookie.substring(name.length + 1));
        }
    }
    return '';
}


// Gestion de Stripe
window.handleStripe = function () {
    if (typeof Stripe === 'undefined') {
        console.error("Stripe.js n'a pas √©t√© charg√©.");
        return;
    }

    const stripe = Stripe('pk_live_51Q4fHlEnEVSBT8EnZkQeWNZW7BGil8WZY6aclgErBnfGT4B9CJk3YXHLcTRzW3ltz8KU5E2fjLTtYfeYymbfIWsD00M15tPewz');
    const submitClientInfoButton = document.getElementById('submitClientInfo');
    if (!submitClientInfoButton) {
        console.error("Bouton 'submitClientInfo' introuvable.");
        return;
    }

    const choixPaiementModalEl = document.getElementById('choixPaiementModal');
    const choixPaiementModal = new bootstrap.Modal(choixPaiementModalEl);
    const confirmerPaiementBtn = document.getElementById('confirmerPaiementBtn');
    const moyenPaiementContainer = document.getElementById('paiementOptions');

    function collectClientInfo() {
        const formClient = document.getElementById('clientInfoForm');
        if (!formClient.checkValidity()) {
            formClient.reportValidity();
            return null;
        }

        return {
            nom: document.getElementById('nom').value || '',
            prenom: document.getElementById('prenom').value || '',
            societe: document.getElementById('societe').value || '',
            numero_telephone: document.getElementById('numero_telephone').value || '',
            email: document.getElementById('email').value || '',
            adresse_livraison: document.getElementById('adresse_livraison').value || '',
            adresse_facturation: document.getElementById('adresse_facturation').value || '',
            message_chef: document.getElementById('message_chef').value || '',
            message_livreur: document.getElementById('message_livreur').value || '',
            consent_cookies: document.getElementById('consent_cookies').checked,
            consent_sms: document.getElementById('consent_sms').checked,
            consent_email: document.getElementById('consent_email').checked,
            factureSansDetail: document.getElementById('factureSansDetail').checked,


        };
    }


    function afficherMoyensPaiement(paiements, premiereCommande = false) {
    moyenPaiementContainer.innerHTML = '';

    const labels = {
        'stripe': "Carte Bancaire",
        'especes_livraison': "Esp√®ces √† la livraison",
        'ticket_livraison': "Ticket restaurant √† la livraison",
        'especes_retrait': "Esp√®ces au retrait",
        'ticket_retrait': "Ticket restaurant au retrait",
    };

    const descriptions = {
        'stripe': { text: "Paiement 100% s√©curis√© en ligne", alert: false },
        'especes_livraison': { text: "Merci d'essayer de faire l'appoint", alert: false },
        'ticket_livraison': { text: "+1‚ÄØ‚Ç¨ de frais de gestion", alert: true },
        'especes_retrait': { text: "", alert: false },
        'ticket_retrait': { text: "+1‚ÄØ‚Ç¨ de frais de gestion", alert: true },
    };

    const icons = {
        'stripe': `
            <div>
                <img src="https://img.icons8.com/color/96/visa.png" alt="Visa" style="height: 36px; margin-right: 5px;">
                <img src="https://img.icons8.com/color/96/mastercard-logo.png" alt="Mastercard" style="height: 36px;">
            </div>
        `,
        'especes_livraison': `<img src="https://img.icons8.com/color/96/cash-in-hand.png" alt="Esp√®ces">`,
        'ticket_livraison': `<img src="/static/assets/flaticon/logosTR.png" alt="Ticket restaurant">`,
        'especes_retrait': `<img src="https://img.icons8.com/color/96/cash-in-hand.png" alt="Esp√®ces">`,
        'ticket_retrait': `<img src="/static/assets/flaticon/logosTR.png" alt="Ticket restaurant">`,
    };

    paiements.forEach((paiement, index) => {
        const id = paiement.id;
        const labelTitleText = labels[id] || paiement.label;
        const iconHtml = icons[id] || '';
        const isDisabled = paiement.disabled || (premiereCommande && id !== 'stripe');

        const div = document.createElement('div');
        div.classList.add('moyen-paiement-item');
        if (isDisabled) div.classList.add('disabled');

        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'moyen_paiement';
        radio.id = 'paiement_' + id;
        radio.value = id;
        radio.required = true;
        radio.disabled = isDisabled;
        if (!isDisabled && (index === 0 || id === 'stripe')) {
            radio.checked = true;
        }

        const iconContainer = document.createElement('div');
        iconContainer.classList.add('logo-container');
        iconContainer.innerHTML = iconHtml;

        const label = document.createElement('label');
        label.setAttribute('for', radio.id);
        label.classList.add('moyen-paiement-label');

        const labelTitle = document.createElement('div');
        labelTitle.classList.add('label-title');
        labelTitle.textContent = labelTitleText;
        label.appendChild(labelTitle);

        const desc = descriptions[id];
        if (desc && desc.text) {
            const labelDesc = document.createElement('div');
            labelDesc.textContent = desc.alert ? `‚ö† ${desc.text}` : desc.text;
            labelDesc.classList.add('label-description');
            if (desc.alert) labelDesc.classList.add('text-orange');
            label.appendChild(labelDesc);
        }

        if (id === 'ticket_livraison' || id === 'ticket_retrait') {
            const mention = document.createElement('small');
            mention.classList.add('text-muted');
            mention.style.display = 'block';
            mention.style.marginTop = '6px';
            mention.innerHTML = `
                ‚úÖ Nous acceptons les cartes ou titres Ticket Restaurant Edenred, Pluxee (ex-Sodexo), Swile, Bimpli (ex-Apetiz) et UpD√©jeuner.
            `;
            label.appendChild(mention);
        }

        if (isDisabled) {
            const info = document.createElement('div');
            info.classList.add('disabled-text');
            info.textContent = "Disponible √† partir de la 2·µâ commande";
            label.appendChild(document.createElement('br'));
            label.appendChild(info);
        }

        div.appendChild(radio);
        div.appendChild(iconContainer);
        div.appendChild(label);
        moyenPaiementContainer.appendChild(div);
    });
}













async function validerInfosClient() {
    // R√©cup√©ration des infos client
    const data = collectClientInfo();
    if (!data) return;

    // V√©rification consentement
    if (!document.getElementById('consent_sms').checked || !document.getElementById('consent_email').checked) {
        alert("Nous avons besoin de votre consentement pour vous contacter.");
        return;
    }

    // V√©rification du panier minimum avant de poursuivre
    try {
        const resp = await fetch('/get_panier_minimum/');
        const d = await resp.json();

        if (d.error) {
            alert("Erreur lors de la v√©rification du panier minimum.");
            console.error(d.error);
            return;
        }

        if (d.montant_panier < d.panier_minimum) {
            // Ferme la modal infos client
            $('#validerCommandeModal').modal('hide');

            // Affiche le warning panier
            const warningDiv = document.getElementById('panier-warning');
            if (warningDiv) {
                warningDiv.textContent = `‚ö†Ô∏è Le minimum de commande pour ${d.ville} est de ${d.panier_minimum.toFixed(2)} ‚Ç¨. Votre panier est de ${d.montant_panier.toFixed(2)} ‚Ç¨.`;
                warningDiv.style.display = 'block';
            }

            // Scroll vers les plats √† compl√©ter
            const plats = document.getElementById('masonry');
            if (plats) plats.scrollIntoView({ behavior: 'smooth' });

            return;
        }
    } catch (e) {
        console.error("Erreur panier minimum :", e);
        alert("Une erreur est survenue lors de la v√©rification.");
        return;
    }

    // Si tout est ok, envoie la commande
    try {
        const response = await fetch('/valider_commande/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        });

        const resData = await response.json();
        if (!response.ok) throw resData;

        const premiereCommande = resData.premiere_commande === true;
        afficherMoyensPaiement(resData.paiements_possibles, premiereCommande);
        window._stripeSessionId = resData.stripe_session_id || null;
        choixPaiementModal.show();
    } catch (error) {
        alert(error.error || "Erreur lors de la validation de la commande.");
        console.error(error);
    }
}

let enCoursDeTraitement = false;


async function confirmerPaiement() {
    console.log('=== D√âBUT CONFIRMER PAIEMENT ===');
    
    if (enCoursDeTraitement) {
        console.warn("Une tentative de paiement est d√©j√† en cours.");
        return;
    }
    enCoursDeTraitement = true;
    confirmerPaiementBtn.disabled = true;

    const formPaiement = document.getElementById('formChoixPaiement');
    if (!formPaiement.checkValidity()) {
        formPaiement.reportValidity();
        enCoursDeTraitement = false;
        confirmerPaiementBtn.disabled = false;
        return;
    }

    const moyenPaiement = formPaiement.moyen_paiement.value;
    console.log('Moyen de paiement s√©lectionn√©:', moyenPaiement);

    // R√©cup√©rer les donn√©es client
    const nom = document.getElementById('nom').value.trim();
    const prenom = document.getElementById('prenom').value.trim();
    const societe = document.getElementById('societe').value.trim();
    const email = document.getElementById('email').value.trim().toLowerCase();
    const numero_telephone = document.getElementById('numero_telephone').value.trim();
    const adresse_facturation = document.getElementById('adresse_facturation').value.trim();
    const factureSansDetail = document.getElementById('factureSansDetail').checked;

    if (!nom || !prenom || !email || !numero_telephone) {
        alert("Merci de remplir tous les champs client obligatoires.");
        enCoursDeTraitement = false;
        confirmerPaiementBtn.disabled = false;
        return;
    }

    const payload = {
        moyen_paiement: moyenPaiement,
        nom,
        prenom,
        societe,
        email,
        numero_telephone,
        factureSansDetail, 
        adresse_facturation
    };

    console.log('Payload envoy√© au serveur:', payload);

    try {
        if (moyenPaiement === 'stripe') {
            // V√âRIFICATION STRIPE CRITIQUE
            if (typeof stripe === 'undefined' || !stripe.redirectToCheckout) {
                throw new Error('Stripe non initialis√© correctement. V√©rifiez la console.');
            }

            console.log('üîÑ Envoi de la requ√™te √† /valider_commande/...');
            
            const response = await fetch('/valider_commande/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(payload)
            });

            console.log('üì® R√©ponse serveur re√ßue - Status:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå Erreur serveur d√©taill√©e:', errorText);
                throw new Error(`Erreur HTTP: ${response.status} - ${errorText}`);
            }
            
            const res = await response.json();
            console.log('‚úÖ R√©ponse JSON du serveur:', res);

            if (!res.success) {
                throw new Error(res.message || "Erreur lors de la cr√©ation de la session Stripe");
            }

            if (!res.stripe_session_id) {
                throw new Error("Session ID Stripe manquant dans la r√©ponse");
            }

            console.log('üé´ Session Stripe ID re√ßu:', res.stripe_session_id);
            console.log('üîÑ Redirection vers Stripe...');
            
            // üéØ CORRECTION : redirectToCheckout est SYNCHRONE
            const result = stripe.redirectToCheckout({ 
                sessionId: res.stripe_session_id 
            });

            if (result.error) {
                console.error('‚ùå Erreur Stripe redirectToCheckout:', result.error);
                throw new Error(`Erreur Stripe: ${result.error.message}`);
            }

            // ‚úÖ Redirection initi√©e - le navigateur va quitter la page
            console.log('‚úÖ Redirection Stripe initi√©e avec succ√®s');
            return;

        } else {
            // Traitement pour les autres moyens de paiement
            console.log('Traitement autre moyen de paiement:', moyenPaiement);
            const response = await fetch('/confirmer_commande/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
            const res = await response.json();

            if (res.success && res.commande_id) {
                window.location.href = `/confirmation_commande/${res.commande_id}/`;
            } else {
                alert('Erreur lors de la confirmation de la commande : ' + (res.message || ''));
            }
        }

    } catch (error) {
        console.error("‚ùå Erreur compl√®te:", error);
        console.error("Stack trace:", error.stack);
        alert("Erreur: " + error.message);
    } finally {
        enCoursDeTraitement = false;
        confirmerPaiementBtn.disabled = false;
        console.log('=== FIN CONFIRMER PAIEMENT ===');
    }
}


// Remplacement du bouton pour √©viter les handlers multiples
const oldBtn = document.getElementById('submitClientInfo');
const newBtn = oldBtn.cloneNode(true);
oldBtn.parentNode.replaceChild(newBtn, oldBtn);
newBtn.addEventListener('click', validerInfosClient);
confirmerPaiementBtn.addEventListener('click', confirmerPaiement);



};



window.handleValiderCommandeModal = function () {
    const validerCommandeModal = document.getElementById('validerCommandeModal');
    const validerCommandeBtn = document.getElementById('validerCommandeBtn');

    if (!validerCommandeModal) {
        console.error("√âl√©ment 'validerCommandeModal' introuvable dans le DOM.");
        return;
    }
    if (!validerCommandeBtn) {
        console.error("Bouton 'validerCommandeBtn' introuvable dans le DOM.");
        return;
    }

    const modal = new bootstrap.Modal(validerCommandeModal);

    // Supprime tous les anciens handlers click pour √©viter les doublons
    validerCommandeBtn.replaceWith(validerCommandeBtn.cloneNode(true));
    const newBtn = document.getElementById('validerCommandeBtn');

    newBtn.addEventListener('click', async () => {
        try {
            const response = await fetch('/get_panier_minimum/');
            const data = await response.json();

            if (data.error) {
                alert("Erreur : " + data.error);
                return;
            }

            const montant = parseFloat(data.montant_panier);
            const minimum = parseFloat(data.panier_minimum);

            if (montant < minimum) {
                alert(`‚ö†Ô∏è Le minimum de commande pour ${data.ville} est de ${minimum.toFixed(2)} ‚Ç¨. Votre panier est de ${montant.toFixed(2)} ‚Ç¨.`);
                return;
            }

            modal.show();

        } catch (e) {
            console.error("Erreur pendant la v√©rification du panier minimum :", e);
            alert("Erreur lors de la v√©rification du panier.");
        }
    });

    validerCommandeModal.addEventListener('show.bs.modal', function () {


        console.log("Modal de validation de commande affich√©.");

        fetch('/get_adresse_livraison/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
            .then(response => {
                if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const adresseLivraisonField = document.getElementById('adresse_livraison');
                    if (adresseLivraisonField) {
                        adresseLivraisonField.value = data.adresse_livraison;
                        console.log("Adresse de livraison r√©cup√©r√©e :", data.adresse_livraison);
                    } else {
                        console.error("Champ 'adresse_livraison' introuvable dans le DOM.");
                    }
                } else {
                    console.error("Erreur r√©cup√©ration adresse :", data.message || "Aucune adresse.");
                }
            })
            .catch(error => {
                console.error("Erreur requ√™te adresse livraison :", error);
            });
    });
};



// Initialisation globale
document.addEventListener('DOMContentLoaded', () => {
    window.handleStripe();
    window.handleValiderCommandeModal();
});


// 17. Initialisation au chargement du DOM (d√©finie globalement)
window.initialize = function() {
    // Charger le panier
    loadCartItems();

    // Masquer les containers LightGallery
    const hideLightGalleryContainers = () => {
        const lgContainers = document.querySelectorAll('.lg-container');
        lgContainers.forEach(container => {
            container.style.display = 'none';
            console.log("LightGallery container masqu√©");
        });
    };
    hideLightGalleryContainers();

    // Observer pour masquer les nouveaux containers LightGallery
    const observerLG = new MutationObserver(function(mutationsList) {
        for (const mutation of mutationsList) {
            if (mutation.addedNodes.length) {
                mutation.addedNodes.forEach(node => {
                    if (node.classList && node.classList.contains('lg-container')) {
                        node.style.display = 'none';
                        console.log("LightGallery container masqu√© apr√®s ajout dynamique");
                    }
                });
            }
        }
    });
    observerLG.observe(document.body, { childList: true, subtree: true });

    // Gestion de l'Adresse de Facturation
    const billingCheckbox = document.getElementById('differentBillingAddress');
    const billingAddressContainer = document.getElementById('adresseFacturationContainer');
    
    if (billingCheckbox && billingAddressContainer) {
        billingCheckbox.addEventListener('change', function() {
            billingAddressContainer.style.display = this.checked ? 'block' : 'none';
            console.log(`Adresse de facturation ${this.checked ? 'affich√©e' : 'masqu√©e'}`);
        });
    } else {
        console.warn("√âl√©ments de gestion d'adresse de facturation introuvables.");
    }

    // Gestion des Champs de Message pour le Chef et le Livreur
    const enableMessagesCheckbox = document.getElementById('enableMessages');
    const messageChefContainer = document.getElementById('messageChefContainer');
    const messageLivreurContainer = document.getElementById('messageLivreurContainer');

    if (enableMessagesCheckbox && messageChefContainer && messageLivreurContainer) {
        enableMessagesCheckbox.addEventListener('change', function() {
            const displayStyle = this.checked ? 'block' : 'none';
            messageChefContainer.style.display = displayStyle;
            messageLivreurContainer.style.display = displayStyle;
            console.log(`Champs de message ${this.checked ? 'affich√©s' : 'masqu√©s'}`);
        });
    } else {
        console.warn("√âl√©ments de gestion des messages introuvables.");
    }

    // Ajout de la Classe 'show' au Filtre du Magasin
    const shopFilter = document.querySelector('.shop-filter');
    if (shopFilter) {
        shopFilter.classList.add('show');
        console.log("Classe 'show' ajout√©e √† 'shop-filter'.");
    } else {
        console.warn("√âl√©ment 'shop-filter' introuvable.");
    }

    // Gestion de la Visibilit√© du Panier avec le Bouton de Bascule
    const toggleCartBtn = document.getElementById('toggle-cart-btn');
    const cartSidebar = document.querySelector('.side-bar');
    if (toggleCartBtn && cartSidebar) {
        toggleCartBtn.addEventListener('click', function() {
            cartSidebar.classList.toggle('active');
            console.log("√âtat du panier :", cartSidebar.classList.contains('active') ? "Visible" : "Masqu√©");
        });
    } else {
        console.warn("√âl√©ments de bascule du panier introuvables.");
    }

    // V√©rification de la Pr√©sence du Bouton de Panier Mobile
    const mobileCartButton = document.getElementById("mobile-cart-button");
    if (mobileCartButton) {
        console.log("Bouton de panier mobile d√©tect√©.");
    } else {
        console.warn("Bouton 'mobile-cart-button' introuvable.");
    }

    // Gestion de la Visibilit√© de l'Instruction de Fermeture
    const closeInstruction = document.querySelector('.close-instruction');
    if (closeInstruction) {
        // Appliquer la visibilit√© initiale
        updateCloseInstructionVisibility();

        // √âcouter les changements de taille de la fen√™tre
        window.addEventListener('resize', updateCloseInstructionVisibility);
    } else {
        console.warn("√âl√©ment '.close-instruction' introuvable.");
    }

    function updateCloseInstructionVisibility() {
        if (window.innerWidth <= 991.8) {
            closeInstruction.style.display = 'block';
            console.log("Instruction de fermeture affich√©e (mobile)");
        } else {
            closeInstruction.style.display = 'none';
            console.log("Instruction de fermeture masqu√©e (desktop)");
        }
    }

    // Suppression des Boutons Ind√©sirables
    function removeButtons() {
        document.querySelectorAll('.DZ-bt-support-now, .DZ-bt-buy-now').forEach(button => {
            button.remove();
            console.log("Bouton ind√©sirable supprim√©");
        });
    }
    removeButtons();

    const observerButtons = new MutationObserver(removeButtons);
    observerButtons.observe(document.body, { childList: true, subtree: true });

    // Gestion des √âv√©nements de la Sidebar du Panier
    const validerCommandeBtn = document.getElementById('validerCommandeBtn'); 
    const openCartBtn = document.getElementById('open-cart-btn');
    const closeCartBtn = document.querySelector('.panel-close-btn'); 

    console.log("√âl√©ments du panier:", {
        cartSidebar: cartSidebar,
        validerCommandeBtn: validerCommandeBtn,
        openCartBtn: openCartBtn,
        closeCartBtn: closeCartBtn
    });

    if (!cartSidebar || !validerCommandeBtn || !openCartBtn || !closeCartBtn) {
        console.error("√âl√©ments essentiels du panier introuvables.");
        return;
    }

    // ‚úÖ SUPPRESSION DU SYST√àME DE DONN√âES STATIQUES
    // Plus de chargement depuis plats-data pour √©viter les doublons
    console.log("Syst√®me de chargement AJAX uniquement - pas de donn√©es statiques");

    // Initialiser les gestionnaires suppl√©mentaires
    handleCodePromo();
    handleStripe();
    handleValiderCommandeModal();

    console.log("Initialisation termin√©e - pr√™t pour le chargement AJAX des plats");
};

// Appel de la fonction d'initialisation une fois le DOM compl√®tement charg√©
document.addEventListener('DOMContentLoaded', window.initialize);

// 17. Initialisation au chargement du DOM
window.initialize = function () {
    // Charger les √©l√©ments du panier
    loadCartItems();

    // Masquer les containers LightGallery
    const hideLightGalleryContainers = () => {
        document.querySelectorAll('.lg-container').forEach(container => {
            container.style.display = 'none';
            console.log("LightGallery container masqu√©");
        });
    };
    hideLightGalleryContainers();

    const observerLG = new MutationObserver(mutationsList => {
        mutationsList.forEach(mutation => {
            mutation.addedNodes.forEach(node => {
                if (node.classList && node.classList.contains('lg-container')) {
                    node.style.display = 'none';
                    console.log("LightGallery container masqu√© apr√®s ajout dynamique");
                }
            });
        });
    });

    observerLG.observe(document.body, { childList: true, subtree: true });

    // Gestion de l'adresse de facturation
    const billingCheckbox = document.getElementById('differentBillingAddress');
    const billingAddressContainer = document.getElementById('adresseFacturationContainer');

    if (billingCheckbox && billingAddressContainer) {
        billingCheckbox.addEventListener('change', function () {
            billingAddressContainer.style.display = this.checked ? 'block' : 'none';
            console.log(`Adresse de facturation ${this.checked ? 'affich√©e' : 'masqu√©e'}`);
        });
    }

    // Gestion des champs de message pour le chef et le livreur
    const enableMessagesCheckbox = document.getElementById('enableMessages');
    const messageChefContainer = document.getElementById('messageChefContainer');
    const messageLivreurContainer = document.getElementById('messageLivreurContainer');

    if (enableMessagesCheckbox && messageChefContainer && messageLivreurContainer) {
        enableMessagesCheckbox.addEventListener('change', function () {
            const displayStyle = this.checked ? 'block' : 'none';
            messageChefContainer.style.display = displayStyle;
            messageLivreurContainer.style.display = displayStyle;
            console.log(`Champs de message ${this.checked ? 'affich√©s' : 'masqu√©s'}`);
        });
    }

    // Gestion de la visibilit√© du panier via le bouton de bascule
    const toggleCartBtn = document.getElementById('toggle-cart-btn');
    const cartSidebar = document.querySelector('.side-bar');

    if (toggleCartBtn && cartSidebar) {
        toggleCartBtn.addEventListener('click', function () {
            cartSidebar.classList.toggle('show');
            console.log(`Panier ${cartSidebar.classList.contains('show') ? 'visible' : 'masqu√©'}`);
        });
    }

    // Initialisation des √©v√©nements
    handleCodePromo();
    handleStripe();
    handleValiderCommandeModal();

// Gestion du formulaire de salade personnalis√©e
document.getElementById('validerSaladeBtn').addEventListener('click', function () {
    const form = document.getElementById('saladeForm');
    const formData = new FormData(form);

    const data = {
        plat_id: 'salade_personnalisee', // Code unique
        base: formData.get('base'),  // ID unique de l'ingr√©dient base
        sauce: formData.get('sauce'), // ID unique de la sauce
        proteines: formData.getAll('proteine'), // liste d‚ÄôIDs
        garnitures: formData.getAll('garniture'), // liste d‚ÄôIDs
        toppings: formData.getAll('topping'),     // liste d‚ÄôIDs
        supplements: formData.getAll('supplement') // Ajout√© au cas o√π
    };

    // ‚úÖ Log complet avant envoi
    console.log("üìù Donn√©es salade envoy√©es :", data);

    fetch('/ajouter_salade_personnalisee/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        console.log('‚úÖ R√©ponse apr√®s ajout salade perso :', data);

        if (data.success) {
            updateCartDisplay(data.cart_items, data.totals, data.code_promo);
            $('#composeSaladeModal').modal('hide');

            // Proposer boissons/desserts automatiquement
            proposerBoissons();
        } else {
            alert(data.error || 'Une erreur est survenue.');
        }
    })
    .catch(error => {
        alert('‚ùå Erreur lors de l‚Äôajout de la salade personnalis√©e.');
        console.error(error);
    });
});





};

// Initialisation apr√®s le chargement du DOM
document.addEventListener('DOMContentLoaded', window.initialize);



// Fonction pour r√©cup√©rer le cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // V√©rifier si ce cookie commence par le nom d√©sir√©
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}



// Gestion des clics sur les lignes de formule couscous
document.addEventListener('DOMContentLoaded', function() {
    // S√©lectionner tous les √©l√©ments de formule couscous
    const formuleItems = document.querySelectorAll('.formule-couscous-item');
    
    formuleItems.forEach(item => {
        // G√©rer le clic sur toute la ligne
        item.addEventListener('click', function(e) {
            // Ne pas d√©clencher si on clique directement sur le radio
            if (e.target.type !== 'radio') {
                const radio = this.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = true;
                    
                    // D√©clencher l'√©v√©nement change pour mettre √† jour l'interface
                    const event = new Event('change', { bubbles: true });
                    radio.dispatchEvent(event);
                    
                    // Ajouter un style visuel pour la s√©lection
                    updateFormuleSelectionStyle();
                }
            }
        });

        // G√©rer le changement de s√©lection pour mettre √† jour le style
        const radio = item.querySelector('input[type="radio"]');
        if (radio) {
            radio.addEventListener('change', function() {
                updateFormuleSelectionStyle();
            });
        }
    });

    // Fonction pour mettre √† jour le style visuel des √©l√©ments s√©lectionn√©s
    function updateFormuleSelectionStyle() {
        formuleItems.forEach(item => {
            const radio = item.querySelector('input[type="radio"]');
            if (radio && radio.checked) {
                item.style.backgroundColor = '#f8f9fa';
                item.style.borderRadius = '4px';
            } else {
                item.style.backgroundColor = '';
                item.style.borderRadius = '';
            }
        });
    }

    // Appliquer le style initial
    updateFormuleSelectionStyle();
});



document.addEventListener('DOMContentLoaded', function() {
    const maxBase = 1;
    const maxProteine = 1;
    const maxGarnitures = 5;
    const maxToppings = 2;
    const maxSauce = 1;

    function limitCheckboxSelection(containerSelector, maxSelected) {
    const container = document.querySelector(containerSelector);
    if (!container) return;

    container.addEventListener('change', function(e) {
        const checkboxes = container.querySelectorAll('input[type="checkbox"]');
        const checked = Array.from(checkboxes).filter(cb => cb.checked);
        if (checked.length >= maxSelected) {
            checkboxes.forEach(cb => {
                if (!cb.checked) cb.disabled = true;
            });
        } else {
            checkboxes.forEach(cb => cb.disabled = false);
        }
    });
}

    limitCheckboxSelection('.base-container', maxBase);
    limitCheckboxSelection('.proteine-container', maxProteine);
    limitCheckboxSelection('.garniture-container', maxGarnitures);
    limitCheckboxSelection('.topping-container', maxToppings);
    limitCheckboxSelection('.sauce-container', maxSauce);
});

document.addEventListener('DOMContentLoaded', function () {
    var validerBtn = document.getElementById('validerCommandeBtn');
    if (validerBtn) {
        validerBtn.addEventListener('click', async function () {
            // 1. V√©rifie le panier minimum c√¥t√© serveur AVANT toute action
            try {
                const resp = await fetch('/get_panier_minimum/');
                const data = await resp.json();

                if (data.error) {
                    alert("Erreur lors de la v√©rification du panier minimum.");
                    return;
                }

                if (data.montant_panier < data.panier_minimum) {
                    // Affiche le warning panier
                    const warningDiv = document.getElementById('panier-warning');
                    if (warningDiv) {
                        warningDiv.textContent = `‚ö†Ô∏è Le minimum de commande pour ${data.ville} est de ${data.panier_minimum.toFixed(2)} ‚Ç¨. Votre panier est de ${data.montant_panier.toFixed(2)} ‚Ç¨.`;
                        warningDiv.style.display = 'block';
                    }
                    // Scroll vers les plats
                    const platsSection = document.getElementById('masonry');
                    if (platsSection) platsSection.scrollIntoView({ behavior: 'smooth' });
                    return; // STOP‚ÄØ: on n'ouvre pas la modal
                }

                // 2. Si montant OK, ferme le panier puis ouvre la modal infos client
                var closeBtn = document.querySelector('.panel-close-btn');
                if (closeBtn) closeBtn.click();

                setTimeout(function () {
                    var modal = new bootstrap.Modal(document.getElementById('validerCommandeModal'));
                    modal.show();
                }, 200);

            } catch (e) {
                alert("Erreur lors de la v√©rification du panier minimum.");
                console.error(e);
            }
        });
    }
});

function openMenuModal(menuId, nom, imageUrl, description, prix) {
    console.log("üü¢ openMenuModal appel√©e avec ID =", menuId);

    fetch(`/api/choix_menu/${menuId}/`)
        .then(response => {
            console.log("üì° Statut de la r√©ponse:", response.status);
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("=== ‚úÖ DONN√âES MENU COMPL√àTES ===");
            console.log("üì¶ Donn√©es re√ßues:", data);
            
            const container = document.getElementById("menu-modal-body");
            if (!container) {
                console.error("‚ùå Conteneur menu-modal-body introuvable");
                return;
            }
            
            container.innerHTML = "";
            
            let roles = [];
            if (data.choix && Array.isArray(data.choix)) {
                roles = data.choix;
                console.log(`‚úÖ ${roles.length} r√¥le(s) charg√©(s)`);
            }

            if (roles.length === 0) {
                const alert = document.createElement("div");
                alert.className = "alert alert-warning";
                alert.innerHTML = `
                    <h6>‚ö†Ô∏è Menu sans options configurables</h6>
                    <p>Ce menu ne propose pas de personnalisation.</p>
                `;
                container.appendChild(alert);
            }

            // üèóÔ∏è CONSTRUCTION DE L'INTERFACE COMPL√àTE
            let sectionsCrees = 0;

            // === 1. GESTION COUSCOUS PERSONNALIS√â ===
            const roleCouscous = roles.find(r => r.autorise_couscous_personnalise && r.viandes_possibles);
            if (roleCouscous) {
                console.log("üçõ Configuration couscous d√©tect√©e");
                const section = creerSectionCouscous(roleCouscous, data.accompagnements_couscous);
                container.appendChild(section);
                sectionsCrees++;
            }

            // === 2. GESTION DES AUTRES R√îLES ===
            roles.forEach(roleData => {
                if (roleData.autorise_couscous_personnalise) return;
                
                const section = creerSectionRoleStandard(roleData);
                if (section) {
                    container.appendChild(section);
                    sectionsCrees++;
                }
            });

            document.getElementById("menu-modal-title").innerText = nom;
            document.getElementById("menu-modal").dataset.menuId = menuId;
            
            console.log(`‚úÖ Modale pr√™te avec ${sectionsCrees} section(s)`);
            new bootstrap.Modal(document.getElementById("menu-modal")).show();

        })
        .catch(error => {
            console.error("‚ùå Erreur chargement menu:", error);
            const container = document.getElementById("menu-modal-body");
            if (container) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>Erreur de chargement</h6>
                        <p>Impossible de charger les options du menu.</p>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        });

    // üéØ FONCTIONS HELPER AVEC AFFICHAGE COMPLET DES PRIX
    
    function creerSectionCouscous(roleCouscous, accompagnements) {
        const section = document.createElement("div");
        section.className = "menu-section couscous-section";
        
        // === VIANDES ===
        const viandesSection = document.createElement("div");
        viandesSection.className = "form-group";
        
        const viandesDetails = document.createElement("details");
        viandesDetails.open = true;
        
        const maxViandes = roleCouscous.nombre_viandes_incluses || 1;
        viandesDetails.innerHTML = `
            <summary class="section-title">
                <strong>ü•© Viandes au choix</strong>
                <span class="badge bg-primary">${maxViandes} incluse(s)</span>
            </summary>
        `;
        
        const viandesContainer = document.createElement("div");
        viandesContainer.className = "options-grid";
        
        roleCouscous.viandes_possibles.forEach(viande => {
            const optionDiv = document.createElement("div");
            optionDiv.className = "option-item";
            
            const prixSupplement = parseFloat(viande.prix_supplement) || 0;
            const affichagePrix = prixSupplement > 0 ? 
                `<span class="prix-supplement text-success">+${prixSupplement.toFixed(2)}‚Ç¨</span>` : 
                '<span class="prix-inclus text-muted">Inclus</span>';
            
            optionDiv.innerHTML = `
                <div class="form-check">
                    <input type="checkbox" 
                           class="form-check-input viande-checkbox" 
                           name="viandes_couscous" 
                           value="${viande.id}" 
                           id="viande-${viande.id}">
                    <label class="form-check-label" for="viande-${viande.id}">
                        <span class="option-nom">${viande.nom}</span>
                        ${affichagePrix}
                    </label>
                </div>
            `;
            viandesContainer.appendChild(optionDiv);
        });
        
        viandesDetails.appendChild(viandesContainer);
        viandesSection.appendChild(viandesDetails);
        section.appendChild(viandesSection);
        
        viandesDetails.addEventListener("change", gererLimiteSelection.bind(null, 'viandes_couscous', maxViandes));
        
        // === ACCOMPAGNEMENTS COUSCOUS ===
        if (accompagnements && accompagnements.length > 0) {
            const accSection = document.createElement("div");
            accSection.className = "form-group mt-4";
            
            const accDetails = document.createElement("details");
            accDetails.open = true;
            accDetails.innerHTML = `
                <summary class="section-title">
                    <strong>üçü Accompagnements couscous</strong>
                    <span class="badge bg-success">Inclus</span>
                </summary>
            `;
            
            const accContainer = document.createElement("div");
            accContainer.className = "options-grid";
            
            accompagnements.forEach(acc => {
                const accDiv = document.createElement("div");
                accDiv.className = "option-item";
                
                // üÜï AFFICHAGE DES PRIX POUR LES ACCOMPAGNEMENTS
                const prixSupplement = parseFloat(acc.prix_supplement) || 0;
                const affichagePrix = prixSupplement > 0 ? 
                    `<span class="prix-supplement text-success">+${prixSupplement.toFixed(2)}‚Ç¨</span>` : 
                    '<span class="prix-inclus text-muted">Inclus</span>';
                
                accDiv.innerHTML = `
                    <div class="form-check">
                        <input type="checkbox" 
                               class="form-check-input" 
                               name="accompagnements_couscous" 
                               value="${acc.id}" 
                               id="acc-${acc.id}"
                               checked>
                        <label class="form-check-label" for="acc-${acc.id}">
                            <span class="option-nom">${acc.nom}</span>
                            ${affichagePrix}
                        </label>
                    </div>
                `;
                accContainer.appendChild(accDiv);
            });
            
            accDetails.appendChild(accContainer);
            accSection.appendChild(accDetails);
            section.appendChild(accSection);
        }
        
        return section;
    }
    
    function creerSectionRoleStandard(roleData) {
        const role = roleData.role;
        const plats = roleData.plats || [];
        
        if (plats.length === 0) return null;
        
        const section = document.createElement("div");
        section.className = "menu-section role-section";
        
        const details = document.createElement("details");
        details.open = true;
        
        const max = roleData.nombre_elements_inclus || 1;
        const labels = {
            'boisson': 'ü•§ Boisson',
            'dessert': 'üç∞ Dessert', 
            'entree': 'ü•ó Entr√©e',
            'accompagnement': 'üçü Accompagnement',
            'plat': 'üçΩÔ∏è Plat',
            'viande': 'ü•© Viande',
            'cookie': 'üç™ Cookie'
        };
        
        const roleLabel = labels[role] || `üì¶ ${role.charAt(0).toUpperCase() + role.slice(1)}`;
        details.innerHTML = `
            <summary class="section-title">
                <strong>${roleLabel}</strong>
                <span class="badge bg-primary">${max} inclus</span>
            </summary>
        `;
        
        const optionsContainer = document.createElement("div");
        optionsContainer.className = "options-grid";
        
        plats.forEach(plat => {
            const optionDiv = document.createElement("div");
            optionDiv.className = "option-item";
            
            // üÜï AFFICHAGE COMPLET DES PRIX
            const prixSupplement = parseFloat(plat.prix_supplement) || 0;
            const affichagePrix = prixSupplement > 0 ? 
                `<span class="prix-supplement text-success">+${prixSupplement.toFixed(2)}‚Ç¨</span>` : 
                '<span class="prix-inclus text-muted">Inclus</span>';
            
            optionDiv.innerHTML = `
                <div class="form-check">
                    <input type="checkbox" 
                           class="form-check-input" 
                           name="choix_${role}" 
                           value="${plat.id}" 
                           id="${role}-${plat.id}">
                    <label class="form-check-label" for="${role}-${plat.id}">
                        <span class="option-nom">${plat.nom}</span>
                        ${affichagePrix}
                    </label>
                </div>
            `;
            optionsContainer.appendChild(optionDiv);
        });
        
        details.appendChild(optionsContainer);
        section.appendChild(details);
        
        details.addEventListener("change", gererLimiteSelection.bind(null, `choix_${role}`, max));
        
        return section;
    }
    
    function gererLimiteSelection(nomGroupe, limiteMax) {
        const checkboxes = document.querySelectorAll(`input[name="${nomGroupe}"]`);
        const checked = document.querySelectorAll(`input[name="${nomGroupe}"]:checked`);
        
        checkboxes.forEach(cb => {
            cb.disabled = !cb.checked && checked.length >= limiteMax;
        });
    }
}

// Fonction helper pour afficher le message d'absence de viandes
function afficherMessageAucuneViande(container) {
    const noViandesMsg = document.createElement("div");
    noViandesMsg.classList.add("alert", "alert-warning", "mt-3");
    noViandesMsg.innerHTML = `
        <h6>‚ö†Ô∏è Aucune option viande disponible</h6>
        <p class="mb-1">Ce menu ne contient pas d'options viande configurables.</p>
        <small class="text-muted">Veuillez contacter le support si c'est une erreur.</small>
    `;
    container.appendChild(noViandesMsg);
}



// Fonction pour charger les burgers avec sous-cat√©gories - VERSION CORRIG√âE
window.loadBurgers = function() {
    console.log('Chargement des burgers avec sous-cat√©gories');
    
    const welcomePlaceholder = document.getElementById('welcome-placeholder');
    if (welcomePlaceholder) welcomePlaceholder.style.display = 'none';
    
    // Masquer la section plats normale
    const platsContainer = document.getElementById('masonry');
    if (platsContainer) platsContainer.style.display = 'none';
    
    // Afficher la section burgers
    const burgersSection = document.getElementById('burgers-section');
    if (burgersSection) burgersSection.style.display = 'block';
    
    // üÜï ACTIVATION VISUELLE DE LA SOUS-CAT√âGORIE "CLASSIQUE"
    activerSousCategorieBurger('classique');
};

// üÜï NOUVELLE FONCTION POUR ACTIVER UNE SOUS-CAT√âGORIE
function activerSousCategorieBurger(burgerType) {
    console.log(`Activation de la sous-cat√©gorie: ${burgerType}`);
    
    // Retirer la classe active de tous les boutons
    document.querySelectorAll('.burger-subcategory-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Ajouter la classe active au bouton correspondant
    const targetBtn = document.querySelector(`.burger-subcategory-btn[data-type="${burgerType}"]`);
    if (targetBtn) {
        targetBtn.classList.add('active');
    }
    
    // Masquer toutes les sous-cat√©gories
    document.querySelectorAll('.burgers-subcategory').forEach(section => {
        section.style.display = 'none';
    });
    
    // Afficher la sous-cat√©gorie s√©lectionn√©e
    const targetSection = document.getElementById(`burgers-${burgerType}`);
    if (targetSection) {
        targetSection.style.display = 'block';
    }
    
    // Charger les burgers du type s√©lectionn√©
    loadBurgersByType(burgerType);
}

// üÜï FONCTION CORRIG√âE - Chargement des burgers par type
window.loadBurgersByType = function(burgerType) {
    console.log(`üçî Chargement burgers: ${burgerType}`);
    
    // V√©rifications de s√©curit√©
    if (!burgerType) {
        console.error('‚ùå Type de burger non sp√©cifi√©');
        return;
    }
    
    const containerId = `burgers-${burgerType}-list`;
    const container = document.getElementById(containerId);
    
    if (!container) {
        console.error(`‚ùå Conteneur ${containerId} introuvable`);
        return;
    }
    
    // üÜï √âviter les chargements multiples
    if (container.getAttribute('data-loading') === 'true') {
        console.log('‚è≥ Chargement d√©j√† en cours...');
        return;
    }
    
    container.setAttribute('data-loading', 'true');
    container.innerHTML = '<div class="col-12 text-center py-4"><div class="spinner-border text-warning" role="status"></div><p class="mt-2">Chargement des burgers...</p></div>';
    
    fetch(`/burgers_par_type_ajax/${burgerType}/`)
        .then(response => {
            if (!response.ok) throw new Error(`Erreur HTTP ${response.status}`);
            return response.json();
        })
        .then(data => {
            // üÜï Retirer l'attribut loading
            container.removeAttribute('data-loading');
            container.innerHTML = '';
            
            if (!data.burgers || data.burgers.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center">
                        <p class="text-muted">Aucun burger disponible dans cette cat√©gorie pour le moment.</p>
                    </div>
                `;
                return;
            }
            
            // üÜï CR√âATION DU CONTENU AVEC LAYOUT STABLE
            data.burgers.forEach(burger => {
                const imageUrl = burger.photo_url || '/static/images/default.jpg';
                const escapedNom = htmlEscape(burger.nom);
                const escapedDescriptionCourte = htmlEscape(burger.description_courte);
                
                const card = document.createElement("li");
                // üÜï Classes simplifi√©es sans Isotope
                card.className = `col-lg-4 col-md-6 col-12 m-b30 burger-item`;
                
                const dzBox = document.createElement("div");
                dzBox.className = "dz-img-box style-7";
                
                dzBox.addEventListener("click", () => {
                    openPlatModal(
                        burger.id, 
                        burger.nom, 
                        imageUrl, 
                        burger.description_longue, 
                        burger.prix_unitaire_ttc, 
                        'burger'
                    );
                });
                
                dzBox.innerHTML = `
                    <div class="dz-media">
                        <img src="${imageUrl}" alt="${escapedNom}" class="img-fluid" style="width: 200px; height: 200px; object-fit: cover;">
                        <div class="dz-meta">
                            <ul><li class="rating"><i class="fa-solid fa-star"></i> 4.5</li></ul>
                        </div>
                    </div>
                    <div class="dz-content">
                        <h5 class="title">${escapedNom}</h5>
                        <p>${escapedDescriptionCourte}</p>
                        <span class="price">${burger.prix_unitaire_ttc} ‚Ç¨</span>
                    </div>
                `;
                
                card.appendChild(dzBox);
                container.appendChild(card);
            });
            
            // üÜï APPLICATION DU LAYOUT FINAL
            setTimeout(() => {
                applyBurgerLayout(container, burgerType);
            }, 50);
            
        })
        .catch(error => {
            console.error('‚ùå Erreur lors du chargement des burgers:', error);
            container.removeAttribute('data-loading');
            container.innerHTML = `
                <div class="col-12 text-center">
                    <p class="text-danger">Erreur de chargement. Veuillez r√©essayer.</p>
                </div>
            `;
        });
};

// üÜï FONCTION POUR APPLIQUER LE LAYOUT
function applyBurgerLayout(container, burgerType) {
    // üÜï TOUJOURS d√©sactiver Isotope pour une stabilit√© maximale
    container.classList.remove('isotope');
    container.style.height = 'auto';
    
    if (window.innerWidth > 768) {
        // Desktop : layout Bootstrap normal
        container.className = 'row dlab-gallery-listing gallery';
        const allItems = container.querySelectorAll('.burger-item');
        allItems.forEach(item => {
            item.style.cssText = ''; // Reset complet
        });
    } else {
        // Mobile : layout colonne unique stable
        container.className = 'burger-list-mobile';
        const allItems = container.querySelectorAll('.burger-item');
        allItems.forEach(item => {
            item.style.cssText = `
                width: 100% !important;
                display: block !important;
                opacity: 1 !important;
                visibility: visible !important;
                position: relative !important;
                transform: none !important;
                left: auto !important;
                top: auto !important;
                margin-bottom: 25px !important;
                float: none !important;
            `;
        });
    }
    
    console.log(`‚úÖ Layout appliqu√© pour ${burgerType}`);
}

// üÜï FONCTION CORRIG√âE - Activation sous-cat√©gorie
function activerSousCategorieBurger(burgerType) {
    console.log(`üéØ Activation sous-cat√©gorie: ${burgerType}`);
    
    // V√©rifications
    const targetSection = document.getElementById(`burgers-${burgerType}`);
    const targetList = document.getElementById(`burgers-${burgerType}-list`);
    
    if (!targetSection || !targetList) {
        console.error('‚ùå Section ou liste introuvable');
        return;
    }
    
    // üÜï Retirer active de tous les boutons
    document.querySelectorAll('.burger-subcategory-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.removeAttribute('data-loading');
    });
    
    // Activer le bouton cliqu√©
    const targetBtn = document.querySelector(`.burger-subcategory-btn[data-type="${burgerType}"]`);
    if (targetBtn) {
        targetBtn.classList.add('active');
    }
    
    // üÜï Masquer toutes les sections
    document.querySelectorAll('.burgers-subcategory').forEach(section => {
        section.style.display = 'none';
    });
    
    // Afficher la section cible
    targetSection.style.display = 'block';
    
    // üÜï Charger le contenu UNIQUEMENT si vide
    const hasContent = targetList.children.length > 0 && 
                      !targetList.querySelector('.spinner-border');
    
    if (!hasContent) {
        console.log(`üì• Chargement n√©cessaire pour: ${burgerType}`);
        loadBurgersByType(burgerType);
    } else {
        console.log(`‚úÖ Contenu d√©j√† charg√© pour: ${burgerType}`);
        // üÜï Re-appliquer le layout pour stabiliser
        applyBurgerLayout(targetList, burgerType);
    }
}

// üÜï Gestion du redimensionnement - VERSION SIMPLIFI√âE
window.addEventListener('resize', function() {
    const burgersSection = document.getElementById('burgers-section');
    if (burgersSection && burgersSection.style.display !== 'none') {
        console.log('üîÑ Redimensionnement - Application layout burgers');
        
        // R√©appliquer le layout √† toutes les listes visibles
        const containers = [
            document.getElementById('burgers-classique-list'),
            document.getElementById('burgers-gourmet-list')
        ];
        
        containers.forEach(container => {
            if (container && container.children.length > 0) {
                const burgerType = container.id.replace('burgers-', '').replace('-list', '');
                applyBurgerLayout(container, burgerType);
            }
        });
    }
});

// üÜï Gestion des clics - VERSION AM√âLIOR√âE
document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('burger-subcategory-btn')) {
            const burgerType = e.target.getAttribute('data-type');
            
            // üÜï Emp√™cher le spam de clics
            if (e.target.getAttribute('data-loading') === 'true') return;
            
            e.target.setAttribute('data-loading', 'true');
            setTimeout(() => {
                e.target.removeAttribute('data-loading');
            }, 1000);
            
            console.log(`üëÜ Clic utilisateur sur: ${burgerType}`);
            activerSousCategorieBurger(burgerType);
        }
    });
});

// üÜï FONCTION loadBurgers CORRIG√âE (sans chargement auto)
window.loadBurgers = function() {
    console.log('üçî Initialisation section burgers');
    
    const welcomePlaceholder = document.getElementById('welcome-placeholder');
    if (welcomePlaceholder) welcomePlaceholder.style.display = 'none';
    
    // Masquer la section plats normale
    const platsContainer = document.getElementById('masonry');
    if (platsContainer) platsContainer.style.display = 'none';
    
    // Afficher la section burgers
    const burgersSection = document.getElementById('burgers-section');
    if (burgersSection) burgersSection.style.display = 'block';
    
    // üÜï CORRECTION : NE PAS CHARGER AUTOMATIQUEMENT
    // Juste pr√©parer l'interface, attendre le clic utilisateur
    console.log('‚è≥ Section burgers pr√™te - En attente de s√©lection utilisateur');
    
    // Masquer tous les conteneurs initialement
    document.querySelectorAll('.burgers-subcategory').forEach(section => {
        section.style.display = 'none';
    });
};






</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const img = document.getElementById("welcome-img");
        const title = document.getElementById("welcome-title");
        const text = document.getElementById("welcome-text");
    
        setTimeout(() => {
            // Image
            img.classList.remove("invisible");
            img.classList.add("animate__animated", "animate__fadeInDown");
    
            // Titre
            setTimeout(() => {
                title.classList.remove("invisible");
                title.classList.add("animate__animated", "animate__fadeInUp");
            }, 200);
    
            // Texte
            setTimeout(() => {
                text.classList.remove("invisible");
                text.classList.add("animate__animated", "animate__fadeInRight");
            }, 400);
        }, 500); // Attente initiale
    });


    async function validerMenu() {
    const modal = document.getElementById("menu-modal");
    const menuId = modal.dataset.menuId;

    const choix = {};
    const viandes = {
        "incluses": [],  // üÜï Format attendu par le backend
        "accompagnements": []  // üÜï Format attendu par le backend
    };
    let hasAtLeastOne = false;

    console.log("üç± Validation du menu ID:", menuId);

    // ‚ñ∂Ô∏è R√©cup√©rer les viandes couscous
    const viandesCheckboxes = modal.querySelectorAll('input[name="viandes_couscous"]:checked');
    viandesCheckboxes.forEach(cb => {
        viandes.incluses.push(parseInt(cb.value));
        hasAtLeastOne = true;
        console.log("ü•© Viande couscous s√©lectionn√©e:", cb.value);
    });

    // ‚ñ∂Ô∏è R√©cup√©rer les accompagnements couscous
    const accCheckboxes = modal.querySelectorAll('input[name="accompagnements_couscous"]:checked');
    accCheckboxes.forEach(cb => {
        viandes.accompagnements.push(cb.value);
        hasAtLeastOne = true;
        console.log("üçü Accompagnement couscous s√©lectionn√©:", cb.value);
    });

    // ‚ñ∂Ô∏è R√©cup√©rer tous les autres choix (boissons, etc.)
    modal.querySelectorAll("input[type='checkbox']:checked").forEach(cb => {
        const name = cb.name;
        const value = cb.value;

        // Ignorer les champs d√©j√† trait√©s (couscous)
        if (name === "viandes_couscous" || name === "accompagnements_couscous") return;

        if (name.startsWith("choix_")) {
            const role = name.replace("choix_", "");
            if (!choix[role]) {
                choix[role] = [value];
            } else {
                choix[role].push(value);
            }
            hasAtLeastOne = true;
            console.log(`üìù Choix ${role}: ${value}`);
        }
    });

    if (!hasAtLeastOne) {
        alert("Veuillez s√©lectionner au moins un composant du menu.");
        return;
    }

    // üÜï PR√âPARATION DES DONN√âES
    const payload = {
        menu_id: menuId,
        choix: choix,
        viandes: viandes  // üÜï Format corrig√©
    };

    console.log("üì§ Payload complet:", payload);

    try {
        const response = await fetch("/ajouter_menu_personnalise/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken")
            },
            body: JSON.stringify(payload),
            credentials: "same-origin"
        });

        const data = await response.json();
        console.log("üì• R√©ponse serveur:", data);
        
        if (data.success) {
            bootstrap.Modal.getInstance(modal).hide();
            if (typeof updateCartDisplay === "function") {
                updateCartDisplay(data.cart_items, data.totals);
            }
            console.log("‚úÖ Menu ajout√© avec succ√®s au panier");
        } else {
            alert("Erreur : " + (data.error || "Impossible d'ajouter le menu."));
            console.error("‚ùå Erreur serveur:", data);
        }
    } catch (error) {
        console.error("‚ùå Erreur r√©seau :", error);
        alert("Erreur r√©seau lors de l'ajout du menu.");
    }
}



document.addEventListener('change', function (e) {
  if (e.target.classList.contains('viande-checkbox')) {
    const groupName = e.target.name;

    // üîç R√©cup√©rer le bloc parent contenant le label avec le nombre autoris√©
    const groupContainer = e.target.closest('.form-group');
    const label = groupContainer ? groupContainer.querySelector('label') : null;

    if (!label) return; // S√©curit√©

    const match = label.innerText.match(/\d+/); // Cherche un nombre dans le texte
    const max = match ? parseInt(match[0], 10) : 1; // Par d√©faut 1 si non trouv√©

    // üî¢ Compte les cases coch√©es dans le m√™me groupe
    const checkboxes = document.querySelectorAll(`input[name="${groupName}"]:checked`);
    if (checkboxes.length > max) {
      e.target.checked = false;
      alert(`Vous ne pouvez choisir que ${max} viande${max > 1 ? 's' : ''}.`);
    }
  }
});


// Gestion des clics sur les cat√©gories du menu
document.addEventListener('DOMContentLoaded', function() {
    // Attacher les √©v√©nements aux cat√©gories
    document.querySelectorAll('.filters li a').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const categorieSlug = this.closest('li').getAttribute('data-filter').replace('.', '');
            console.log('Cat√©gorie cliqu√©e:', categorieSlug);
            loadPlats(categorieSlug);
        });
    });
});

// Fonction pour ouvrir la modal Crousty - VERSION CORRIG√âE
// Fonction pour ouvrir la modal Crousty - VERSION CORRIG√âE POUR TOUS LES CROUSTY
window.openCroustyModal = function(platId, nom, imageUrl, description, prix) {
    console.log(`Ouverture modal Crousty pour plat ${platId}: ${nom}`);
    
    // Stocker les infos dans une variable locale
    const currentCroustyPlat = {
        id: platId,
        nom: nom,
        prix: prix
    };
    
    // üÜï CORRECTION COMPL√àTE : D√©tection de TOUS les types de Crousty
    const proteineSection = document.getElementById('proteineVeggieSection');
    const nomLower = nom.toLowerCase();
    
    console.log("üîç Analyse du Crousty:", nomLower);
    
    // Afficher la section prot√©ine v√©g√©tarienne UNIQUEMENT pour Crousty #2 VEGGIE
    if (nomLower.includes('#2') || nomLower.includes('veggie') || nomLower.includes('v√©g√©tarien')) {
        proteineSection.style.display = 'block';
        console.log("üå± Section prot√©ine v√©g√©tarienne AFFICH√âE (Crousty Veggie)");
    } else {
        proteineSection.style.display = 'none';
        console.log("üçó Section prot√©ine v√©g√©tarienne MASQU√âE (Crousty non-veggie)");
    }
    
    // Charger les options depuis l'API
    fetch(`/crousty_options_ajax/${platId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("‚úÖ Donn√©es options Crousty re√ßues:", data);
            
            if (data.success) {
                // Passer currentCroustyPlat en param√®tre
                afficherOptionsCrousty(data.options_par_categorie, nom, currentCroustyPlat);
                $('#composeCroustyModal').modal('show');
            } else {
                console.error("‚ùå Erreur dans la r√©ponse:", data);
                alert('Erreur lors du chargement des options Crousty: ' + (data.message || 'R√©ponse invalide'));
            }
        })
        .catch(error => {
            console.error('‚ùå Erreur fetch:', error);
            alert('Erreur de chargement des options: ' + error.message);
        });
};

// Fonction pour afficher les options dans la modal - VERSION AVEC PROT√âINE V√âG√âTARIENNE EN RADIO
// Fonction pour afficher les options dans la modal - VERSION AVEC PROT√âINE V√âG√âTARIENNE EN RADIO
function afficherOptionsCrousty(optionsParCategorie, platNom, currentCroustyPlat) {
    const containers = {
        'fromage': '.fromage-container',
        'sauce_rouge': '.sauce-rouge-container',
        'sauce_erc': '.sauce-erc-container',
        'prot_veggie': '.proteine-veggie-container',
        'supplement': '.supplement-container'
    };
    
    const platNomLower = platNom.toLowerCase();
    const isVeggie = platNomLower.includes('#2') || platNomLower.includes('veggie') || platNomLower.includes('v√©g√©tarien');
    
    console.log(`üçΩÔ∏è Configuration Crousty: ${platNom} - ${isVeggie ? 'Veggie' : 'Standard'}`);
    
    // Stocker les donn√©es du plat dans un attribut data de la modal
    const modal = document.getElementById('composeCroustyModal');
    modal.dataset.currentCroustyPlat = JSON.stringify(currentCroustyPlat);
    
    // R√©initialiser tous les conteneurs d'abord
    Object.values(containers).forEach(selector => {
        const container = document.querySelector(selector);
        if (container) container.innerHTML = '';
    });
    
    // Pour chaque cat√©gorie disponible dans la r√©ponse
    for (const [categorie, options] of Object.entries(optionsParCategorie)) {
        const containerSelector = containers[categorie];
        const container = document.querySelector(containerSelector);
        
        if (!container) {
            console.warn(`‚ö†Ô∏è Conteneur non trouv√©: ${containerSelector} pour cat√©gorie: ${categorie}`);
            continue;
        }
        
        console.log(`üì¶ Remplissage cat√©gorie: ${categorie} avec ${options.length} options`);
        
        // Masquer les cat√©gories inappropri√©es
        if (categorie === 'prot_veggie' && !isVeggie) {
            console.log("üö´ Masquage de la section prot√©ine v√©g√©tarienne (Crousty non-veggie)");
            continue;
        }
        
        // Afficher la section si elle √©tait masqu√©e
        if (categorie === 'prot_veggie' && isVeggie) {
            const proteineSection = document.getElementById('proteineVeggieSection');
            proteineSection.style.display = 'block';
        }
        
        // D√âTERMINER LE TYPE D'INPUT SP√âCIFIQUE POUR CHAQUE CAT√âGORIE
        let inputType, inputName, required;
        
        if (categorie === 'prot_veggie') {
            // PROT√âINE V√âG√âTARIENNE : boutons radio (1 choix maximum)
            inputType = 'radio';
            inputName = 'crousty_prot_veggie'; // M√™me nom pour tous = groupe radio
            required = 'required';
        } else if (categorie === 'fromage' || categorie === 'sauce_rouge' || categorie === 'sauce_erc') {
            // AUTRES CAT√âGORIES RADIO : 1 choix maximum
            inputType = 'radio';
            inputName = `crousty_${categorie}`;
            required = 'required';
        } else {
            // SUPPLEMENTS : cases √† cocher (choix multiples)
            inputType = 'checkbox';
            inputName = `crousty_${categorie}`;
            required = '';
        }
        
        options.forEach((option, index) => {
            const div = document.createElement('div');
            div.className = 'form-check mb-2';
            
            // S√âLECTION PAR D√âFAUT INTELLIGENTE
            let checked = '';
            
            if (inputType === 'radio') {
                // Premier √©l√©ment coch√© par d√©faut pour les radios
                if (index === 0) {
                    checked = 'checked';
                }
                
                // Surcharges sp√©cifiques pour certaines cat√©gories
                if (categorie === 'fromage' && option.nom && option.nom.toLowerCase().includes('cheddar')) {
                    checked = 'checked';
                } else if (categorie === 'sauce_rouge' && option.prix_supplement === 0) {
                    checked = 'checked';
                } else if (categorie === 'sauce_erc' && option.nom && option.nom.toLowerCase().includes('mayonnaise')) {
                    checked = 'checked';
                }
            }
            
            const prixText = option.prix_supplement > 0 ? `(+${parseFloat(option.prix_supplement).toFixed(2)}‚Ç¨)` : '';
            
            div.innerHTML = `
                <input type="${inputType}" class="form-check-input" 
                       name="${inputName}" value="${option.id}" 
                       id="crousty-${option.id}"
                       ${checked} ${required}>
                <label class="form-check-label" for="crousty-${option.id}">
                    ${option.nom} ${prixText}
                </label>
            `;
            
            container.appendChild(div);
        });
    }
    
    // üÜï V√©rification finale de l'affichage
    console.log("‚úÖ Modal Crousty configur√©e pour:", platNom);
    console.log(`üå± Section prot√©ine v√©g√©tarienne: ${isVeggie ? 'AFFICH√âE (radio - 1 choix)' : 'MASQU√âE'}`);
}


// Fonction pour ajouter un Crousty au panier - VERSION CORRIG√âE
function ajouterCroustyAuPanier() {
    const modal = document.getElementById('composeCroustyModal');
    const croustyData = JSON.parse(modal.dataset.currentCroustyPlat || '{}');
    
    if (!croustyData.id) {
        alert('Erreur: Plat Crousty non trouv√©');
        console.error("‚ùå Donn√©es Crousty manquantes");
        return;
    }

    console.log(`üõí Ajout Crousty au panier: ${croustyData.nom} (ID: ${croustyData.id})`);

    // R√©cup√©rer les options s√©lectionn√©es
    const optionsSelectionnees = [];
    let prixSupplementTotal = 0;

    // Fonction helper pour r√©cup√©rer le prix d'une option
    const getPrixSupplement = (optionId) => {
        const optionLabel = document.querySelector(`label[for="crousty-${optionId}"]`);
        if (optionLabel) {
            const text = optionLabel.textContent;
            const match = text.match(/\(\+([0-9.,]+)‚Ç¨\)/);
            if (match) {
                return parseFloat(match[1].replace(',', '.'));
            }
        }
        return 0;
    };

    // Fromage (radio - 1 choix requis)
    const fromageSelectionne = document.querySelector('input[name="crousty_fromage"]:checked');
    if (fromageSelectionne) {
        optionsSelectionnees.push(parseInt(fromageSelectionne.value));
        prixSupplementTotal += getPrixSupplement(fromageSelectionne.value);
    } else {
        alert("Veuillez s√©lectionner un fromage");
        return;
    }

    // Sauce Rouge (radio - 1 choix requis)
    const sauceRougeSelectionnee = document.querySelector('input[name="crousty_sauce_rouge"]:checked');
    if (sauceRougeSelectionnee) {
        optionsSelectionnees.push(parseInt(sauceRougeSelectionnee.value));
        prixSupplementTotal += getPrixSupplement(sauceRougeSelectionnee.value);
    } else {
        alert("Veuillez s√©lectionner une sauce rouge");
        return;
    }

    // Sauce ERC (radio - 1 choix requis)
    const sauceErcSelectionnee = document.querySelector('input[name="crousty_sauce_erc"]:checked');
    if (sauceErcSelectionnee) {
        optionsSelectionnees.push(parseInt(sauceErcSelectionnee.value));
        prixSupplementTotal += getPrixSupplement(sauceErcSelectionnee.value);
    } else {
        alert("Veuillez s√©lectionner une sauce ERC");
        return;
    }

    // Prot√©ine V√©g√©tarienne (uniquement si la section est visible)
    const proteineSection = document.getElementById('proteineVeggieSection');
    if (proteineSection.style.display !== 'none') {
        const proteineVeggieSelectionnee = document.querySelector('input[name="crousty_prot_veggie"]:checked');
        if (proteineVeggieSelectionnee) {
            optionsSelectionnees.push(parseInt(proteineVeggieSelectionnee.value));
            prixSupplementTotal += getPrixSupplement(proteineVeggieSelectionnee.value);
        } else {
            alert("Veuillez s√©lectionner une prot√©ine v√©g√©tarienne");
            return;
        }
    }

    // Suppl√©ments (checkbox - optionnels)
    const supplementsSelectionnes = document.querySelectorAll('input[name="crousty_supplement"]:checked');
    supplementsSelectionnes.forEach(supplement => {
        optionsSelectionnees.push(parseInt(supplement.value));
        prixSupplementTotal += getPrixSupplement(supplement.value);
    });

    console.log('‚úÖ Options s√©lectionn√©es:', optionsSelectionnees);
    console.log('üí∞ Suppl√©ment total:', prixSupplementTotal);

    // Pr√©parer les donn√©es pour l'envoi
    const dataToSend = {
        plat_id: croustyData.id,
        options_crousty: optionsSelectionnees,
        prix_supplement: prixSupplementTotal
    };

    console.log('üì§ Donn√©es envoy√©es:', dataToSend);

    // Envoyer au serveur
    fetch('/ajouter_crousty_personnalise/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(dataToSend)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('üì• R√©ponse serveur:', data);
        
        if (data.success) {
            $('#composeCroustyModal').modal('hide');
            updateCartDisplay(data.cart_items, data.totals, data.code_promo);
            
            // Nettoyer les donn√©es apr√®s ajout r√©ussi
            modal.dataset.currentCroustyPlat = '';
            
            // Proposer les sides/boissons/desserts
            setTimeout(() => proposerSides(), 300);
        } else {
            alert('Erreur: ' + (data.message || 'Impossible d\'ajouter au panier'));
        }
    })
    .catch(error => {
        console.error('‚ùå Erreur:', error);
        alert('Erreur lors de l\'ajout au panier: ' + error.message);
    });
}

// Attacher l'√©v√©nement au bouton "Ajouter au Panier" de la modal Crousty
document.addEventListener('DOMContentLoaded', function() {
    const validerCroustyBtn = document.getElementById('validerCroustyBtn');
    if (validerCroustyBtn) {
        validerCroustyBtn.addEventListener('click', ajouterCroustyAuPanier);
    }
});


// Fonction pour ouvrir la modal Poulet
window.openPouletModal = function(platId, nom, imageUrl, description, prix) {
    console.log(`Ouverture modal Poulet pour plat ${platId}: ${nom}`);
    
    const currentPouletPlat = {
        id: platId,
        nom: nom,
        prix: prix
    };
    
    fetch(`/poulet_options_ajax/${platId}/`)
        .then(response => {
            if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log("‚úÖ Donn√©es options Poulet re√ßues:", data);
            
            if (data.success) {
                afficherOptionsPoulet(data.options_par_categorie, nom, currentPouletPlat);
                $('#composePouletModal').modal('show');
            } else {
                alert('Erreur lors du chargement des options Poulet: ' + (data.message || 'R√©ponse invalide'));
            }
        })
        .catch(error => {
            console.error('‚ùå Erreur fetch:', error);
            alert('Erreur de chargement des options: ' + error.message);
        });
};

// Fonction pour afficher les options dans la modal Poulet - AVEC BOUTONS +/-
// Fonction pour afficher les options dans la modal Poulet - AVEC LIMITES MINIMALES
function afficherOptionsPoulet(optionsParCategorie, platNom, currentPouletPlat) {
    const containers = {
        'assaisonnement': '.assaisonnement-poulet-container',
        'sauce': '.sauce-poulet-container',
        'supplement': '.supplement-poulet-container',
        'accompagnement': '.accompagnement-poulet-container'
    };
    
    const modal = document.getElementById('composePouletModal');
    modal.dataset.currentPouletPlat = JSON.stringify(currentPouletPlat);
    modal.dataset.limites = JSON.stringify(optionsParCategorie);
    
    // R√©initialiser tous les conteneurs
    Object.values(containers).forEach(selector => {
        const container = document.querySelector(selector);
        if (container) container.innerHTML = '';
    });
    
    // Remplir chaque cat√©gorie avec boutons +/-
    for (const [categorie, data] of Object.entries(optionsParCategorie)) {
        const containerSelector = containers[categorie];
        const container = document.querySelector(containerSelector);
        
        if (!container) continue;
        
        const options = data.options || [];
        const limiteMin = data.limite_min || 0; // üÜï LIMITE MINIMALE
        const limiteMax = data.limite || 1; // Limite maximale
        const categorieDisplay = data.categorie_display || categorie;
        
        // üÜï AJOUTER L'INFORMATION DE LIMITE MINIMALE DANS L'INTERFACE
        const titre = document.createElement('div');
        titre.className = 'categorie-header mb-3';
        
        let texteLimite = '';
        if (limiteMin > 0 && limiteMax < 99) {
            texteLimite = ` (${limiteMin} √† ${limiteMax} choix)`; // üÜï Affiche la plage
        } else if (limiteMin > 0) {
            texteLimite = ` (minimum ${limiteMin} choix)`; // üÜï Affiche le minimum
        } else if (limiteMax < 99) {
            texteLimite = ` (maximum ${limiteMax} choix)`;
        } else {
            texteLimite = ' (au choix)';
        }
        
        titre.innerHTML = `<h6>${categorieDisplay}${texteLimite}</h6>`;
        container.appendChild(titre);
        
        // üÜï CORRECTION : ASSAISONNEMENTS EN BOUTONS RADIO
        if (categorie === 'assaisonnement') {
            // Pour les assaisonnements, utiliser des boutons radio
            options.forEach((option, index) => {
                const div = document.createElement('div');
                div.className = 'form-check mb-2';
                
                // Premier bouton coch√© par d√©faut
                const checked = index === 0 ? 'checked' : '';
                
                div.innerHTML = `
                    <input type="radio" class="form-check-input poulet-option-radio" 
                           name="poulet_assaisonnement" value="${option.id}" 
                           id="poulet-${option.id}"
                           data-categorie="${categorie}"
                           ${checked} required>
                    <label class="form-check-label" for="poulet-${option.id}">
                        ${option.nom} ${option.prix_supplement > 0 ? `(+${option.prix_supplement}‚Ç¨)` : ''}
                    </label>
                `;
                
                container.appendChild(div);
            });
        } else {
            // Pour les autres cat√©gories, utiliser les boutons +/-
            options.forEach(option => {
                const optionRow = document.createElement('div');
                optionRow.className = 'option-row mb-3 p-3 border rounded';
                optionRow.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="option-info flex-grow-1">
                            <div class="option-nom fw-bold">${option.nom}</div>
                            ${option.prix_supplement > 0 ? 
                              `<div class="option-prix text-success small">+${option.prix_supplement}‚Ç¨</div>` : 
                              '<div class="option-prix text-muted small">Inclus</div>'
                            }
                        </div>
                        
                        <div class="quantity-selector d-flex align-items-center">
                            <button type="button" class="btn btn-outline-secondary btn-sm btn-moins" 
                                    data-option-id="${option.id}" data-categorie="${categorie}">
                                <i class="fas fa-minus"></i>
                            </button>
                            
                            <span class="quantity-display mx-2 fw-bold" 
                                  id="quantity-${option.id}" 
                                  data-option-id="${option.id}">0</span>
                            
                            <button type="button" class="btn btn-outline-secondary btn-sm btn-plus" 
                                    data-option-id="${option.id}" data-categorie="${categorie}">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(optionRow);
            });
            
            // üÜï AM√âLIORATION DU COMPTEUR POUR INCLURE LA LIMITE MINIMALE
            if (limiteMax > 1 || limiteMin > 0) {
                const counter = document.createElement('div');
                counter.className = 'limite-counter small text-muted mt-2';
                counter.id = `counter-${categorie}`;
                
                let counterText = 'S√©lectionn√©s: ';
                if (limiteMin > 0) {
                    counterText += `<span class="count">0</span>/${limiteMin}`;
                    if (limiteMax < 99) {
                        counterText += ` (max: ${limiteMax})`;
                    }
                } else {
                    counterText += `<span class="count">0</span>/${limiteMax}`;
                }
                
                counter.innerHTML = counterText;
                container.appendChild(counter);
            }
        }
    }
    
    // Appliquer les gestionnaires d'√©v√©nements
    appliquerGestionnairesQuantitePoulet();
}

// Gestion des boutons + et -
function appliquerGestionnairesQuantitePoulet() {
    const modal = document.getElementById('composePouletModal');
    const limites = JSON.parse(modal.dataset.limites || '{}');
    
    // Boutons +
    document.querySelectorAll('.btn-plus').forEach(btn => {
        btn.addEventListener('click', function() {
            const optionId = this.dataset.optionId;
            const categorie = this.dataset.categorie;
            const limiteData = limites[categorie];
            
            if (!limiteData) return;
            
            const quantiteDisplay = document.getElementById(`quantity-${optionId}`);
            let quantite = parseInt(quantiteDisplay.textContent) || 0;
            
            // V√©rifier la limite de la cat√©gorie
            const totalCategorie = calculerTotalCategorie(categorie);
            const limite = limiteData.limite;
            
            if (limite < 99 && totalCategorie >= limite) {
                alert(`Limite atteinte pour ${limiteData.categorie_display || categorie} (${limite} choix maximum)`);
                return;
            }
            
            // Augmenter la quantit√©
            quantite++;
            quantiteDisplay.textContent = quantite;
            quantiteDisplay.dataset.quantite = quantite;
            
            // Mettre √† jour les compteurs
            mettreAJourCompteurs();
        });
    });
    
    // Boutons -
    document.querySelectorAll('.btn-moins').forEach(btn => {
        btn.addEventListener('click', function() {
            const optionId = this.dataset.optionId;
            const quantiteDisplay = document.getElementById(`quantity-${optionId}`);
            let quantite = parseInt(quantiteDisplay.textContent) || 0;
            
            if (quantite > 0) {
                quantite--;
                quantiteDisplay.textContent = quantite;
                quantiteDisplay.dataset.quantite = quantite;
                
                // Mettre √† jour les compteurs
                mettreAJourCompteurs();
            }
        });
    });
}

// Calculer le total pour une cat√©gorie
function calculerTotalCategorie(categorie) {
    let total = 0;
    const quantiteDisplays = document.querySelectorAll(`.quantity-display[data-option-id]`);
    
    quantiteDisplays.forEach(display => {
        const optionId = display.dataset.optionId;
        const optionRow = display.closest('.option-row');
        const btnPlus = optionRow.querySelector('.btn-plus');
        
        if (btnPlus && btnPlus.dataset.categorie === categorie) {
            total += parseInt(display.textContent) || 0;
        }
    });
    
    return total;
}

// Mettre √† jour tous les compteurs
// Mettre √† jour tous les compteurs avec gestion des limites minimales
function mettreAJourCompteurs() {
    const modal = document.getElementById('composePouletModal');
    const limites = JSON.parse(modal.dataset.limites || '{}');
    
    for (const [categorie, data] of Object.entries(limites)) {
        const totalCategorie = calculerTotalCategorie(categorie);
        const counter = document.getElementById(`counter-${categorie}`);
        const limiteMin = data.limite_min || 0;
        const limiteMax = data.limite || 99;
        
        if (counter) {
            const countSpan = counter.querySelector('.count');
            countSpan.textContent = totalCategorie;
            
            // üÜï GESTION DES COULEURS POUR LES LIMITES MINIMALES
            if (totalCategorie < limiteMin) {
                // Pas assez s√©lectionn√© - couleur d'avertissement
                counter.classList.add('text-warning', 'fw-bold');
                counter.classList.remove('text-danger', 'text-muted');
            } else if (limiteMax < 99 && totalCategorie >= limiteMax) {
                // Limite maximale atteinte - couleur d'alerte
                counter.classList.add('text-danger', 'fw-bold');
                counter.classList.remove('text-warning', 'text-muted');
            } else {
                // Dans les limites - couleur normale
                counter.classList.remove('text-danger', 'text-warning', 'fw-bold');
                counter.classList.add('text-muted');
            }
        }
    }
}

// Fonction pour ajouter un Poulet au panier - AVEC GESTION DES RADIOS

function ajouterPouletAuPanier() {
    const modal = document.getElementById('composePouletModal');
    const pouletData = JSON.parse(modal.dataset.currentPouletPlat || '{}');
    const limites = JSON.parse(modal.dataset.limites || '{}');
    
    if (!pouletData.id) {
        alert('Erreur: Plat Poulet non trouv√©');
        return;
    }

    // üÜï VALIDATION DES LIMITES MINIMALES
    for (const [categorie, data] of Object.entries(limites)) {
        let totalCategorie = 0;
        
        if (categorie === 'assaisonnement') {
            // Validation assaisonnement (1 requis)
            const assaisonnementSelectionne = document.querySelector('input[name="poulet_assaisonnement"]:checked');
            if (!assaisonnementSelectionne) {
                alert(`Veuillez s√©lectionner un ${data.categorie_display || categorie}`);
                return;
            }
            totalCategorie = 1;
        } else {
            totalCategorie = calculerTotalCategorie(categorie);
            
            // üÜï VALIDATION LIMITE MINIMALE
            const limiteMin = data.limite_min || 0; // Limite minimale
            const limiteMax = data.limite || 99; // Limite maximale
            
            if (totalCategorie < limiteMin) {
                alert(`Veuillez s√©lectionner au moins ${limiteMin} ${data.categorie_display || categorie}`);
                return;
            }
            
            if (limiteMax < 99 && totalCategorie > limiteMax) {
                alert(`Vous avez s√©lectionn√© ${totalCategorie} ${data.categorie_display || categorie}, mais la limite est de ${limiteMax}`);
                return;
            }
        }
    }

    // R√©cup√©rer les options avec leurs quantit√©s
    const optionsAvecQuantites = [];
    let prixSupplementTotal = 0;

    const getPrixSupplement = (optionId) => {
        // Chercher dans les radios d'abord
        const radioOption = document.querySelector(`input[value="${optionId}"]`);
        if (radioOption) {
            const label = document.querySelector(`label[for="${radioOption.id}"]`);
            if (label) {
                const text = label.textContent;
                const match = text.match(/\(\+([0-9.,]+)‚Ç¨\)/);
                if (match) return parseFloat(match[1].replace(',', '.'));
            }
            return 0;
        }
        
        // Sinon chercher dans les options avec quantit√©s
        const optionElement = document.querySelector(`[data-option-id="${optionId}"]`);
        if (!optionElement) return 0;
        
        const optionRow = optionElement.closest('.option-row');
        if (!optionRow) return 0;
        
        const prixElement = optionRow.querySelector('.option-prix');
        if (prixElement) {
            const text = prixElement.textContent;
            const match = text.match(/\+([0-9.,]+)‚Ç¨/);
            if (match) return parseFloat(match[1].replace(',', '.'));
        }
        return 0;
    };

    // R√©cup√©rer l'assaisonnement s√©lectionn√© (radio)
    const assaisonnementSelectionne = document.querySelector('input[name="poulet_assaisonnement"]:checked');
    if (assaisonnementSelectionne) {
        const optionId = parseInt(assaisonnementSelectionne.value);
        optionsAvecQuantites.push(optionId);
        prixSupplementTotal += getPrixSupplement(optionId);
    }

    // R√©cup√©rer toutes les autres options avec leurs quantit√©s
    document.querySelectorAll('.quantity-display[data-option-id]').forEach(display => {
        const quantite = parseInt(display.textContent) || 0;
        const optionId = display.dataset.optionId;
        
        if (quantite > 0) {
            const prixUnitaire = getPrixSupplement(optionId);
            
            // Ajouter l'option autant de fois que la quantit√©
            for (let i = 0; i < quantite; i++) {
                optionsAvecQuantites.push(parseInt(optionId));
                prixSupplementTotal += prixUnitaire;
            }
        }
    });

    // Pr√©parer les donn√©es pour l'envoi
    const dataToSend = {
        plat_id: pouletData.id,
        options_poulet: optionsAvecQuantites,
        prix_supplement: prixSupplementTotal
    };

    console.log('üì§ Donn√©es envoy√©es:', dataToSend);

    // Afficher un indicateur de chargement
    const validerBtn = document.getElementById('validerPouletBtn');
    const originalText = validerBtn.innerHTML;
    validerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ajout en cours...';
    validerBtn.disabled = true;

    // Envoyer au serveur
    fetch('/ajouter_poulet_personnalise/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(dataToSend)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#composePouletModal').modal('hide');
            updateCartDisplay(data.cart_items, data.totals, data.code_promo);
            modal.dataset.currentPouletPlat = '';
            setTimeout(() => proposerSides(), 300);
        } else {
            alert('Erreur: ' + (data.message || 'Impossible d\'ajouter au panier'));
        }
    })
    .catch(error => {
        alert('Erreur lors de l\'ajout au panier: ' + error.message);
    })
    .finally(() => {
        // Restaurer le bouton
        validerBtn.innerHTML = originalText;
        validerBtn.disabled = false;
    });
}

// Attacher l'√©v√©nement au bouton
document.addEventListener('DOMContentLoaded', function() {
    const validerPouletBtn = document.getElementById('validerPouletBtn');
    if (validerPouletBtn) {
        validerPouletBtn.addEventListener('click', ajouterPouletAuPanier);
    }
});



// Fonction sp√©cifique pour les burgers avec accompagnements
window.ajouterBurgerAvecAccompagnement = function (platId, optionsSelectionnees, accompagnementId, categoriePlat) {
    console.log(`üçî Ajout burger avec accompagnement - Plat: ${platId}`, {
        options: optionsSelectionnees,
        accompagnement: accompagnementId,
        categorie: categoriePlat
    });

    // R√©initialiser le conteneur des messages pour le code promo, s'il existe
    const messageContainer = document.getElementById('code-promo-message');
    if (messageContainer) {
        messageContainer.innerHTML = '';
        messageContainer.style.display = 'none';
    }

    // Pr√©parer les donn√©es pour l'envoi - ACCOMPAGNEMENT S√âPAR√â
    const dataToSend = {
        plat_id: platId,
        options: optionsSelectionnees,
        accompagnement: accompagnementId  // Envoy√© s√©par√©ment
    };

    console.log('üì§ Donn√©es envoy√©es au serveur:', dataToSend);

    // Effectuer une requ√™te POST pour ajouter le plat au panier
    fetch('/ajouter_au_panier/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(dataToSend)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Erreur HTTP : ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('üì• Donn√©es re√ßues apr√®s ajout au panier:', data);

        if (data.success) {
            // V√©rifier sp√©cifiquement la structure des options dans la r√©ponse
            if (data.cart_items && data.cart_items.length > 0) {
                data.cart_items.forEach((item, index) => {
                    console.log(`üì¶ Article ${index} dans la r√©ponse:`, {
                        nom: item.plat_nom,
                        options: item.options,
                        accompagnement: item.accompagnement, // V√©rifier l'accompagnement
                        tous_les_champs: item // Log tous les champs pour inspection
                    });
                });
            }

            // Mettre √† jour l'affichage du panier
            updateCartDisplay(data.cart_items, data.totals, data.code_promo);

            // D√©clencher des suggestions
            if (categoriePlat && categoriePlat !== "boisson" && categoriePlat !== "dessert" && categoriePlat !== "sides" && categoriePlat !== "menu") {
                console.log(`üéØ Relancer les suggestions pour le nouveau plat : ${platId}`);
                proposerSides();
            } else {
                console.log(`‚è≠Ô∏è Pas de suggestion n√©cessaire pour la cat√©gorie : ${categoriePlat}`);
            }
        } else {
            console.error('‚ùå Erreur lors de l\'ajout au panier :', data.message);
            alert(data.message || 'Une erreur est survenue lors de l\'ajout au panier.');
        }
    })
    .catch(error => {
        console.error('‚ùå Erreur lors de la requ√™te d\'ajout au panier :', error);
        alert('Une erreur est survenue. Veuillez r√©essayer.');
    });
};

// Fonction pour ouvrir la modal traiteur
function openTraiteurModal() {
    console.log("üéâ Ouverture modal service traiteur");
    
    // V√©rifier si la modal existe
    const traiteurModal = document.getElementById('traiteurModal');
    if (traiteurModal) {
        // Utiliser Bootstrap pour ouvrir la modal
        const modal = new bootstrap.Modal(traiteurModal);
        modal.show();
    } else {
        console.error("‚ùå Modal traiteur non trouv√©e");
        // Fallback : afficher un message d'information
        alert("üéâ Service Traiteur En Route Chef\n\nNous vous proposons nos services pour des repas ou r√©ceptions de 6 √† 200 personnes.\n\nüìû Contactez-nous pour un devis personnalis√© !");
    }
}


// Fonction unique pour g√©rer les clics sur les cat√©gories
function handleCategoryClick(categorieSlug) {
    console.log(`üü¢ Clic sur cat√©gorie: ${categorieSlug}`);
    
    if (categorieSlug === 'traiteur') {
        openTraiteurModal();
    } else {
        loadPlats(categorieSlug);
    }
}



// Fonction pour mettre √† jour le badge mobile
function updateCartBadgeMobile() {
    const cartCount = document.getElementById('cart-count');
    const cartBadgeMobile = document.getElementById('cart-badge-mobile');
    
    if (cartCount && cartBadgeMobile) {
        const countText = cartCount.textContent;
        const match = countText.match(/\((\d+)\)/);
        const count = match ? parseInt(match[1]) : 0;
        
        if (count > 0) {
            cartBadgeMobile.textContent = count;
            cartBadgeMobile.style.display = 'flex';
        } else {
            cartBadgeMobile.style.display = 'none';
        }
    }
}

// Appeler cette fonction apr√®s chaque mise √† jour du panier
// Ajoutez cette ligne dans votre fonction updateCartDisplay :
// updateCartBadgeMobile();

// Appeler cette fonction apr√®s chaque mise √† jour du panier
// Dans votre fonction updateCartDisplay, ajoutez :
// updateCartBadge();
    </script>
    
    

<style>
/* ===== VARIABLES ET R√âINITIALISATION ===== */
:root {
    --primary-color: #ff6600;
    --success-color: #198754;
    --warning-color: #f39c12;
    --danger-color: #e74c3c;
    --text-dark: #333;
    --text-muted: #666;
    --border-light: #e0e0e0;
    --bg-light: #f8f9fa;
    --shadow-light: 0 2px 8px rgba(0,0,0,0.1);
    --shadow-medium: 0 4px 12px rgba(0,0,0,0.15);
    --border-radius: 12px;
}

* {
    box-sizing: border-box;
}

/* ===== STYLES GLOBAUX ===== */
body {
    background-color: white !important;
    font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
    font-weight: 400;
    font-size: 18px;
    line-height: 1.6;
}

.menu-superieur {
    margin-bottom: 0 !important;
}

.content-inner {
    padding-top: 0 !important;
    margin-top: 0 !important;
}

.invisible {
    opacity: 0;
}

.emoji {
    font-size: 1.4rem;
    margin: 0 3px;
}

/* ===== COMPOSANTS BOUTONS ET FORMULAIRES ===== */
button,
.btn,
input,
label,
textarea,
select {
    font-family: inherit !important;
    font-weight: 300 !important;
    font-size: 14px;
}

#validerCommandeBtn {
    font-family: inherit !important;
    font-weight: 400 !important;
    font-size: 18px !important;
}

#validerCommandeBtn:hover {
    background-color: #19a425 !important;
    color: white !important;
    border-color: #19a425 !important;
}

/* ===== NAVIGATION CAT√âGORIES ===== */
.ligne-categories {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 12px;
    padding: 8px 0;
}

.ligne-categories li {
    list-style: none;
}

.ligne-categories li a {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-decoration: none;
    color: var(--text-dark);
    font-weight: 500;
    padding: 6px 10px;
    position: relative;
    transition: color 0.2s ease;
}

.ligne-categories li a i {
    font-size: 20px;
    margin-bottom: 4px;
}

.ligne-categories li a::after {
    content: "";
    display: block;
    width: 0%;
    height: 2px;
    background-color: var(--primary-color);
    margin-top: 4px;
    transition: width 0.3s ease;
}

.ligne-categories li a:hover::after {
    width: 60%;
}

/* ===== COMPOSANT PANIER ===== */
.panier-styled {
    border: 2px solid var(--border-light);
    border-radius: var(--border-radius);
    background-color: #fdfdfd;
    box-shadow: var(--shadow-light);
    padding: 20px;
}

.panier-styled h5.title {
    text-align: center;
    font-weight: 600;
}

#empty-cart-message {
    font-weight: 300 !important;
    font-size: 14px !important;
    font-family: inherit !important;
    text-align: center;
}

#invoice-details h6 {
    text-align: left;
    font-weight: 300;
}

/* ===== CHAMP CODE PROMO ===== */
#code_promo_input,
#code_promo_input::placeholder {
    font-family: inherit !important;
    font-weight: 300 !important;
    font-size: 16px;
    border-top-right-radius: 0 !important;
    border-bottom-right-radius: 0 !important;
}

/* ===== MODALES ===== */
.modal-backdrop.show {
    background-color: rgba(255, 255, 255, 0.3) !important;
    backdrop-filter: blur(24px);
}

.modal-content {
    background-color: #fefefe;
    border-radius: var(--border-radius);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    border: none;
    padding: 0;
}

.modal-header,
.modal-body,
.modal-footer {
    background-color: transparent;
    padding: 20px;
}

.modal-header {
    border-bottom: 1px solid #eee;
}

.modal-footer {
    border-top: 1px solid #eee;
}

.modal-title {
    font-family: inherit;
    font-size: 20px;
    font-weight: 400;
    color: var(--text-dark);
    letter-spacing: 0.3px;
}

/* ===== OPTIONS ET ACCORD√âONS ===== */
.categorie-options {
    margin-bottom: 25px;
    padding: 15px;
    background: var(--bg-light);
    border-radius: 10px;
    border-left: 4px solid var(--primary-color);
}

.categorie-titre {
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 15px;
    font-size: 16px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.options-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 10px;
}

.option-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background: white;
    transition: all 0.3s ease;
    cursor: pointer;
}

.option-item:hover {
    background: var(--bg-light);
    border-color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: var(--shadow-light);
}

.option-item input[type="checkbox"] {
    margin-right: 12px;
    transform: scale(1.2);
    cursor: pointer;
}

.option-item label {
    flex: 1;
    margin: 0;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.option-nom {
    font-weight: 500;
    color: var(--text-dark);
}

.option-prix {
    color: var(--primary-color);
    font-weight: 600;
    font-size: 14px;
    margin-left: 10px;
}

/* ===== MODALE OPTIONS BURGER ===== */
#optionsModal .modal-header {
    border-bottom: 1px solid #dee2e6;
    background: transparent;
}

#optionsModal .modal-title {
    font-weight: 500;
    color: var(--text-dark);
    font-size: 18px;
}

#optionsModal .form-check-label {
    font-weight: 400;
    color: #555;
    font-size: 14px;
}

#optionsModal .form-check-input:checked {
    background-color: var(--success-color);
    border-color: var(--success-color);
}

#optionsModal .categorie-titre {
    font-weight: 500;
    color: var(--text-dark);
    font-size: 15px;
    margin-bottom: 12px;
    padding-bottom: 5px;
    border-bottom: 1px solid #eee;
}

/* Accord√©ons burger */
#accordionBurgerOptions .accordion-item {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 10px;
    overflow: hidden;
}

#accordionBurgerOptions .accordion-button {
    background-color: var(--bg-light);
    color: var(--text-dark);
    font-weight: 500;
    padding: 15px 20px;
    border: none;
    box-shadow: none;
}

#accordionBurgerOptions .accordion-button:not(.collapsed) {
    background-color: #e9ecef;
    color: var(--text-dark);
}

#accordionBurgerOptions .accordion-button:focus {
    box-shadow: none;
    border-color: var(--primary-color);
}

#accordionBurgerOptions .accordion-body {
    padding: 20px;
    background-color: white;
}

#accordionBurgerOptions .accordion-button span {
    font-size: 18px;
}

/* ===== MODALE SUGGESTIONS ===== */
#suggestionModal .suggestion-grid-container {
    display: block;
    width: 100%;
}

#suggestionModal .suggestion-grid {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 15px !important;
    margin-top: 10px !important;
    width: 100% !important;
}

#suggestionModal .suggestion-item {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    border: 1px solid var(--border-light) !important;
    border-radius: var(--border-radius) !important;
    padding: 15px !important;
    background: white !important;
    transition: all 0.3s ease !important;
    text-align: center !important;
    height: auto !important;
    width: 100% !important;
    box-sizing: border-box !important;
    cursor: pointer !important;
    position: relative !important;
}

#suggestionModal .suggestion-item:hover {
    border-color: var(--primary-color) !important;
    box-shadow: var(--shadow-medium) !important;
    background-color: var(--bg-light) !important;
    transform: translateY(-2px) !important;
}

#suggestionModal .suggestion-item.selected {
    border-color: var(--success-color) !important;
    background-color: #f8fff9 !important;
    box-shadow: 0 0 0 3px rgba(25, 135, 84, 0.25) !important;
}

#suggestionModal .suggestion-item .img-thumbnail {
    width: 120px !important;
    height: 120px !important;
    object-fit: cover !important;
    border-radius: 10px !important;
    margin-bottom: 12px !important;
    border: 2px solid #f0f0f0 !important;
    transition: all 0.3s ease !important;
}

#suggestionModal .suggestion-item:hover .img-thumbnail {
    border-color: var(--primary-color) !important;
    transform: scale(1.05) !important;
}

#suggestionModal .suggestion-item.selected .img-thumbnail {
    border-color: var(--success-color) !important;
}

#suggestionModal .suggestion-content {
    flex-grow: 1 !important;
    margin-bottom: 10px !important;
    width: 100% !important;
}

#suggestionModal .suggestion-item h6 {
    font-weight: 400 !important;
    font-size: 15px !important;
    color: var(--text-dark) !important;
    margin-bottom: 6px !important;
    line-height: 1.4 !important;
    width: 100% !important;
}

#suggestionModal .suggestion-item .price {
    font-weight: 600 !important;
    color: var(--primary-color) !important;
    font-size: 16px !important;
    margin: 0 !important;
}

#suggestionModal .suggestion-item .form-check {
    margin-top: 8px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    width: 100% !important;
    pointer-events: none !important;
}

#suggestionModal .suggestion-item .form-check-input {
    transform: scale(1.1) !important;
    margin-right: 8px !important;
    pointer-events: none !important;
}

#suggestionModal .suggestion-item .form-check-label {
    font-size: 13px !important;
    color: var(--text-muted) !important;
    cursor: pointer !important;
    margin: 0 !important;
    pointer-events: none !important;
    font-weight: 500 !important;
}

#suggestionModal .suggestion-item::after {
    content: "‚úì";
    position: absolute;
    top: 10px !important;
    right: 10px !important;
    width: 22px !important;
    height: 22px !important;
    background: var(--success-color);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px !important;
    opacity: 0;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

#suggestionModal .suggestion-item.selected::after {
    opacity: 1;
    transform: scale(1.1);
}

/* ===== SECTION BURGERS ===== */
#burgers-section {
    margin-top: 20px;
    padding: 0 15px;
}

/* Boutons sous-cat√©gories burgers */
.burger-subcategory-btn {
    padding: 12px 20px;
    font-weight: 500;
    border: 2px solid var(--warning-color);
    background: transparent;
    color: var(--warning-color);
    transition: all 0.3s ease;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
}

.burger-subcategory-btn.active {
    background-color: var(--warning-color);
    color: white;
    border-color: var(--warning-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
}

.burger-subcategory-btn:not(.active):hover {
    background-color: var(--warning-color);
    color: white;
    border-color: var(--warning-color);
}

.burger-subcategory-btn[data-loading="true"] {
    opacity: 0.7;
    pointer-events: none;
}

/* Conteneurs burgers */
.burgers-subcategory {
    margin-top: 20px;
    animation: fadeIn 0.4s ease-in-out;
    overflow: visible !important;
    min-height: 200px;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Layout burgers mobile */
.burger-list-mobile {
    display: flex !important;
    flex-direction: column !important;
    gap: 20px !important;
    width: 100% !important;
}

.burger-item {
    transition: none !important;
    transform: none !important;
}

/* ===== COMPOSANT POULET ===== */
.categorie-header h6 {
    color: #2d3748;
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 12px;
    padding-bottom: 6px;
    border-bottom: 1px solid #e2e8f0;
}

/* Assaisonnements */
.assaisonnement-poulet-container .form-check {
    margin-bottom: 8px;
    padding: 4px 0;
    border: none !important;
    background: transparent !important;
    display: flex;
    align-items: center;
    min-height: auto;
    justify-content: space-between;
    flex-direction: row-reverse;
    gap: 15px;
}

.assaisonnement-poulet-container .form-check-input {
    margin: 0 !important;
    transform: scale(1);
    order: 2;
    flex-shrink: 0;
    background-color: white;
    border-color: #6b7280;
}

.assaisonnement-poulet-container .form-check-input:checked {
    background-color: var(--success-color);
    border-color: var(--success-color);
}

.assaisonnement-poulet-container .form-check-label {
    font-size: 14px;
    color: #4a5568;
    cursor: pointer;
    padding: 0;
    transition: all 0.2s ease;
    font-weight: 400;
    line-height: 1.3;
    order: 1;
    flex-grow: 1;
    margin: 0 !important;
}

/* Grilles options poulet */
.accompagnement-poulet-container,
.sauce-poulet-container,
.supplement-poulet-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px 16px;
    margin-bottom: 16px;
}

/* Options avec quantit√©s */
.option-row {
    background: none;
    border: none !important;
    padding: 6px 0 !important;
    margin-bottom: 0;
    border-radius: 0;
    display: flex;
    flex-direction: column;
    min-height: auto;
}

.option-info {
    min-width: auto;
    margin-bottom: 4px;
}

.option-info .option-nom {
    font-size: 13px;
    color: #2d3748;
    font-weight: 400;
    line-height: 1.3;
    margin-bottom: 2px;
}

.option-info .option-prix {
    font-size: 12px;
    font-weight: 500;
    margin: 0;
}

.option-info .option-prix.text-success {
    color: #38a169 !important;
}

.option-info .option-prix.text-muted {
    color: #718096 !important;
}

/* S√©lecteurs quantit√© */
.quantity-selector {
    min-width: auto;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 4px;
}

.btn-plus, .btn-moins {
    width: 20px !important;
    height: 20px !important;
    border-radius: 2px;
    border: 1px solid #cbd5e0;
    background: white;
    color: #4a5568;
    font-size: 9px !important;
    font-weight: 300 !important;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    padding: 0;
    flex-shrink: 0;
}

.btn-plus:hover, .btn-moins:hover {
    border-color: var(--danger-color);
    color: var(--danger-color);
    background: white;
}

.quantity-display {
    min-width: 18px;
    font-size: 12px !important;
    font-weight: 600;
    color: #2d3748;
    text-align: center;
}

/* Compteurs */
.limite-counter {
    font-size: 11px;
    color: #718096;
    margin-top: 6px;
    grid-column: 1 / -1;
}

.limite-counter.text-danger {
    color: var(--danger-color) !important;
    font-weight: 600;
}

/* ===== MOYENS DE PAIEMENT ===== */
.moyen-paiement-item {
    display: flex;
    flex-direction: row;
    align-items: center;
    border: 1px solid #ddd;
    border-radius: 10px;
    background-color: #fff;
    padding: 16px;
    margin: 12px auto;
    width: 100%;
    max-width: 500px;
    font-family: inherit;
    gap: 16px;
    transition: all 0.3s ease;
}

.moyen-paiement-item.disabled {
    opacity: 0.4;
    pointer-events: none;
}

.logo-container {
    width: 70px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.moyen-paiement-label {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.label-title {
    font-size: 16px;
    font-weight: 500;
    color: #222;
}

.label-description {
    font-size: 14px;
    color: #555;
    font-style: italic;
}

.text-orange {
    color: #cc7a00;
}

.disabled-text {
    font-size: 13px;
    color: #888;
    font-style: italic;
}

/* ===== BOUTON PANIER MOBILE ===== */
#open-cart-btn {
    position: fixed !important;
    bottom: 25px !important;
    right: 25px !important;
    z-index: 9999 !important;
    background: linear-gradient(135deg, var(--primary-color), #ff8c42);
    color: white;
    width: 65px;
    height: 65px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 6px 20px rgba(255, 102, 0, 0.4);
    transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    text-decoration: none;
    border: 3px solid white;
}

#open-cart-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 8px 25px rgba(255, 102, 0, 0.6);
    background: linear-gradient(135deg, #e55a00, #ff7a2e);
}

#open-cart-btn i {
    font-size: 26px;
}

.cart-badge-mobile {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--danger-color);
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 12px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

/* ===== R√âGLAGES COUSCOUS ===== */
#viande-options {
    display: flex;
    flex-wrap: wrap;
    gap: 10px 20px;
}

.viande-col {
    flex: 0 0 48%;
}

.viande-bloc {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    font-size: 15px;
}

.viande-bloc label {
    margin: 0;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.viande-bloc .btn {
    padding: 2px 8px;
    font-size: 13px;
    line-height: 1;
}

.viande-bloc .quantite {
    min-width: 20px;
    text-align: center;
    font-weight: 500;
}

/* ===== MEDIA QUERIES RESPONSIVE ===== */

/* Tablette */
@media (max-width: 992px) {
    #suggestionModal .suggestion-grid {
        grid-template-columns: repeat(2, 1fr) !important;
    }
    
    #suggestionModal .suggestion-item .img-thumbnail {
        width: 110px !important;
        height: 110px !important;
    }
    
    #burgers-classique-list,
    #burgers-gourmet-list {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 20px !important;
    }
}

/* Mobile */
@media (max-width: 768px) {
    /* Suggestions */
    #suggestionModal .suggestion-grid {
        grid-template-columns: 1fr !important;
    }
    
    #suggestionModal .suggestion-item {
        padding: 20px !important;
        flex-direction: row !important;
        text-align: left !important;
        gap: 15px !important;
    }
    
    #suggestionModal .suggestion-item .img-thumbnail {
        width: 100px !important;
        height: 100px !important;
        margin-bottom: 0 !important;
        flex-shrink: 0 !important;
    }
    
    #suggestionModal .suggestion-item::after {
        top: 15px !important;
        right: 15px !important;
    }
    
    /* Burgers */
    #burgers-classique-list,
    #burgers-gourmet-list {
        display: flex !important;
        flex-direction: column !important;
        height: auto !important;
        transform: none !important;
        gap: 20px !important;
    }
    
    #burgers-classique-list .card-container,
    #burgers-gourmet-list .card-container {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0 10px !important;
        opacity: 1 !important;
        visibility: visible !important;
        transform: none !important;
        position: relative !important;
    }
    
    .burgers-subcategory {
        display: none;
        padding: 0 5px;
    }
    
    .burgers-subcategory[style*="display: block"] {
        display: block !important;
        animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .burger-list-mobile .burger-item {
        margin: 0 10px 25px 10px !important;
        padding: 15px !important;
        background: white;
        border-radius: 12px;
        box-shadow: var(--shadow-light);
    }
    
    /* Poulet */
    .accompagnement-poulet-container,
    .sauce-poulet-container,
    .supplement-poulet-container {
        grid-template-columns: 1fr;
        gap: 6px;
    }
    
    .option-row {
        padding: 8px 0 !important;
    }
    
    .option-info .option-nom {
        font-size: 14px;
    }
    
    .quantity-selector {
        min-width: 90px;
    }
    
    .btn-plus, .btn-moins {
        width: 26px;
        height: 26px;
    }
    
    /* Panier mobile */
    #open-cart-btn {
        bottom: 20px !important;
        right: 20px !important;
    }
    
    /* Moyens de paiement */
    .moyen-paiement-item {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .logo-container {
        margin-bottom: 8px;
    }
    
    .moyen-paiement-label {
        width: 100%;
    }
    
    /* Accord√©ons */
    #accordionBurgerOptions .accordion-body .row {
        flex-direction: column;
    }
    
    #accordionBurgerOptions .accordion-body .col-md-6 {
        width: 100%;
    }
}

/* Tr√®s petits mobiles */
@media (max-width: 480px) {
    #suggestionModal .suggestion-item {
        padding: 15px !important;
        gap: 12px !important;
    }
    
    #suggestionModal .suggestion-item .img-thumbnail {
        width: 80px !important;
        height: 80px !important;
    }
}

/* Desktop */
@media (min-width: 992px) {
    #open-cart-btn {
        display: none;
    }
    
    .burger-subcategory-btn {
        padding: 14px 24px;
        font-size: 15px;
    }
    
    .burgers-subcategory {
        margin-top: 30px;
    }
}

/* Grands √©crans */
@media (min-width: 1200px) {
    #suggestionModal .suggestion-grid {
        grid-template-columns: repeat(3, 1fr) !important;
    }
}

/* Styles pour les limites minimales */
.limite-counter.text-warning {
    color: #f39c12 !important;
    font-weight: 600;
}

.categorie-header h6 {
    color: #2d3748;
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 12px;
    padding-bottom: 6px;
    border-bottom: 1px solid #e2e8f0;
}

/* Indicateur visuel pour les options obligatoires */
.option-obligatoire::after {
    content: " *";
    color: #e74c3c;
}

.viande-bloc {
    padding: 2px 0;
    margin-bottom: 0;
    background: transparent;
    display: flex;
    align-items: center;
    gap: 8px;
}

.viande-nom {
    font-weight: 600;
    color: #5a3921;
    margin-bottom: 0 !important;
    flex: 1;
}

.viande-prix {
    font-size: 0.85rem;
    margin-left: auto;
}

.viande-prix-mobile {
    font-size: 0.8rem;
    margin-top: 0;
}

/* Sur mobile, le prix s'affiche en dessous du nom */
@media (max-width: 768px) {
    .viande-bloc {
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
    }
    .viande-prix {
        display: none !important;
    }
    .viande-prix-mobile {
        display: block !important;
        margin-left: 0;
    }
}

/* Sur desktop, le prix s'affiche √† c√¥t√© du nom */
@media (min-width: 769px) {
    .viande-prix {
        display: block !important;
    }
    .viande-prix-mobile {
        display: none !important;
    }
}

/* ===== STYLES √âPUR√âS POUR LES MENUS - VERSION CORRIG√âE ===== */
.menu-section {
    margin-bottom: 25px;
    padding: 0;
    background: transparent;
    border: none;
}

.menu-section details {
    background: transparent;
    border: none;
    margin-bottom: 15px;
}

.menu-section details[open] {
    background: transparent;
}

.menu-section .section-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border: 1px solid #dee2e6;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    color: #2d3748;
    transition: all 0.3s ease;
    list-style: none;
    gap: 15px; /* Espace entre le texte et le badge */
}

.menu-section .section-title:hover {
    background: linear-gradient(135deg, #e9ecef, #dee2e6);
    border-color: #adb5bd;
}

.menu-section .section-title::-webkit-details-marker {
    display: none;
}

.menu-section .section-title::after {
    content: "‚ñº";
    font-size: 12px;
    transition: transform 0.3s ease;
    color: #6c757d;
    flex-shrink: 0; /* Emp√™che la fl√®che de r√©tr√©cir */
}

.menu-section details[open] .section-title::after {
    transform: rotate(180deg);
}

/* Conteneur pour le texte et le badge */
.menu-section .section-title strong {
    font-weight: 600;
    font-size: 16px;
    flex: 1; /* Prend tout l'espace disponible */
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-right: 15px; /* Espace entre le badge et la fl√®che */
}

/* Badge align√© √† droite pr√®s du texte */
.menu-section .badge {
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 12px;
    margin-left: auto; /* Pousse le badge vers la droite */
    flex-shrink: 0; /* Emp√™che le badge de r√©tr√©cir */
    order: 2; /* S'assure que le badge soit apr√®s le texte */
}

/* Ajustement pour les √©crans mobiles */
@media (max-width: 768px) {
    .menu-section .section-title {
        padding: 12px 15px;
        font-size: 14px;
        gap: 10px;
    }
    
    .menu-section .section-title strong {
        font-size: 14px;
        margin-right: 10px;
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
    
    .menu-section .badge {
        align-self: flex-end;
        margin-top: -20px; /* Remonte le badge pour l'aligner */
        margin-bottom: 5px;
    }
}

/* Grille des options */
.menu-section .options-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
    margin-top: 15px;
    padding: 0 10px;
}

.menu-section .option-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    transition: all 0.2s ease;
    margin: 0;
}

.menu-section .option-item:hover {
    border-color: #007bff;
    background: #f8f9fa;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.menu-section .form-check {
    display: flex;
    align-items: center;
    width: 100%;
    margin: 0;
    padding: 0;
}

.menu-section .form-check-input {
    margin-right: 12px;
    transform: scale(1.1);
    border: 2px solid #adb5bd;
}

.menu-section .form-check-input:checked {
    background-color: #28a745;
    border-color: #28a745;
}

.menu-section .form-check-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    margin: 0;
    padding: 0;
    cursor: pointer;
    font-weight: 400;
    color: #495057;
}

.menu-section .option-nom {
    flex: 1;
    font-size: 14px;
    color: #2d3748;
}

.menu-section .prix-supplement {
    color: #28a745;
    font-weight: 600;
    font-size: 13px;
    margin-left: 8px;
}

.menu-section .prix-inclus {
    color: #6c757d;
    font-size: 13px;
    font-style: italic;
    margin-left: 8px;
}

/* Animation d'ouverture */
.menu-section details[open] {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* √âtats d√©sactiv√©s */
.menu-section .form-check-input:disabled {
    background-color: #e9ecef;
    border-color: #ced4da;
    cursor: not-allowed;
}

.menu-section .form-check-input:disabled + .form-check-label {
    color: #6c757d;
    cursor: not-allowed;
}


</style>
    
  
   
    
    
    

    {% endblock %}
