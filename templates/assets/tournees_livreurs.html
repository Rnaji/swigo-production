{% extends 'assets/base.html' %}
{% load static %}

{% block title %}
    Tourn√©es des Livreurs
{% endblock %}

{% block content %}
<h1 class="text-center">
    <img src="{% static 'assets/flaticon/livraison-de-nourriture.png' %}" alt="Ic√¥ne de livraison de nourriture" style="width: 72px; height: 72px;">
</h1>
<div class="accordion mt-3" id="tourneesAccordion">
    {% for data in tournees_data %}
        {% with tournee=data.tournee %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading-{{ tournee.nom }}">
                    <button class="accordion-button collapsed" type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse-{{ tournee.nom }}"
                            aria-expanded="false"
                            aria-controls="collapse-{{ tournee.nom }}">
                        Tourn√©e pour le livreur {{ tournee.livreur }} - {{ tournee.nom }}
                    </button>
                </h2>
                <div id="collapse-{{ tournee.nom }}" class="accordion-collapse collapse"
                     aria-labelledby="heading-{{ tournee.nom }}"
                     data-bs-parent="#tourneesAccordion">
                    <div class="accordion-body" id="tournee-{{ tournee.nom }}" data-figee="{{ tournee.is_figee|yesno:'1,0' }}">
                        <p>
                            <strong>Date de la tourn√©e :</strong>
                            {{ tournee.date_tournee|default:"-"|slice:":10" }}  <!-- affiche '2025-06-05' -->
                        </p>
                        <p>
                            <strong>Heure de retour pr√©vue :</strong>
                            <span class="heure-retour">
                                {{ tournee.heure_retour_estime }}
                            </span>
                            
                        </p>

                        <h3>Commandes dans cette tourn√©e</h3>
                        <ul class="commandes-list">
                            <li class="fixed-item" style="font-weight: bold;">
                                D√©part - En Route Chef!
                                <span class="trajet-duree"></span> -
                                Heure de d√©part :
                                <span class="heure-depart" data-heure-depart="{{ tournee.heure_depart }}">
                                    {{ tournee.heure_depart }}
                                </span>
                                
                            </li>
                            {% for commande in data.commandes %}
                                <li id="commande-{{ commande.id }}"
                                    class="commande-item commande-heure"
                                    style="cursor: pointer;"
                                    onclick="ouvrirModalCommande(
                                        '{{ commande.id }}',
                                        '{{ commande.latitude }}',
                                        '{{ commande.longitude }}',
                                        '{{ commande.telephone }}',
                                        '{{ commande.has_message_for_livreur }}',
                                        '{{ commande.message_pour_livreur|escapejs }}',
                                        '{{ commande.paiement_a_recevoir }}')">
                                    {% if commande.is_delivered %}
                                        <span class="text-success">&#10004;</span>
                                    {% endif %}
                                    <strong>Commande #{{ commande.id }}</strong> - {{ commande.adresse }}
                                    <span class="trajet-duree">
                                        {% if commande.heure_passage %}
                                            - Heure de passage estim√©e : {{ commande.heure_passage }}
                                        {% endif %}
                                    </span>
                                </li>
                            {% empty %}
                                <li>Aucune commande associ√©e √† cette tourn√©e.</li>
                            {% endfor %}
                            <li class="fixed-item" style="font-weight: bold;">
                                Arriv√©e - En Route Chef!
                                <span class="trajet-duree"></span>
                                <span class="heure-arrivee"></span>
                            </li>
                        </ul>
                        <p class="temps-total-tournee">
                            <span class="temps-total">Calcul en cours...</span>
                        </p>
                        <div class="text-center mt-4">
                            <button id="demarrerTourneeButton-{{ tournee.nom }}"
                                    onclick="demarrerTournee('{{ tournee.nom }}')"
                                    class="btn btn-primary py-2 px-4 fw-semibold text-white"
                                    {% if tournee.is_figee %}disabled{% endif %}>
                                C'est parti
                            </button>
                            <button onclick="marquerRetour('{{ tournee.nom }}')"
                                    class="btn btn-secondary py-2 px-4 fw-semibold text-white">
                                De retour
                            </button>
                        </div>
                        <div id="qrcode-{{ tournee.nom }}" class="text-center mt-3"></div>
                    </div>
                </div>
            </div>
        {% endwith %}
    {% endfor %}
</div>




<!-- Modal de commande avec les ic√¥nes d'actions -->
<div class="modal fade" id="commandeModal" tabindex="-1" aria-labelledby="commandeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commandeModalLabel">Commande #</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Ic√¥nes d'actions en tant que boutons -->
                <div class="action-icons d-flex justify-content-around mt-3">
                    <button type="button" class="btn btn-outline-secondary" onclick="envoyerSMS()">
                        <img src="{% static 'assets/flaticon/039-messages.png' %}" alt="SMS" style="width: 24px; height: 24px;"> SMS
                    </button>
                    <button id="gpsButton" type="button" class="btn btn-outline-secondary">
                        <img src="{% static 'assets/flaticon/waze.png' %}" alt="GPS" style="width: 24px; height: 24px;"> GPS
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="appelerTelephone()">
                        <img src="{% static 'assets/flaticon/038-appel-telephonique.png' %}" alt="Appeler" style="width: 24px; height: 24px;"> CALL
                    </button>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <!-- Bouton Commande Livr√©e qui ouvre la modal de confirmation -->
                <button type="button" class="btn btn-success" onclick="ouvrirModalConfirmation()">Commande Livr√©e</button>
                <!-- Bouton Fermer -->
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation pour marquer la commande comme livr√©e -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">Confirmer la Livraison</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                √ätes-vous s√ªr de vouloir marquer cette commande comme livr√©e ?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-success" onclick="confirmerLivraison()" id="livraisonButton">
                    Commande Livr√©e
                </button>
            </div>
        </div>
    </div>
</div>






<!-- JSON des coordonn√©es pour calcul des trajets -->
{{ commandes|json_script:"commandes_data" }}

<script>
    // Acc√©der aux donn√©es JSON depuis le script int√©gr√©
    const commandesData = JSON.parse(document.getElementById("commandes_data").textContent);
    console.log(commandesData);
    // Utilisez `commandesData` dans votre JavaScript pour afficher ou manipuler les commandes
</script>


<!-- Import de jQuery et Google Maps API (pour utiliser DistanceMatrixService) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyChxLP7_um9XUuGA3rHlUPTQuB7SRFuSNk"></script>

<script>

function toLocalIsoString(d) {
    return d.getFullYear() + '-' +
        String(d.getMonth() + 1).padStart(2, '0') + '-' +
        String(d.getDate()).padStart(2, '0') + 'T' +
        String(d.getHours()).padStart(2, '0') + ':' +
        String(d.getMinutes()).padStart(2, '0') + ':' +
        String(d.getSeconds()).padStart(2, '0');
}

document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.accordion-collapse').forEach(item => {
        item.addEventListener('shown.bs.collapse', function (event) {
            const tourneeNom = event.target.getAttribute('id').replace('collapse-', '');
            const tourneeElement = document.querySelector(`#tournee-${tourneeNom}`);

            // STOP si tourn√©e fig√©e
            const isFigee = tourneeElement.getAttribute('data-figee') === '1';
            if (isFigee) {
                console.log(`‚è≥ Tourn√©e ${tourneeNom} d√©j√† fig√©e (flag DB), aucun recalcul ni AJAX`);
                return;
            }

            const heureDepartElem = tourneeElement.querySelector('.heure-depart');
            const heureDepartStr = heureDepartElem ? heureDepartElem.getAttribute('data-heure-depart') : null;

            let dejaCalcule = false;
            if (heureDepartStr) {
                const trajetsCommande = Array.from(tourneeElement.querySelectorAll('.commande-item .trajet-duree'));
                const toutRempli = trajetsCommande.length > 0 &&
                    trajetsCommande.every(span => span.textContent.trim().startsWith('- Heure de passage estim√©e :'));
                const heureRetourText = tourneeElement.querySelector('.heure-retour')?.textContent.trim();
                if (toutRempli && heureRetourText && heureRetourText !== "Non sp√©cifi√©e") {
                    dejaCalcule = true;
                }
            }

            if (dejaCalcule) {
                console.log(`‚è≥ Tourn√©e ${tourneeNom} d√©j√† fig√©e c√¥t√© front, aucun recalcul JS, aucune requ√™te AJAX`);
                return;
            }

            if (!heureDepartStr) {
                const tempsTotalElem = tourneeElement.querySelector('.temps-total');
                if (tempsTotalElem) {
                    tempsTotalElem.textContent = "La tourn√©e n‚Äôa pas encore commenc√©. Cliquez sur 'C‚Äôest parti' pour d√©marrer.";
                }
                return;
            }

            // Dernier recours (premier lancement)
            const heureDepartObj = new Date(heureDepartStr);
            calculerTempsDeTrajet(tourneeNom, heureDepartObj);
        });
    });
});






let heureDepart; // Global, OK

function demarrerTournee(tourneeNom) {
    const tourneeElement = document.querySelector(`#tournee-${tourneeNom}`);

    heureDepart = new Date(new Date().getTime() + 3 * 60 * 1000); // +3min
    const heureDepartLocal = toLocalIsoString(heureDepart); // <- CORRECT



    const demarrerButton = document.getElementById(`demarrerTourneeButton-${tourneeNom}`);
    if (demarrerButton) {
        demarrerButton.disabled = true;
    }

    $.ajax({
        url: '/api/demarrer-tournee/',
        type: 'POST',
        data: { 
            heure_depart: heureDepartLocal,   // <-- On n'utilise plus toISOString
            tournee_nom: tourneeNom
        },
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    })
    
    .done(function(response) {
        console.log(`D√©marrage de la tourn√©e ${tourneeNom} r√©ussi :`, response);

        // üü¢ Marque la tourn√©e comme fig√©e c√¥t√© DOM
        if (tourneeElement) {
            tourneeElement.setAttribute('data-figee', '1');
        }
        // D√©sactive le bouton (s√©curit√©)
        if (demarrerButton) {
            demarrerButton.disabled = true;
        }

        // Optionnel : badge visuel
        let badge = tourneeElement.querySelector('.badge-figee');
        if (!badge) {
            badge = document.createElement('div');
            badge.className = "badge-figee";
            badge.style.cssText = "color:white;background:#888;padding:0.4em 1em;border-radius:1em;display:inline-block;margin:1em 0;";
            badge.innerText = "Tourn√©e fig√©e";
            tourneeElement.prepend(badge);
        }

        // Affichage statique seulement
        const heureDepartElem = tourneeElement.querySelector('.heure-depart');
        if (heureDepartElem) {
            heureDepartElem.setAttribute('data-heure-depart', heureDepartLocal);
            heureDepartElem.textContent = "Heure de d√©part : " + heureDepartLocal.slice(11, 19); // format HH:MM:SS
        }


        // Calcul visuel si tu veux, mais aucun POST derri√®re !
        calculerTempsDeTrajet(tourneeNom, heureDepart);

    })
    .fail(function(xhr, status, error) {
        console.error(`Erreur lors du d√©marrage de la tourn√©e ${tourneeNom} :`, error);
        if (demarrerButton) {
            demarrerButton.disabled = false;
        }
    });
}




function calculerTempsDeTrajet(nomTournee, heureDepart) {
    if (!heureDepart) {
        console.error("Erreur : heure de d√©part non d√©finie.");
        return;
    }

    console.log(`Calcul du temps de trajet pour la tourn√©e ${nomTournee}`);
    $.ajax({
        url: `/api/tournee/${nomTournee}/adresses/`,
        method: "GET",
        success: function(data) {
            if (data.length === 0) {
                console.error(`Aucune commande dans la tourn√©e ${nomTournee}.`);
                return;
            }

            // Trier les commandes par ordre avant de faire les calculs
            data.sort((a, b) => a.ordre - b.ordre);

            let tempsTotal = 0;
            let tempsTotalChezClient = data.length * 3 * 60; // Temps pass√© chez chaque client (3 minutes par client)
            const service = new google.maps.DistanceMatrixService();
            const origineRestaurant = { lat: 49.27153667708692, lng: 1.7812730971414836 };
            let heuresPassageData = [];

            // Premier trajet : du restau √† la premi√®re commande
            service.getDistanceMatrix({
                origins: [origineRestaurant],
                destinations: [{ lat: parseFloat(data[0].latitude), lng: parseFloat(data[0].longitude) }],
                travelMode: 'DRIVING',
            }, function(response, status) {
                if (status === 'OK') {
                    const duree = response.rows[0].elements[0].duration.value;
                    tempsTotal += duree;
                    const premiereHeurePassage = new Date(heureDepart.getTime() + tempsTotal * 1000);
                    const premiereHeurePassageISO = toLocalIsoString(premiereHeurePassage);
                    heuresPassageData.push({ commande_id: data[0].id, heure_passage: premiereHeurePassageISO });

                    const firstCommandeItem = document.querySelector(`#tournee-${nomTournee} li:nth-child(2) .trajet-duree`);
                    if (firstCommandeItem) {
                        firstCommandeItem.textContent = ` - Temps de trajet : ${Math.round(duree / 60)} minutes - Heure de passage : ${premiereHeurePassageISO.slice(11, 19)}`;
                    }

                    if (data.length === 1) {
                        calculerTempsRetour(nomTournee, service, data[0], tempsTotal, tempsTotalChezClient, heuresPassageData, heureDepart);
                        return;
                    }
                    calculerTempsEntreCommandes(nomTournee, data, tempsTotal, tempsTotalChezClient, service, heuresPassageData, heureDepart);
                } else {
                    console.error(`Erreur avec DistanceMatrix pour la tourn√©e ${nomTournee} : ` + status);
                }
            });
        },
        error: function(xhr, status, error) {
            console.error(`Erreur lors de la r√©cup√©ration des adresses de la tourn√©e ${nomTournee} :`, error);
        }
    });
}




function calculerTempsEntreCommandes(nomTournee, data, tempsTotal, tempsTotalChezClient, service, heuresPassageData, heureDepart) {
    let calculsEffectues = 0;
    const totalCalculs = data.length - 1;

    for (let i = 1; i < data.length; i++) {
        const origine = { lat: parseFloat(data[i - 1].latitude), lng: parseFloat(data[i - 1].longitude) };
        const destination = { lat: parseFloat(data[i].latitude), lng: parseFloat(data[i].longitude) };

        service.getDistanceMatrix({
            origins: [origine],
            destinations: [destination],
            travelMode: 'DRIVING',
        }, function(response, status) {
            if (status === 'OK') {
                const duree = response.rows[0].elements[0].duration.value;
                tempsTotal += duree + 3 * 60; // 3 min chez client pr√©c√©dent
                const heurePassage = new Date(heureDepart.getTime() + tempsTotal * 1000);
                const heurePassageISO = toLocalIsoString(heurePassage);

                heuresPassageData.push({ commande_id: data[i].id, heure_passage: heurePassageISO });

                const allCommandes = document.querySelectorAll(`#tournee-${nomTournee} .commande-heure`);
                const listItem = allCommandes[i]?.querySelector('.trajet-duree');
                if (listItem) {
                    listItem.textContent = ` - Temps de trajet : ${Math.round(duree / 60)} minutes - Heure de passage : ${heurePassageISO.slice(11, 19)}`;
                }

                calculsEffectues++;
                if (calculsEffectues === totalCalculs) {
                    calculerTempsRetour(nomTournee, service, data[data.length - 1], tempsTotal, tempsTotalChezClient, heuresPassageData, heureDepart);
                }
            } else {
                console.error(`Erreur avec DistanceMatrix entre commandes pour la tourn√©e ${nomTournee} : ` + status);
            }
        });
    }
}



function calculerTempsRetour(nomTournee, service, derniereCommande, tempsTotal, tempsTotalChezClient, heuresPassageData, heureDepart) {
    const restaurantCoords = { lat: 49.27153667708692, lng: 1.7812730971414836 };

    service.getDistanceMatrix({
        origins: [{
            lat: parseFloat(derniereCommande.latitude),
            lng: parseFloat(derniereCommande.longitude)
        }],
        destinations: [restaurantCoords],
        travelMode: 'DRIVING',
    }, function(response, status) {
        if (status === 'OK') {
            const duree = response.rows[0].elements[0].duration.value;
            tempsTotal += duree;

            const heureArrivee = new Date(heureDepart.getTime() + (tempsTotal + 3 * 60) * 1000); // 3 min pour retour
            const heureArriveeISO = toLocalIsoString(heureArrivee);
            const formattedHeureArrivee = heureArriveeISO.slice(11, 19);

            // Mise √† jour DOM
            const retourElement = document.querySelector(`#tournee-${nomTournee} .heure-retour`);
            if (retourElement) {
                retourElement.textContent = formattedHeureArrivee;
            }

            const arriveeElement = document.querySelector(`#tournee-${nomTournee} .heure-arrivee`);
            if (arriveeElement) {
                arriveeElement.textContent = `Temps de trajet : ${Math.round(duree / 60)} minutes - Heure d'arriv√©e : ${formattedHeureArrivee}`;
            }

            // Appel AJAX pour enregistrer l'heure de retour estim√©e
            $.ajax({
                url: `/api/tournee/${nomTournee}/update-heure-retour-estime/`,
                type: 'POST',
                data: {
                    heure_retour_estime: heureArriveeISO
                },
                success: function(response) {
                    console.log(`‚úÖ Heure de retour enregistr√©e pour la tourn√©e ${nomTournee}.`, response);
                },
                error: function(xhr, status, error) {
                    console.error(`‚ùå Erreur lors de la mise √† jour de l'heure de retour pour la tourn√©e ${nomTournee} :`, xhr.responseText || error);
                }
            });

            afficherTempsTotal(tempsTotal + 3 * 60, tempsTotalChezClient, nomTournee);
            envoyerHeuresPassage(heuresPassageData);

        } else {
            console.error(`‚ùå Erreur DistanceMatrix API (retour) pour la tourn√©e ${nomTournee} : ` + status);
        }
    });
}



function afficherTempsTotal(tempsTotal, tempsTotalChezClient, nomTournee) {
    const tourneeContainer = document.querySelector(`#tournee-${nomTournee}`);
    
    // V√©rification de l'existence de `tourneeContainer`
    if (!tourneeContainer) {
        console.error(`Conteneur de la tourn√©e introuvable pour le nom : ${nomTournee}`);
        return;  // Arr√™te l'ex√©cution de la fonction
    }

    const tempsTotalElement = tourneeContainer.querySelector('.temps-total');
    
    if (!tempsTotalElement) {
        console.error(`√âl√©ment temps-total introuvable dans la tourn√©e : ${nomTournee}`);
        return;
    }

    const totalMinutesDeRoute = Math.floor((tempsTotal - tempsTotalChezClient - 3 * 60) / 60);
    const totalMinutesChezClient = Math.floor(tempsTotalChezClient / 60);
    const totalAvecPreparation = totalMinutesDeRoute + totalMinutesChezClient + 3;

    tempsTotalElement.textContent = `Temps total de la tourn√©e : ${totalAvecPreparation} minutes (3 minutes de pr√©paration + ${totalMinutesDeRoute} minutes de route + ${totalMinutesChezClient} minutes chez les clients)`;
}

function envoyerHeuresPassage(data) {
    // Bloque si tourn√©e fig√©e
    const tourneeNom = data.length ? data[0].tournee_nom || data[0].tourneeNom || null : null;
    if (tourneeNom) {
        const tourneeElement = document.querySelector(`#tournee-${tourneeNom}`);
        if (tourneeElement && tourneeElement.getAttribute('data-figee') === '1') {
            console.log("‚õî Tourn√©e d√©j√† fig√©e, aucun envoi AJAX.");
            return;
        }
    }

    $.ajax({
        url: '/api/tournee/update-heures-passage/',
        type: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        data: JSON.stringify(data),
        contentType: 'application/json',
        success: function(response) {
            console.log("Heures de passage enregistr√©es avec succ√®s.", response);
        },
        error: function(xhr, status, error) {
            if (xhr.status === 403) {
                console.warn("‚õî Heures d√©j√† fig√©es c√¥t√© serveur, enregistrement interdit !");
                // Optionnel : message utilisateur
                // alert("Cette tourn√©e est d√©j√† fig√©e, impossible de modifier les horaires.");
            } else {
                console.error("Erreur lors de l'enregistrement des heures de passage :", error);
            }
        }
    });
}






    // Fonction pour appeler le num√©ro de t√©l√©phone
    function appelerTelephone(numeroTelephone) {
        window.location.href = `tel:${numeroTelephone}`;
    }

    // Fonction pour ouvrir Google Maps avec les coordonn√©es fournies
    function ouvrirGPS(latitude, longitude) {
    // Si les coordonn√©es sont des cha√Ænes avec des virgules, remplacer par des points
    if (typeof latitude === 'string') {
        latitude = latitude.replace(',', '.');
    }
    if (typeof longitude === 'string') {
        longitude = longitude.replace(',', '.');
    }

    // URL pour ouvrir directement Waze avec la navigation activ√©e
    const wazeUrl = `https://waze.com/ul?ll=${latitude},${longitude}&navigate=yes`;
    window.open(wazeUrl, '_blank');
}

// REMPLACEZ votre fonction actuelle par celle-ci :
function envoyerSMS() {
    console.log("üì± D√©but envoi SMS...");
    console.log("Commande ID:", currentCommandeId);
    console.log("T√©l√©phone:", currentTelephone);
    
    // V√©rifier si on a un num√©ro
    if (!currentTelephone || currentTelephone === "None" || currentTelephone === "") {
        alert("‚ùå Num√©ro de t√©l√©phone non disponible pour cette commande.");
        return;
    }
    
    // R√©cup√©rer l'heure de passage estim√©e depuis le texte affich√©
    let heurePassageEstimee = "";
    const commandeItem = document.getElementById(`commande-${currentCommandeId}`);
    if (commandeItem) {
        const trajetDureeSpan = commandeItem.querySelector('.trajet-duree');
        if (trajetDureeSpan) {
            // Extraire juste l'heure (format HH:MM) du texte
            const texte = trajetDureeSpan.textContent;
            console.log("Texte trajet dur√©e:", texte);
            
            // Recherche du format "HH:MM" dans le texte
            const heureMatch = texte.match(/(\d{1,2}:\d{2})/);
            if (heureMatch) {
                heurePassageEstimee = heureMatch[1];
                console.log("Heure extraite:", heurePassageEstimee);
            }
        }
    }
    
    // Message par d√©faut avec l'heure de passage
    let messageParDefaut;
    if (heurePassageEstimee) {
        messageParDefaut = `Bonjour, c'est votre livreur. Votre commande #${currentCommandeId} sera livr√©e vers ${heurePassageEstimee}.`;
    } else {
        messageParDefaut = `Bonjour, c'est votre livreur. Votre commande #${currentCommandeId} est en route.`;
    }
    
    // Demander le message (avec l'heure pr√©-remplie)
    const messagePersonnalise = prompt("‚úèÔ∏è Entrez votre message SMS :", messageParDefaut);
    
    // Si annul√©
    if (messagePersonnalise === null) {
        console.log("Annul√© par l'utilisateur");
        return;
    }
    
    // Message final
    const messageFinal = messagePersonnalise.trim() || messageParDefaut;
    
    // Nettoyer le num√©ro
    let numeroPropre = currentTelephone.toString().replace(/[^\d+]/g, '');
    
    // Convertir 06... en +33...
    if (numeroPropre.startsWith('0')) {
        numeroPropre = '+33' + numeroPropre.substring(1);
    }
    
    console.log("‚úÖ Num√©ro nettoy√©:", numeroPropre);
    console.log("‚úÖ Message:", messageFinal);
    
    // Encoder pour URL
    const messageEncode = encodeURIComponent(messageFinal);
    
    // Essayer plusieurs formats d'URL SMS
    const smsUrls = [
        `sms:${numeroPropre}?body=${messageEncode}`,
        `sms://${numeroPropre}?body=${messageEncode}`,
        `smsto:${numeroPropre}:${messageEncode}`,
        `mms:${numeroPropre}?body=${messageEncode}`
    ];
    
    let reussi = false;
    
    for (let url of smsUrls) {
        try {
            console.log("Tentative avec:", url);
            window.open(url, '_blank');
            reussi = true;
            console.log("‚úÖ Application SMS ouverte");
            
            // Message de confirmation simple
            setTimeout(() => {
                alert("‚úÖ Application SMS ouverte !\n\nLe message est pr√™t √† √™tre envoy√©.");
            }, 500);
            
            break;
        } catch (e) {
            console.log("√âchec avec:", url);
        }
    }
    
    if (!reussi) {
        // Fallback
        const copier = confirm(
            `üì± Pour envoyer le SMS :\n\n` +
            `Num√©ro: ${numeroPropre}\n` +
            `Message: ${messageFinal}\n\n` +
            `Copier le message dans le presse-papier ?`
        );
        
        if (copier) {
            navigator.clipboard.writeText(messageFinal)
                .then(() => alert("‚úÖ Message copi√© !\nCollez-le dans votre application SMS."))
                .catch(() => alert(`üìù Message √† copier :\n\n${messageFinal}`));
        }
    }
}


    let currentCommandeId;

    function ouvrirModalCommande(id, latitude, longitude, numeroTelephone, hasMessage, messagePourLivreur, paiementARecevoir) {
    currentCommandeId = id;
    currentTelephone = numeroTelephone;
    
    console.log("PAIEMENT √Ä RECEVOIR =", paiementARecevoir);

    // Mettre √† jour le titre de la modal avec le num√©ro de commande
    const modalLabel = document.getElementById('commandeModalLabel');
    modalLabel.textContent = `Commande #${id}`;
    
    // Configurer le bouton GPS pour ouvrir l'application avec les coordonn√©es fournies
    const gpsButton = document.getElementById('gpsButton');
    gpsButton.onclick = () => ouvrirGPS(latitude, longitude);

    // Configurer le bouton Appeler
    const callButton = document.querySelector('#commandeModal .action-icons button[onclick^="appelerTelephone"]');
    callButton.onclick = () => appelerTelephone(numeroTelephone);

    // Pas besoin de modifier les boutons d'action

    // G√©rer le bouton 'Vous avez un message' dans le modal-footer
    const modalFooter = document.querySelector('#commandeModal .modal-footer');

    // Supprimer le bouton 'Vous avez un message' s'il existe d√©j√† pour √©viter les duplications
    const existingMessageButton = document.getElementById('messageLivreurButton');
    if (existingMessageButton) {
        existingMessageButton.remove();
    }

    // Ajouter le bouton si hasMessage est vrai
    if (hasMessage === 'True' || hasMessage === true) {
        const messageButton = document.createElement('button');
        messageButton.type = 'button';
        messageButton.className = 'btn btn-warning';
        messageButton.id = 'messageLivreurButton';
        messageButton.textContent = 'Vous avez un message';
        messageButton.onclick = () => afficherMessageLivreur(messagePourLivreur);

        // Trouver le bouton 'Commande Livr√©e' et 'Fermer'
        const commandeLivreeButton = modalFooter.querySelector('button.btn-success');
        const fermerButton = modalFooter.querySelector('button.btn-danger');

        // Ins√©rer le bouton entre 'Commande Livr√©e' et 'Fermer'
        modalFooter.insertBefore(messageButton, fermerButton);
    }

    // Afficher la modal de commande
    const commandeModal = new bootstrap.Modal(document.getElementById('commandeModal'));
    commandeModal.show();

        // Supprimer le bouton 'Paiement √† recevoir' s'il existe d√©j√†
    const existingPaiementButton = document.getElementById('paiementButton');
    if (existingPaiementButton) {
        existingPaiementButton.remove();
    }

    if (paiementARecevoir === 'true') {
        const paiementButton = document.createElement('button');
        paiementButton.type = 'button';
        paiementButton.className = 'btn btn-outline-danger';
        paiementButton.id = 'paiementButton';
        paiementButton.textContent = 'Paiement √† recevoir';
        paiementButton.onclick = () => {
            alert('Le livreur doit r√©cup√©rer un paiement pour cette commande.');
        };

        const modalFooter = document.querySelector('#commandeModal .modal-footer');
        const fermerButton = modalFooter.querySelector('button.btn-danger');
        modalFooter.insertBefore(paiementButton, fermerButton);
        console.log("‚úÖ Bouton 'Paiement √† recevoir' ins√©r√© !");

    }

}

// Fonction pour afficher une modal de confirmation avant de marquer la commande comme livr√©e
function ouvrirModalConfirmation() {
    // Afficher la modal de confirmation
    const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    confirmationModal.show();
}

// Fonction pour confirmer la livraison de la commande
function confirmerLivraison() {
    // Fermer la modal de confirmation
    const confirmationModal = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));
    confirmationModal.hide();

    // Envoyer une requ√™te AJAX pour marquer la commande comme livr√©e
    $.ajax({
        url: `/api/commande/${currentCommandeId}/set-delivered/`,
        type: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        success: function(response) {
            alert("Commande marqu√©e comme livr√©e.");
            // Ajouter une coche verte √† c√¥t√© de la commande livr√©e
            ajouterTickVert(currentCommandeId);
        },
        error: function(xhr, status, error) {
            console.error("Erreur lors de la mise √† jour de la livraison :", error);
        }
    });
}

// Fonction utilitaire pour ajouter un tick vert √† c√¥t√© de la commande livr√©e
function ajouterTickVert(commandeId) {
    const commandeItem = document.querySelector(`#commande-${commandeId}`);
    if (commandeItem) {
        commandeItem.innerHTML = `<span class="text-success">&#10004;</span> ` + commandeItem.innerHTML;
    }
}


const tourneeNom = "{{ tournee.nom }}";  // Utiliser le nom de la tourn√©e

function marquerRetour(tourneeNom) {
    // 1. Requ√™te pour mettre √† jour l'heure de retour r√©elle
    $.ajax({
        url: `/api/update-heure-retour-reel/${tourneeNom}/`,
        type: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        success: function(response) {
            console.log("R√©ponse API retour :", response);
            if (response && response.success) {
                // 2. Si succ√®s, deuxi√®me requ√™te pour marquer la tourn√©e comme termin√©e
                $.ajax({
                    url: `/api/marquer-retour/${tourneeNom}/`,
                    type: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                    success: function(markResponse) {
                        if (markResponse && markResponse.status === 'success') {
                            alert(markResponse.message || "Tourn√©e marqu√©e comme termin√©e.");
                            // Supprime dynamiquement l'√©l√©ment de la tourn√©e de l'affichage
                            const tourneeElement = document.getElementById(`heading-${tourneeNom}`);
                            if (tourneeElement) {
                                tourneeElement.closest('.accordion-item').remove();
                            }
                            // Affiche un message si aucune tourn√©e restante
                            const remainingTournees = document.querySelectorAll('.accordion-item').length;
                            if (remainingTournees === 0) {
                                const message = document.createElement('p');
                                message.textContent = "Toutes les tourn√©es sont termin√©es.";
                                document.getElementById('tourneesAccordion').appendChild(message);
                            }
                        } else {
                            const msg = (markResponse && markResponse.message) ? markResponse.message : "Erreur inconnue lors du marquage de la tourn√©e.";
                            console.error("Erreur : " + msg);
                            alert("Erreur : " + msg);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error(`Erreur lors du marquage de la tourn√©e ${tourneeNom} comme termin√©e :`, error);
                        alert("Erreur lors du marquage de la tourn√©e comme termin√©e.");
                    }
                });
            } else {
    const msg = (response && (response.message || response.error))
        ? (response.message || response.error)
        : "Erreur inconnue lors de l'enregistrement du retour.";
    console.error("Erreur : " + msg);
    alert("Erreur : " + msg);
}

        },
        error: function(xhr, status, error) {
            console.error(`Erreur lors de la mise √† jour de l'heure de retour pour la tourn√©e ${tourneeNom} :`, error);
            alert("Erreur lors de l'enregistrement de l'heure de retour.");
        }
    });
}





function afficherMessageLivreur(message) {
    // Afficher le message dans une alerte ou une modal
    alert(`Message pour le livreur:\n\n${message}`);
}



// Fonction pour g√©n√©rer le QR code
function afficherQRCode(tourneeNom, dataQR) {
    const qrcodeDiv = document.getElementById(`qrcode-${tourneeNom}`);
    if (!qrcodeDiv) return;

    // Vide le contenu pr√©c√©dent
    qrcodeDiv.innerHTML = "";

    // G√©n√®re le QR code
    new QRCode(qrcodeDiv, {
        text: dataQR,
        width: 128,
        height: 128
    });
}

// Modifie la fonction demarrerTournee pour g√©n√©rer le QR code et le persister
function demarrerTournee(tourneeNom) {
    const tourneeElement = document.querySelector(`#tournee-${tourneeNom}`);
    heureDepart = new Date(new Date().getTime() + 3 * 60 * 1000); // +3min
    const heureDepartLocal = toLocalIsoString(heureDepart);

    const demarrerButton = document.getElementById(`demarrerTourneeButton-${tourneeNom}`);
    if (demarrerButton) {
        demarrerButton.disabled = true;
    }

    $.ajax({
        url: '/api/demarrer-tournee/',
        type: 'POST',
        data: { 
            heure_depart: heureDepartLocal,
            tournee_nom: tourneeNom
        },
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    })
    .done(function(response) {
        // ... (ton code existant de badge, disable bouton, etc.)

        // 1. G√©n√®re le QR code (ici, on encode le nom de la tourn√©e mais tu peux encoder ce que tu veux)
        afficherQRCode(tourneeNom, `http://127.0.0.1:8000/tournees-livreurs/${tourneeNom}`);

        // 2. Persiste dans le localStorage
        localStorage.setItem(`qrcode_shown_${tourneeNom}`, "1");

        // ... (ton code existant de mise √† jour DOM, calcul, etc.)
        const heureDepartElem = tourneeElement.querySelector('.heure-depart');
        if (heureDepartElem) {
            heureDepartElem.setAttribute('data-heure-depart', heureDepartLocal);
            heureDepartElem.textContent = "Heure de d√©part : " + heureDepartLocal.slice(11, 19); // format HH:MM:SS
        }
        calculerTempsDeTrajet(tourneeNom, heureDepart);
    })
    .fail(function(xhr, status, error) {
        if (demarrerButton) {
            demarrerButton.disabled = false;
        }
    });
}

// Au chargement, on r√©-affiche le QR code pour les tourn√©es o√π il doit l'√™tre
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll("[id^='qrcode-']").forEach(function(div) {
        const tourneeNom = div.id.replace("qrcode-", "");
        if (localStorage.getItem(`qrcode_shown_${tourneeNom}`) === "1") {
            // G√©n√®re le QR code (adapter ici le contenu √† encoder si besoin)
            afficherQRCode(tourneeNom, `http://127.0.0.1:8000/tournees-livreurs/${tourneeNom}`);
        }
    });
});

</script>


{% endblock %}
